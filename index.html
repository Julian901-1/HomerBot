<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>HomerBot</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { padding: 16px; max-width: 640px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .balance {
      display: flex; align-items: baseline; gap: 8px;
      font-variant-numeric: tabular-nums;
    }
    .balance .value { font-size: 32px; font-weight: 700; }
    .row { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .btn {
      padding: 10px 16px; border: 0; border-radius: 10px; cursor: pointer;
      font-weight: 600; font-size: 16px;
    }
    .btn-primary { background: #4c8bf5; color: #fff; }
    .btn-secondary { background: #e0e0e0; color: #111; }
    .btn:disabled { opacity: 0.6; cursor: default; }
    .status { margin-top: 10px; opacity: 0.8; font-size: 13px; }
    .rate { margin-top: 12px; display: flex; gap: 6px; align-items: center; }
    .popup {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      background: rgba(20,20,20,.9); color: #fff; padding: 12px 16px; border-radius: 10px;
      font-size: 14px; z-index: 9999; max-width: 90vw; text-align: center;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>HomerBot</h1>

    <div class="balance">
      <span>Баланс:</span>
      <span id="balanceValue" class="value">—</span>
      <span id="currency">ед.</span>
    </div>

    <div class="row">
      <button id="addButton" class="btn btn-primary" onclick="sendAdminRequest()">+1</button>
      <button id="withdrawButton" class="btn btn-secondary" onclick="sendWithdrawRequest()">–1</button>
    </div>

    <div class="rate">
      <span>Ставка:</span>
      <strong id="rateText">—%</strong>
    </div>

    <div id="status" class="status">Инициализация…</div>
  </div>

  <script>
    // === Конфиг ===
    const SCRIPT_URL = (window.scriptUrl
      || (window.SCRIPT_URL ?? 'https://script.google.com/macros/s/AKfycbzIAGI3xqdLJeOGHs8cgvLbMll5x82pc7clF_HTmQBQkc-5jbONBaq27NPZuaQAfuR_oA/exec'));

    // === Глобальные переменные состояния ===
    window.username = null;
    window.isInitialized = false;

    // Баланс на клиенте — теперь это просто "зеркало" сервера
    window.localBalance = 0;
    window.currentRate = 16;

    // Флажок ожидания решения админа
    window.pendingRequest = false;

    // === Утилиты ===
    function showPopup(text, timeout = 2500) {
      const el = document.createElement('div');
      el.className = 'popup';
      el.textContent = text;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.transition = 'opacity .25s ease';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 250);
      }, timeout);
    }

    function updateDisplay() {
      document.getElementById('balanceValue').textContent = (Number(window.localBalance) || 0).toFixed(2);
      document.getElementById('rateText').textContent = `${window.currentRate}%`;
    }

    function getTelegramUser() {
      try {
        const tg = window.Telegram?.WebApp;
        tg?.expand?.();
        const initDataUnsafe = tg?.initDataUnsafe || {};
        const user = initDataUnsafe.user || null;
        if (user && user.username) return user.username;
        // fallback (если тестируем в браузере)
        return 'marulin';
      } catch (e) {
        console.warn('Telegram user resolve error:', e);
        return 'marulin';
      }
    }

    // === Инициализация ===
    async function initializeUser() {
      try {
        window.username = getTelegramUser();
        window.isInitialized = true;

        console.log('User initialized:', window.username);

        // начальная загрузка с сервера
        await initialLoad();

        // периодическая синхронизация
        setInterval(syncBalance, 20000);
      } catch (e) {
        console.error('Initialization error:', e);
        document.getElementById('status').textContent = 'Ошибка инициализации';
      }
    }

    // Первичная загрузка
    async function initialLoad() {
      const url = `${SCRIPT_URL}?action=getBalance&username=${window.username}&debug=1`;
      console.log('Load URL:', url);

      const r = await fetch(url);
      const data = await r.json();

      console.log('Load response:', data);
      if (data.debug) console.debug('Load debug:', data.debug);

      if (data.success) {
        window.localBalance = Number(data.balance) || 0;
        window.currentRate = Number(data.rate) || 16;
        updateDisplay();
        document.getElementById('status').textContent = 'Готово';
      } else {
        document.getElementById('status').textContent =
          `Ошибка загрузки: ${data.error || 'неизвестная ошибка'}`;
      }
    }

    // === Запросы администратору ===

    // +1 (депозит)
    async function sendAdminRequest() {
      window.pendingRequest = true;

      const btn = document.getElementById('addButton');
      btn.textContent = 'Ожидание...';
      btn.disabled = true;

      try {
        const url = `${SCRIPT_URL}?action=requestAddOne&username=${window.username}`;
        console.log('Sending admin request URL:', url);

        const response = await fetch(url);
        const data = await response.json();
        console.log('Admin request response:', data);

        if (data.success) {
          const shortId = data.requestShortId || (data.requestId ? (String(data.requestId).split('-')[1] || '') : '');
          if (shortId) {
            showPopup(`Запрос на изменение баланса отправлен [#${shortId}]`);
          } else {
            showPopup('Запрос на изменение баланса отправлен');
          }
        } else {
          showPopup('Ошибка отправки запроса: ' + (data.error || 'неизвестная ошибка'));
          window.pendingRequest = false;
          btn.textContent = '+1';
          btn.disabled = false;
        }
      } catch (error) {
        console.error('Admin request error:', error);
        showPopup('Ошибка отправки запроса');
        window.pendingRequest = false;
        btn.textContent = '+1';
        btn.disabled = false;
      }
    }

    // –1 (вывод)
    async function sendWithdrawRequest() {
      window.pendingRequest = true;

      const btnMinus = document.getElementById('withdrawButton');
      btnMinus.textContent = 'Ожидание...';
      btnMinus.disabled = true;

      try {
        const url = `${SCRIPT_URL}?action=requestWithdrawOne&username=${window.username}`;
        console.log('Sending withdraw request URL:', url);

        const response = await fetch(url);
        const data = await response.json();
        console.log('Withdraw request response:', data);

        if (data.success) {
          const shortId = data.requestShortId || (data.requestId ? (String(data.requestId).split('-')[1] || '') : '');
          if (shortId) {
            showPopup(`Запрос на изменение баланса отправлен [#${shortId}]`);
          } else {
            showPopup('Запрос на изменение баланса отправлен');
          }
        } else {
          showPopup('Ошибка отправки запроса: ' + (data.error || 'неизвестная ошибка'));
          window.pendingRequest = false;
          btnMinus.textContent = '–1';
          btnMinus.disabled = false;
        }
      } catch (error) {
        console.error('Withdraw request error:', error);
        showPopup('Ошибка отправки запроса');
        window.pendingRequest = false;
        btnMinus.textContent = '–1';
        btnMinus.disabled = false;
      }
    }

    // === Периодическая синхронизация (без клиентских процентов!) ===
    async function syncBalance() {
      if (!window.username || !window.isInitialized) return;

      try {
        // Баланс на клиенте больше не «растёт» сам; мы шлём текущее зеркальное значение
        const url = `${SCRIPT_URL}?action=syncBalance&username=${window.username}`
          + `&balance=${encodeURIComponent(window.localBalance)}`
          + `&rate=${encodeURIComponent(window.currentRate)}`
          + `&timestamp=${Date.now()}`
          + `&debug=1`;

        console.log('Sync URL:', url);

        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);

        const data = await response.json();
        console.log('Sync response:', data);
        if (data.debug) console.debug('Sync debug:', data.debug);

        if (data.success) {
          // Сервер — источник истины
          if (typeof data.balance === 'number' && Number.isFinite(data.balance)) {
            window.localBalance = Number(data.balance);
          }
          if (typeof data.rate === 'number' && Number.isFinite(data.rate)) {
            window.currentRate = Number(data.rate);
          }
          updateDisplay();

          // Одноразовый ответ админа (с коротким ID)
          if (data.adminResponse && window.pendingRequest) {
            const resp = String(data.adminResponse).trim().toLowerCase();
            const shortId = data.adminResponseShortId
              || (data.adminResponseId ? (String(data.adminResponseId).split('-')[1] || '') : '');

            if (resp === 'approved') {
              showPopup(shortId
                ? `[#${shortId}] Администратор одобрил операцию изменения баланса`
                : 'Администратор одобрил операцию изменения баланса');
            } else if (resp === 'rejected') {
              showPopup(shortId
                ? `[#${shortId}] Администратор НЕ одобрил операцию изменения баланса`
                : 'Администратор НЕ одобрил операцию изменения баланса');
            }

            // Сбрасываем ожидание и ОТЖИМАЕМ обе кнопки
            window.pendingRequest = false;

            const addBtn = document.getElementById('addButton');
            if (addBtn) { addBtn.textContent = '+1'; addBtn.disabled = false; }

            const minusBtn = document.getElementById('withdrawButton');
            if (minusBtn) { minusBtn.textContent = '–1'; minusBtn.disabled = false; }
          }

          document.getElementById('status').textContent =
            `Синхронизировано: ${new Date().toLocaleTimeString()}`;
        } else {
          document.getElementById('status').textContent =
            `Ошибка синхронизации: ${data.error || 'неизвестная ошибка'}`;
        }
      } catch (error) {
        console.error('Sync error:', error);
        document.getElementById('status').textContent = `Ошибка подключения: ${error.message}`;
      }
    }

    // === Старт ===
    initializeUser();
  </script>
</body>
</html>
