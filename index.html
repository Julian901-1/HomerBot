<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Кошелёк</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--tg-theme-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
            padding: 0 16px;
        }

        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
            z-index: 1000;
        }

        /* Меню вкладок */
        .tabs-menu {
            display: flex;
            background: var(--tg-theme-bg-color, #fff);
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            margin: 0 -16px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 16px;
            font-size: 16px;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #999);
            position: relative;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--tg-theme-link-color, #0088cc);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--tg-theme-link-color, #0088cc);
        }

        /* Главная страница */
        .main-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .balance-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
        }

        .balance-label {
            font-size: 18px;
            opacity: 0.6;
            margin-bottom: 16px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .balance-currency {
            font-size: 20px;
            opacity: 0.6;
            margin-bottom: 40px;
        }

        .buttons-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-deposit {
            background: linear-gradient(135deg, #0088cc, #006bb3, #4da6d9);
            color: white;
        }

        .btn-withdraw {
            background: linear-gradient(135deg, #2196F3, #1976D2, #64B5F6);
            color: white;
        }

        .current-strategy {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 16px;
            margin: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .current-strategy:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .current-strategy-label {
            font-size: 14px;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .current-strategy-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-link-color, #0088cc);
        }

        .terms-link {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #999);
            text-align: center;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .terms-link a {
            color: var(--tg-theme-link-color, #0088cc);
            text-decoration: none;
        }

        /* Страницы депозита и вывода */
        .page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .page.active {
            display: flex;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            background: var(--tg-theme-bg-color, #fff);
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-link-color, #0088cc);
            margin-right: 16px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 500;
        }

        .content {
            flex: 1;
            padding: 24px 20px;
            overflow-y: auto;
        }

        .amount-selector {
            margin-bottom: 32px;
        }

        .amount-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000);
        }

        .amount-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .amount-btn {
            background: var(--tg-theme-secondary-bg-color, #f1f3f4);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 16px 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--tg-theme-text-color, #000);
        }

        .amount-btn.selected {
            border-color: var(--tg-theme-link-color, #0088cc);
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-link-color, #0088cc);
        }

        .custom-amount {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }

        .custom-amount:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #0088cc);
        }

        .payment-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .payment-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .payment-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .payment-label {
            opacity: 0.6;
        }

        .payment-value {
            font-weight: 500;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn {
            background: var(--tg-theme-link-color, #0088cc);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .instructions-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #856404;
        }

        .instructions-text {
            font-size: 14px;
            line-height: 1.4;
            color: #856404;
        }

        /* Страница "Как это работает" */
        .info-page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 60px);
            padding: 24px 20px;
        }

        .info-page.active {
            display: flex;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .info-text {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 30px;
            flex: 1;
        }

        .strategy-selector {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .strategy-selector.highlighted {
            position: relative;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 136, 204, 0.5);
        }

        .strategy-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .strategy-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strategy-option:hover {
            transform: translateX(4px);
        }

        .strategy-left {
            display: flex;
            align-items: center;
        }

        .strategy-bonus {
            font-size: 12px;
            color: var(--tg-theme-link-color, #0088cc);
            font-weight: 600;
        }

        .strategy-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }

        .strategy-radio.selected {
            border-color: var(--tg-theme-link-color, #0088cc);
        }

        .strategy-radio.selected::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--tg-theme-link-color, #0088cc);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .strategy-info {
            flex: 1;
        }

        .strategy-name {
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--tg-theme-text-color, #000);
        }

        .strategy-desc {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
        }

        .strategy-rate {
            font-size: 11px;
            color: var(--tg-theme-link-color, #0088cc);
            font-weight: 500;
            margin-top: 2px;
        }

        .highlight-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .highlight-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Pop-up уведомление */
        .popup-notification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            max-width: 90%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }

        .popup-notification.show {
            top: 20px;
            opacity: 1;
        }

        .popup-notification.error {
            background: #f44336;
        }

        .popup-notification.info {
            background: #2196F3;
        }

        /* Модальное окно */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #fff);
            padding: 24px;
            border-radius: 16px;
            margin: 20px;
            text-align: center;
            max-width: 300px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .modal-btn {
            background: var(--tg-theme-link-color, #0088cc);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .centered-btn {
            margin: 0 auto;
            width: fit-content;
            padding: 18px 32px;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            margin: 16px auto 0;
            padding: 14px 24px;
        }
    </style>
</head>
<body>
    
    <!-- Версия приложения -->
    <div class="version">28.0-stable</div>

    <!-- Pop-up уведомление -->
    <div id="popupNotification" class="popup-notification"></div>

    <div class="container">
        <!-- Меню вкладок -->
        <div class="tabs-menu">
            <button class="tab-btn active" onclick="showTab('main')">Кошелек</button>
            <button class="tab-btn" onclick="showTab('info')">Как работает</button>
        </div>

        <!-- Главная страница -->
        <div id="mainTab" class="main-page">
            <div class="balance-section">
                <div id="greeting" class="balance-label" style="margin-bottom: 24px; font-size: 16px;">Добро пожаловать!</div>
                <div class="balance-label">Баланс:</div>
                <div class="balance-amount" id="balanceAmount">0.00</div>
                <div class="balance-currency">✧</div>
            </div>
            
            <div class="buttons-section">
                <button class="btn btn-deposit" onclick="showDepositPage()">
                    Пополнить
                </button>
                <button class="btn btn-withdraw" onclick="showWithdrawPage()">
                    Вывести
                </button>
                
                <!-- Кнопка принудительной синхронизации -->
                <button class="btn centered-btn" onclick="forceBalanceSync()" style="background: #6c757d; margin-top: 10px;">
                    🔄 Обновить баланс
                </button>
                
                <!-- Диагностика синхронизации -->
                <button class="btn centered-btn" onclick="runSyncDiagnostics()" style="background: #17a2b8; margin-top: 5px;">
                    🔍 ДИАГНОСТИКА: Проверка синхронизации
                </button>
            </div>

            <div class="current-strategy" id="currentStrategy" onclick="showStrategyPage()">
                <div class="current-strategy-label">Ваша текущая стратегия:</div>
                <div class="current-strategy-name" id="currentStrategyName">Стандартная</div>
            </div>

            <div class="terms-link">
                Пользуясь приложением вы подтверждаете<br>
                <a href="https://docs.google.com/document/d/1LYWcZc49Lh84t-jEH8MDc5NvYfLBqQM7KvNG7Vybgrs/edit?usp=sharing" target="_blank">условия пользования</a>
            </div>
        </div>

        <!-- Страница "Как это работает" -->
        <div id="infoTab" class="info-page">
            <div class="highlight-overlay" id="highlightOverlay"></div>
            <div class="info-title">Как это работает:</div>
            <div class="info-text">
                <strong>Надёжная основа:</strong> Мы создали для вас максимально безопасное решение. Ваш депозит размещается в банках, застрахованных АСВ, а вы в режиме реального времени видите, как копится доход. Идеальный баланс надёжности и прибыли.
                
                <br><br><strong>Расширьте границы доходности:</strong> Готовы на большее? Подключите опцию с повышенной ставкой. Мы диверсифицируем ваши вложения в высокодоходные инструменты, такие как ЦФЗ от лидеров рынка (Альфа-Банк / Озон-Банк), где каждая возможность тщательно отобрана для оптимального соотношения риска и доходности.
            </div>

            <div class="strategy-selector" id="strategySelector">
                <div class="strategy-title">Выберите стратегию:</div>
                
                <div class="strategy-option" onclick="selectStrategy('standard')">
                    <div class="strategy-left">
                        <div class="strategy-radio selected" id="standardRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">Стандартная</div>
                            <div class="strategy-desc">Банковские вклады под лучший %</div>
                            <div class="strategy-rate">Текущий курс: 16% годовых</div>
                        </div>
                    </div>
                </div>

                <div class="strategy-option balanced" onclick="selectStrategy('balanced')">
                    <div class="strategy-left">
                        <div class="strategy-radio" id="balancedRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">Сбалансированная</div>
                            <div class="strategy-desc">50% Банковские вклады, 50% ЦФЗ/Займы</div>
                            <div class="strategy-rate">Текущий курс: 17,5% годовых</div>
                        </div>
                    </div>
                    <div class="strategy-bonus">+1,5%</div>
                </div>

                <div class="strategy-option" onclick="selectStrategy('aggressive')">
                    <div class="strategy-left">
                        <div class="strategy-radio" id="aggressiveRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">Агрессивная</div>
                            <div class="strategy-desc">Займы, ЦФЗ, Акции</div>
                            <div class="strategy-rate">Текущий курс: 18,5% годовых</div>
                        </div>
                    </div>
                    <div class="strategy-bonus">+2,5%</div>
                </div>
            </div>
        </div>

        <!-- Страница пополнения -->
        <div id="depositPage" class="page">
            <div class="header">
                <button class="back-btn" onclick="showMainPage()">‹</button>
                <div class="header-title">Пополнение</div>
            </div>
            
            <div class="content">
                <div class="amount-selector">
                    <div class="amount-title">Выберите сумму</div>
                    <div class="amount-grid">
                        <button class="amount-btn" onclick="selectAmount(500)">500 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(1000)">1 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(2000)">2 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(5000)">5 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(10000)">10 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(25000)">25 000 ✧</button>
                    </div>
                    <input type="text" class="custom-amount" id="customAmount" placeholder="Или введите свою сумму (макс. 100млн)" maxlength="20">
                </div>

                <div class="payment-info" id="paymentInfo" style="display: none;">
                    <div class="payment-title">Реквизиты для перевода</div>
                    <div class="payment-details">
                        <div class="payment-row">
                            <span class="payment-label">Номер телефона:</span>
                            <div class="payment-value">
                                +7 (916) 643-54-94
                                <button class="copy-btn" onclick="copyToClipboard('+79166435494')">📋</button>
                            </div>
                        </div>
                        <div class="payment-row">
                            <span class="payment-label">Сумма:</span>
                            <span class="payment-value" id="paymentAmount">0 ✧</span>
                        </div>
                        <div class="payment-row">
                            <span class="payment-label">Комментарий:</span>
                            <div class="payment-value">
                                <span id="paymentComment">DEP123456</span>
                                <button class="copy-btn" onclick="copyToClipboard(getCommentText())">📋</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="instructions" id="paymentInstructions" style="display: none;">
                    <div class="instructions-title">Как пополнить:</div>
                    <div class="instructions-text">
                        1. Откройте банковское приложение<br>
                        2. Выберите "Перевод по номеру телефона" или "СБП"<br>
                        3. Введите номер телефона и сумму<br>
                        4. Обязательно укажите комментарий для автоматического зачисления<br>
                        5. Средства поступят на баланс в течение 5 минут
                    </div>
                </div>

                <div id="paymentTimer" style="display: none; text-align: center; margin-top: 16px; font-size: 14px; color: #ff6b6b;">
                    Время на оплату: <span id="timerDisplay">5:00</span>
                </div>

                <button class="btn centered-btn" id="generatePaymentBtn" onclick="generatePayment()">
                    Пополнить баланс
                </button>

                <button class="btn centered-btn cancel-btn" id="cancelPaymentBtn" onclick="cancelPayment()" style="display: none;">
                    Отмена пополнения
                </button>
            </div>
        </div>

        <!-- Страница вывода -->
        <div id="withdrawPage" class="page">
            <div class="header">
                <button class="back-btn" onclick="showMainPage()">‹</button>
                <div class="header-title">Вывод средств</div>
            </div>
            
            <div class="content">
                <div class="amount-selector">
                    <div class="amount-title">Сумма вывода</div>
                    <input type="text" class="custom-amount" id="withdrawAmount" placeholder="Введите сумму" maxlength="20">
                </div>

                <div class="amount-selector">
                    <div class="amount-title">Номер телефона для перевода</div>
                    <input type="tel" class="custom-amount" id="withdrawPhone" placeholder="+7 (999) 123-45-67" maxlength="18">
                </div>

                <div class="instructions">
                    <div class="instructions-title">Условия вывода:</div>
                    <div class="instructions-text">
                        • Минимальная сумма: 100 ✧<br>
                        • Время обработки: до 48 часов<br>
                        • Комиссия: 0,5%
                    </div>
                </div>

                <button class="btn btn-withdraw centered-btn" onclick="processWithdraw()">
                    Создать заявку на вывод
                </button>
            </div>
        </div>

        <!-- Модальное окно -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-title">Новая стратегия будет применена в течение суток</div>
                <button class="modal-btn" onclick="hideModal()">Понятно</button>
            </div>
        </div>
    </div>

<script>
// Инициализация Telegram WebApp
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    console.log('Telegram WebApp initialized');
} else {
    console.log('Not in Telegram environment - using test data');
}

// === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
var currentBalance = 0;
var selectedAmount = 0;
var currentStrategy = 'standard';
var tg = null;
var paymentTimer = null;
var currentTransactionId = null;
var currentPaymentAmount = 0;
var interestTimer = null;
var lastUpdateTime = null;
var currentTelegramMessageId = null;

// Константы для Telegram бота
var BOT_TOKEN = '7631840452:AAH4O93qQ6J914x5FhPTQX7YhJC3bTiJ_XA';
var CHAT_ID = '487525838';

// URL Google Apps Script
var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_tTk4wa8xwNP3JlwFoZRAV9XyCGxEZR9t5WeYEoSsylCktVblQlD30i_fcsosnV9i-g/exec';

// Настройки процентных ставок
var INTEREST_RATES = {
    standard: 16.0,
    balanced: 17.5,
    aggressive: 18.5
};

// === УЛУЧШЕННАЯ СИСТЕМА СИНХРОНИЗАЦИИ ===
var SYNC_CONFIG = {
    maxRetries: 3,
    timeoutMs: 10000,
    retryDelayMs: 2000,
    syncIntervalMs: 120000,
    forceUpdateThreshold: 0.01
};

var syncState = {
    isActive: false,
    lastSyncTime: 0,
    consecutiveFailures: 0,
    currentMethod: 'jsonp'
};

// === ОСНОВНЫЕ ФУНКЦИИ НАВИГАЦИИ ===
function showTab(tabName) {
    console.log('showTab called with:', tabName);
    try {
        var tabBtns = document.querySelectorAll('.tab-btn');
        for (var i = 0; i < tabBtns.length; i++) {
            tabBtns[i].classList.remove('active');
        }
        
        document.getElementById('mainTab').style.display = 'none';
        document.getElementById('infoTab').classList.remove('active');
        
        if (tabName === 'main') {
            document.getElementById('mainTab').style.display = 'flex';
            if (tabBtns[0]) tabBtns[0].classList.add('active');
        } else if (tabName === 'info') {
            document.getElementById('infoTab').classList.add('active');
            if (tabBtns[1]) tabBtns[1].classList.add('active');
        }
        
        hideAllPages();
    } catch (e) {
        console.error('Error in showTab:', e);
    }
}

function showDepositPage() {
    console.log('showDepositPage called');
    try {
        document.getElementById('mainTab').style.display = 'none';
        document.getElementById('infoTab').classList.remove('active');
        hideAllPages();
        document.getElementById('depositPage').classList.add('active');
    } catch (e) {
        console.error('Error in showDepositPage:', e);
    }
}

function showWithdrawPage() {
    console.log('showWithdrawPage called');
    try {
        document.getElementById('mainTab').style.display = 'none';
        document.getElementById('infoTab').classList.remove('active');
        hideAllPages();
        document.getElementById('withdrawPage').classList.add('active');
    } catch (e) {
        console.error('Error in showWithdrawPage:', e);
    }
}

function showMainPage() {
    console.log('showMainPage called');
    try {
        hideAllPages();
        showTab('main');
    } catch (e) {
        console.error('Error in showMainPage:', e);
    }
}

function showStrategyPage() {
    showTab('info');
    
    setTimeout(function() {
        var overlay = document.getElementById('highlightOverlay');
        var strategySelector = document.getElementById('strategySelector');
        
        if (overlay && strategySelector) {
            overlay.classList.add('active');
            strategySelector.classList.add('highlighted');
            
            setTimeout(function() {
                overlay.classList.remove('active');
                strategySelector.classList.remove('highlighted');
            }, 3000);
        }
    }, 300);
}

function hideAllPages() {
    try {
        var pages = document.querySelectorAll('.page');
        for (var i = 0; i < pages.length; i++) {
            pages[i].classList.remove('active');
        }
    } catch (e) {
        console.error('Error in hideAllPages:', e);
    }
}

// === ФУНКЦИИ УВЕДОМЛЕНИЙ ===
function showNotification(message, type, duration) {
    try {
        var notification = document.getElementById('popupNotification');
        if (!notification) return;
        
        notification.className = 'popup-notification';
        notification.textContent = message;
        
        if (type === 'error') {
            notification.classList.add('error');
        } else if (type === 'info') {
            notification.classList.add('info');
        }
        
        requestAnimationFrame(function() {
            notification.classList.add('show');
        });
        
        var hideDelay = duration || 3000;
        setTimeout(function() {
            notification.classList.remove('show');
            
            setTimeout(function() {
                notification.className = 'popup-notification';
                notification.textContent = '';
            }, 300);
        }, hideDelay);
        
    } catch (e) {
        console.error('Error in showNotification:', e);
    }
}

// === ФУНКЦИИ РАБОТЫ С СУММАМИ И ПЛАТЕЖАМИ ===
function selectAmount(amount) {
    console.log('selectAmount called with:', amount);
    try {
        selectedAmount = amount;
        var btns = document.querySelectorAll('.amount-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('selected');
            if (btns[i].textContent.includes(amount.toString())) {
                btns[i].classList.add('selected');
            }
        }
        
        var customInput = document.getElementById('customAmount');
        if (customInput) {
            customInput.value = formatNumber(amount.toString());
        }
    } catch (e) {
        console.error('Error in selectAmount:', e);
    }
}

function generatePayment() {
    console.log('generatePayment called');
    try {
        var customInput = document.getElementById('customAmount');
        var inputValue = customInput ? customInput.value.replace(/\s/g, '') : '';
        var amount = selectedAmount || parseFloat(inputValue) || 0;
        
        if (!amount || amount < 100 || amount > 100000000) {
            showNotification('Введите корректную сумму от 100 до 100 000 000 ✧', 'error');
            return;
        }

        var transactionId = 'DEP' + Date.now().toString().slice(-6);
        currentTransactionId = transactionId;
        currentPaymentAmount = amount;
        
        var paymentAmount = document.getElementById('paymentAmount');
        var paymentComment = document.getElementById('paymentComment');
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');
        var cancelBtn = document.getElementById('cancelPaymentBtn');
        var timerDiv = document.getElementById('paymentTimer');
        
        if (paymentAmount) paymentAmount.textContent = formatNumber(amount.toString()) + ' ✧';
        if (paymentComment) paymentComment.textContent = transactionId;
        if (paymentInfo) paymentInfo.style.display = 'block';
        if (paymentInstructions) paymentInstructions.style.display = 'block';
        if (generateBtn) generateBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'block';
        if (timerDiv) timerDiv.style.display = 'block';

        showNotification('✅ Заявка на пополнение создана! После поступления средств баланс будет обновлён автоматически.');
        
        startPaymentTimer();
        sendTelegramNotification(amount, transactionId);
        
        var paymentCheckInterval = setInterval(function() {
            checkPaymentConfirmation();
        }, 5000);
        
        window.currentPaymentCheckInterval = paymentCheckInterval;
        
    } catch (e) {
        console.error('Error in generatePayment:', e);
    }
}

function cancelPayment() {
    try {
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');
        var cancelBtn = document.getElementById('cancelPaymentBtn');
        var timerDiv = document.getElementById('paymentTimer');
        var customInput = document.getElementById('customAmount');
        
        if (paymentInfo) paymentInfo.style.display = 'none';
        if (paymentInstructions) paymentInstructions.style.display = 'none';
        if (generateBtn) generateBtn.style.display = 'block';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (timerDiv) timerDiv.style.display = 'none';
        if (customInput) customInput.value = '';
        
        var btns = document.querySelectorAll('.amount-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('selected');
        }
        
        if (window.currentPaymentCheckInterval) {
            clearInterval(window.currentPaymentCheckInterval);
            window.currentPaymentCheckInterval = null;
        }
        
        if (currentTransactionId) {
            var cancelUrl = SCRIPT_URL + '?action=cancelPayment&' + 
                           'transactionId=' + encodeURIComponent(currentTransactionId) + 
                           '&messageId=' + encodeURIComponent(currentTelegramMessageId || '') + 
                           '&timestamp=' + Date.now();
            
            fetch(cancelUrl, { method: 'GET' })
            .then(function(response) {
                console.log('Cancel notification sent, status:', response.status);
            })
            .catch(function(error) {
                console.error('Error sending cancel notification:', error);
            });
        }
        
        selectedAmount = 0;
        clearPaymentTimer();
        currentTransactionId = null;
        currentPaymentAmount = 0;
        currentTelegramMessageId = null;
        
        console.log('✅ Платеж отменен локально');
        
    } catch (e) {
        console.error('Error in cancelPayment:', e);
    }
}

function processWithdraw() {
    console.log('processWithdraw called');
    try {
        var withdrawAmountInput = document.getElementById('withdrawAmount');
        var withdrawPhoneInput = document.getElementById('withdrawPhone');
        
        var amountStr = withdrawAmountInput ? withdrawAmountInput.value.replace(/\s/g, '') : '';
        var amount = parseFloat(amountStr) || 0;
        var phone = withdrawPhoneInput ? withdrawPhoneInput.value.replace(/\D/g, '') : '';
        
        if (!phone || phone.length !== 11 || !phone.startsWith('7')) {
            showNotification('Номер должен начинаться с +7 и содержать 11 цифр', 'error');
            return;
        }
        
        if (!amount || amount < 100) {
            showNotification('Минимальная сумма вывода: 100 ✧', 'error');
            return;
        }
        
        var commission = amount * 0.005;
        var totalToDeduct = amount + commission;
        var finalAmount = amount - commission;
        
        if (totalToDeduct > currentBalance) {
            showNotification('Недостаточно средств (с учётом комиссии 0,5%)', 'error');
            return;
        }

        currentBalance -= totalToDeduct;
        localStorage.setItem('wallet_balance', currentBalance.toString());
        updateBalanceDisplay();
        
        sendWithdrawNotification(amount, phone, commission, finalAmount);
        
        showNotification('✅ Заявка на вывод ' + formatNumber(finalAmount.toFixed(2)) + ' ✧ создана!');
        
        if (withdrawAmountInput) withdrawAmountInput.value = '';
        if (withdrawPhoneInput) withdrawPhoneInput.value = '';
        
    } catch (e) {
        console.error('Error in processWithdraw:', e);
    }
}

function selectStrategy(strategy) {
    console.log('selectStrategy called with:', strategy);
    try {
        if (currentStrategy !== strategy) {
            currentStrategy = strategy;
            
            var standardRadio = document.getElementById('standardRadio');
            var balancedRadio = document.getElementById('balancedRadio');
            var aggressiveRadio = document.getElementById('aggressiveRadio');
            
            if (standardRadio) standardRadio.classList.remove('selected');
            if (balancedRadio) balancedRadio.classList.remove('selected');
            if (aggressiveRadio) aggressiveRadio.classList.remove('selected');
            
            if (strategy === 'standard' && standardRadio) {
                standardRadio.classList.add('selected');
            } else if (strategy === 'balanced' && balancedRadio) {
                balancedRadio.classList.add('selected');
            } else if (aggressiveRadio) {
                aggressiveRadio.classList.add('selected');
            }
            
            showModal();
            localStorage.setItem('investment_strategy', strategy);
            updateCurrentStrategyDisplay();
            
            sendStrategyChangeNotification(strategy);
            syncBalanceToServer();
        }
    } catch (e) {
        console.error('Error in selectStrategy:', e);
    }
}

function showModal() {
    try {
        var modal = document.getElementById('modal');
        if (modal) modal.classList.add('active');
    } catch (e) {
        console.error('Error in showModal:', e);
    }
}

function hideModal() {
    try {
        var modal = document.getElementById('modal');
        if (modal) modal.classList.remove('active');
    } catch (e) {
        console.error('Error in hideModal:', e);
    }
}

// === ФУНКЦИИ КОПИРОВАНИЯ ===
function copyToClipboard(text) {
    try {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                showNotification('Скопировано!');
            });
        } else {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Скопировано!');
        }
    } catch (e) {
        console.error('Error in copyToClipboard:', e);
    }
}

function getCommentText() {
    var commentEl = document.getElementById('paymentComment');
    return commentEl ? commentEl.textContent : '';
}

// === ФУНКЦИИ ФОРМАТИРОВАНИЯ ===
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function formatPhoneNumber(value) {
    var numbers = value.replace(/\D/g, '');
    if (numbers.length === 0) return '';
    
    if (numbers.length <= 1) {
        return '+' + numbers;
    } else if (numbers.length <= 4) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1);
    } else if (numbers.length <= 7) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4);
    } else if (numbers.length <= 9) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4, 7) + '-' + numbers.slice(7);
    } else {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4, 7) + '-' + numbers.slice(7, 9) + '-' + numbers.slice(9, 11);
    }
}

function updateCurrentStrategyDisplay() {
    var strategyNames = {
        standard: 'Стандартная',
        balanced: 'Сбалансированная',
        aggressive: 'Агрессивная'
    };
    
    var currentStrategyName = document.getElementById('currentStrategyName');
    if (currentStrategyName) {
        currentStrategyName.textContent = strategyNames[currentStrategy] || 'Стандартная';
    }
}

function updateGreeting() {
    try {
        var greeting = document.getElementById('greeting');
        if (!greeting) return;
        
        var now = new Date();
        var moscowTime = new Date(now.getTime() + (3 * 60 * 60 * 1000));
        var hour = moscowTime.getHours();
        
        var timeGreeting = hour >= 17 ? 'Добрый вечер' : 'Добрый день';
        var userName = 'Пользователь';
        
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userName = tg.initDataUnsafe.user.first_name || tg.initDataUnsafe.user.username || 'Пользователь';
        }
        
        greeting.textContent = timeGreeting + ', ' + userName + '!';
    } catch (e) {
        console.error('Error updating greeting:', e);
        var greeting = document.getElementById('greeting');
        if (greeting) {
            greeting.textContent = 'Добро пожаловать, Пользователь!';
        }
    }
}

// === ФУНКЦИИ НАЧИСЛЕНИЯ ПРОЦЕНТОВ ===
function startInterestAccrual() {
    if (interestTimer) {
        clearInterval(interestTimer);
    }
    
    lastUpdateTime = Date.now();
    console.log('Starting interest accrual for balance:', currentBalance);
    
    interestTimer = setInterval(function() {
        if (currentBalance > 0) {
            var currentTime = Date.now();
            var timeDiff = (currentTime - lastUpdateTime) / 1000;
            
            var currentRate = INTEREST_RATES[currentStrategy] || INTEREST_RATES.standard;
            var yearlyRate = currentRate / 100;
            var secondlyRate = yearlyRate / (365 * 24 * 60 * 60);
            
            var interest = currentBalance * secondlyRate * timeDiff;
            currentBalance += interest;
            
            localStorage.setItem('wallet_balance', currentBalance.toString());
            localStorage.setItem('last_update_time', currentTime.toString());
            
            updateBalanceDisplay();
            lastUpdateTime = currentTime;
        }
    }, 1000);
}

function stopInterestAccrual() {
    if (interestTimer) {
        clearInterval(interestTimer);
        interestTimer = null;
    }
}

function updateBalanceDisplay() {
    var balanceElement = document.getElementById('balanceAmount');
    if (balanceElement && currentBalance > 0) {
        balanceElement.textContent = currentBalance.toLocaleString('ru-RU', {
            minimumFractionDigits: 8,
            maximumFractionDigits: 8
        });
    } else if (balanceElement) {
        balanceElement.textContent = '0.00';
    }
}

function calculateMissedInterest() {
    try {
        var savedTime = localStorage.getItem('last_update_time');
        if (savedTime && currentBalance > 0) {
            var lastTime = parseInt(savedTime);
            var currentTime = Date.now();
            var timeDiff = (currentTime - lastTime) / 1000;
            
            if (timeDiff > 0) {
                var currentRate = INTEREST_RATES[currentStrategy] || INTEREST_RATES.standard;
                var yearlyRate = currentRate / 100;
                var secondlyRate = yearlyRate / (365 * 24 * 60 * 60);
                
                var missedInterest = currentBalance * secondlyRate * timeDiff;
                currentBalance += missedInterest;
                
                var hours = Math.floor(timeDiff / 3600);
                var minutes = Math.floor((timeDiff % 3600) / 60);
                console.log('Added missed interest:', missedInterest, 'for', hours, 'hours and', minutes, 'minutes');
            }
        }
    } catch (e) {
        console.error('Error calculating missed interest:', e);
    }
}

// === УЛУЧШЕННАЯ СИСТЕМА СИНХРОНИЗАЦИИ ===
function performReliableSync() {
    if (syncState.isActive) {
        console.log('🔄 Sync already in progress, skipping');
        return Promise.resolve({ success: false, message: 'Sync in progress' });
    }

    syncState.isActive = true;
    console.log('🚀 Starting reliable sync process...');

    return executeWithRetry(attemptJsonpSync, SYNC_CONFIG.maxRetries)
        .then(function(result) {
            if (result.success) {
                syncState.consecutiveFailures = 0;
                syncState.currentMethod = 'jsonp';
                return result;
            }
            throw new Error('JSONP sync failed after all retries');
        })
        .catch(function(jsonpError) {
            console.log('⚠️ JSONP failed, trying image pixel method:', jsonpError.message);
            return attemptImagePixelSync();
        })
        .catch(function(allError) {
            console.log('❌ All sync methods failed:', allError.message);
            syncState.consecutiveFailures++;
            return { success: false, error: allError.message };
        })
        .finally(function() {
            syncState.isActive = false;
            syncState.lastSyncTime = Date.now();
        });
}

function attemptJsonpSync() {
    return new Promise(function(resolve, reject) {
        var username = getUserName();
        var callbackName = 'sync_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
        var timeoutId, script;
        var completed = false;

        function cleanup() {
            if (completed) return;
            completed = true;
            
            clearTimeout(timeoutId);
            
            if (window[callbackName]) {
                delete window[callbackName];
            }
            
            if (script && script.parentNode) {
                script.parentNode.removeChild(script);
            }
        }

        function complete(success, data) {
            cleanup();
            if (success) {
                resolve(data);
            } else {
                reject(new Error(data || 'JSONP request failed'));
            }
        }

        timeoutId = setTimeout(function() {
            console.log('⏰ JSONP timeout after', SYNC_CONFIG.timeoutMs, 'ms');
            complete(false, 'JSONP timeout');
        }, SYNC_CONFIG.timeoutMs);

        window[callbackName] = function(data) {
            console.log('✅ JSONP success! Received:', data);
            
            try {
                var processResult = processServerData(data);
                complete(true, { success: true, data: data, processed: processResult });
            } catch (error) {
                console.error('❌ Error processing JSONP data:', error);
                complete(false, 'Error processing data: ' + error.message);
            }
        };

        script = document.createElement('script');
        script.id = callbackName;
        script.type = 'text/javascript';
        
        script.onerror = function(error) {
            console.log('❌ JSONP script failed to load:', error);
            complete(false, 'Script load error');
        };

        var url = SCRIPT_URL + 
                  '?action=getBalance' +
                  '&username=' + encodeURIComponent(username) +
                  '&currentBalance=' + encodeURIComponent(currentBalance) +
                  '&strategy=' + encodeURIComponent(currentStrategy) +
                  '&callback=' + callbackName +
                  '&t=' + Date.now();

        console.log('🌐 JSONP request URL:', url.substring(0, 150) + '...');
        script.src = url;
        document.head.appendChild(script);
    });
}

function attemptImagePixelSync() {
    return new Promise(function(resolve, reject) {
        console.log('🖼️ Attempting image pixel sync fallback...');
        
        var username = getUserName();
        var img = new Image();
        var completed = false;
        
        function cleanup() {
            if (completed) return;
            completed = true;
            img.onload = null;
            img.onerror = null;
        }
        
        var timeoutId = setTimeout(function() {
            cleanup();
            reject(new Error('Image pixel sync timeout'));
        }, SYNC_CONFIG.timeoutMs);
        
        img.onload = function() {
            cleanup();
            clearTimeout(timeoutId);
            console.log('✅ Image pixel sync completed (fire-and-forget)');
            resolve({ success: true, method: 'image_pixel', note: 'fire-and-forget' });
        };
        
        img.onerror = function() {
            cleanup();
            clearTimeout(timeoutId);
            console.log('❌ Image pixel sync failed');
            reject(new Error('Image pixel sync failed'));
        };
        
        var syncUrl = SCRIPT_URL + 
                      '?action=updateBalance' +
                      '&username=' + encodeURIComponent(username) +
                      '&balance=' + encodeURIComponent(currentBalance) +
                      '&strategy=' + encodeURIComponent(currentStrategy) +
                      '&method=image_pixel' +
                      '&t=' + Date.now();
        
        console.log('🖼️ Image pixel URL:', syncUrl.substring(0, 150) + '...');
        img.src = syncUrl;
    });
}

function processServerData(serverData) {
    var updated = false;
    
    try {
        if (serverData.balance !== undefined) {
            var serverBalance = parseFloat(serverData.balance) || 0;
            var localBalance = parseFloat(localStorage.getItem('wallet_balance') || '0');
            var balanceDiff = Math.abs(serverBalance - localBalance);
            
            if (balanceDiff > SYNC_CONFIG.forceUpdateThreshold) {
                console.log('💰 Updating balance from server:', localBalance, '->', serverBalance);
                
                stopInterestAccrual();
                
                currentBalance = serverBalance;
                localStorage.setItem('wallet_balance', currentBalance.toString());
                updateBalanceDisplay();
                
                if (currentBalance > 0) {
                    startInterestAccrual();
                }
                
                updated = true;
                
                if (balanceDiff > 1) {
                    showNotification('💰 Баланс обновлен: ' + formatNumber(serverBalance.toFixed(2)) + ' ⚡', 'info', 3000);
                }
            } else {
                console.log('✓ Balance already synchronized');
            }
        }
        
        if (serverData.strategy && serverData.strategy !== currentStrategy) {
            console.log('🎯 Updating strategy from server:', currentStrategy, '->', serverData.strategy);
            currentStrategy = serverData.strategy;
            localStorage.setItem('investment_strategy', currentStrategy);
            updateCurrentStrategyDisplay();
            loadStrategy();
            updated = true;
        }
        
        return {
            updated: updated,
            balance: serverData.balance,
            strategy: serverData.strategy,
            timestamp: new Date().toISOString()
        };
        
    } catch (error) {
        console.error('Error processing server data:', error);
        throw error;
    }
}

function executeWithRetry(asyncFn, maxRetries) {
    var attempt = 0;
    
    function tryExecute() {
        attempt++;
        console.log('🔄 Sync attempt', attempt, 'of', maxRetries);
        
        return asyncFn()
            .catch(function(error) {
                if (attempt >= maxRetries) {
                    console.log('❌ All', maxRetries, 'attempts failed');
                    throw error;
                }
                
                console.log('⏳ Retrying in', SYNC_CONFIG.retryDelayMs, 'ms...');
                return new Promise(function(resolve) {
                    setTimeout(resolve, SYNC_CONFIG.retryDelayMs);
                }).then(tryExecute);
            });
    }
    
    return tryExecute();
}

function syncBalanceToServer() {
    if (syncState.isActive) {
        console.log('🔒 Sync in progress, skipping balance upload');
        return Promise.resolve(false);
    }
    
    console.log('📤 Uploading balance to server...');
    
    var username = getUserName();
    var uploadUrl = SCRIPT_URL + '?action=updateBalance&' + 
                    'username=' + encodeURIComponent(username) +
                    '&strategy=' + encodeURIComponent(currentStrategy) +
                    '&balance=' + encodeURIComponent(currentBalance) +
                    '&source=client_sync' +
                    '&timestamp=' + Date.now();
    
    return new Promise(function(resolve) {
        var img = new Image();
        img.onload = function() {
            console.log('✅ Balance uploaded successfully');
            resolve(true);
        };
        img.onerror = function() {
            console.log('⚠️ Balance upload failed');
            resolve(false);
        };
        img.src = uploadUrl;
    });
}

function startImprovedSync() {
    console.log('🚀 Starting improved synchronization system...');
    
    if (window.syncInterval) {
        clearInterval(window.syncInterval);
    }
    
    setTimeout(function() {
        performReliableSync()
            .then(function(result) {
                if (result.success) {
                    console.log('✅ Initial sync completed successfully');
                } else {
                    console.log('⚠️ Initial sync had issues:', result.error);
                }
            });
    }, 5000);
    
    window.syncInterval = setInterval(function() {
        console.log('⏰ Scheduled sync starting...');
        performReliableSync()
            .then(function(result) {
                var status = result.success ? 'Success' : 'Failed';
                console.log('📊 Scheduled sync result:', status);
                
                if (syncState.consecutiveFailures > 3) {
                    console.log('⚠️ Too many failures, reducing sync frequency');
                    clearInterval(window.syncInterval);
                    window.syncInterval = setInterval(arguments.callee, SYNC_CONFIG.syncIntervalMs * 2);
                }
            });
    }, SYNC_CONFIG.syncIntervalMs);
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log('👀 Page became visible, syncing...');
            setTimeout(function() {
                performReliableSync();
            }, 1000);
        }
    });
    
    window.addEventListener('beforeunload', function() {
        syncBalanceToServer();
    });
}

// === ПРИНУДИТЕЛЬНАЯ СИНХРОНИЗАЦИЯ ===
function forceBalanceSync() {
    console.log('🔄 User requested force sync');
    showNotification('🔄 Выполняется принудительная синхронизация...', 'info');
    
    return performReliableSync()
        .then(function(result) {
            if (result.success) {
                showNotification('✅ Синхронизация завершена успешно!', 'success');
            } else {
                showNotification('⚠️ Синхронизация завершена с предупреждениями', 'info');
            }
            return result;
        })
        .catch(function(error) {
            console.error('❌ Force sync failed:', error);
            showNotification('❌ Ошибка синхронизации: ' + error.message, 'error');
            throw error;
        });
}

// === ДИАГНОСТИКА СИНХРОНИЗАЦИИ ===
function runSyncDiagnostics() {
    console.log('🔍 Running sync diagnostics...');
    showNotification('🔍 Запуск диагностики...', 'info');
    
    diagnoseSyncIssues()
        .then(function(serverReachable) {
            return performReliableSync();
        })
        .then(function(result) {
            const message = result.success ? 
                '✅ Диагностика пройдена. Синхронизация работает.' : 
                '⚠️ Обнаружены проблемы с синхронизацией.';
            
            showNotification(message, result.success ? 'success' : 'error');
            
            console.log('📊 Diagnostic Results:', {
                syncResult: result,
                currentBalance: currentBalance,
                currentStrategy: currentStrategy,
                syncState: syncState
            });
        })
        .catch(function(error) {
            showNotification('❌ Диагностика не удалась: ' + error.message, 'error');
            console.error('❌ Diagnostics failed:', error);
        });
}

function diagnoseSyncIssues() {
    console.log('🔍 SYNC DIAGNOSTICS:');
    console.log('- Current method:', syncState.currentMethod);
    console.log('- Is active:', syncState.isActive);
    console.log('- Last sync:', new Date(syncState.lastSyncTime).toLocaleString());
    console.log('- Consecutive failures:', syncState.consecutiveFailures);
    console.log('- Script URL:', SCRIPT_URL);
    console.log('- Current balance:', currentBalance);
    console.log('- Current strategy:', currentStrategy);
    console.log('- Username:', getUserName());
    
    var testUrl = SCRIPT_URL + '?action=test&t=' + Date.now();
    
    return fetch(testUrl, { 
        method: 'GET', 
        mode: 'no-cors',
        cache: 'no-cache'
    })
    .then(function() {
        console.log('✅ Server is reachable');
        return true;
    })
    .catch(function(error) {
        console.log('❌ Server unreachable:', error.message);
        return false;
    });
}

function getUserName() {
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        var user = tg.initDataUnsafe.user;
        return user.username ? '@' + user.username : 'user_' + user.id;
    }
    return '@test_user';
}

// === ФУНКЦИИ ПРОВЕРКИ ПЛАТЕЖЕЙ ===
function checkPaymentConfirmation() {
    if (!currentTransactionId || !currentPaymentAmount) return;
    
    console.log('Checking payment status for transaction:', currentTransactionId);
    
    fetch(SCRIPT_URL + '?action=checkPayment&transactionId=' + currentTransactionId)
    .then(function(response) {
        console.log('Payment check response status:', response.status);
        return response.json();
    })
    .then(function(result) {
        console.log('Payment check result:', result);
        
        if (result.confirmed) {
            if (result.newBalance !== undefined) {
                var serverBalance = result.newBalance;
                var currentLocalBalance = parseFloat(localStorage.getItem('wallet_balance') || '0');
                
                if (Math.abs(serverBalance - currentLocalBalance) > 0.01) {
                    console.log('Updating balance from server:', serverBalance, 'was:', currentLocalBalance);
                    currentBalance = serverBalance;
                    localStorage.setItem('wallet_balance', currentBalance.toString());
                    updateBalanceDisplay();
                    showNotification('✅ Платеж подтвержден! Баланс обновлен.', 'success');
                    
                    performReliableSync();
                } else {
                    console.log('Balance already up to date, no changes needed');
                }
            }
            
            cancelPayment();
        } else if (result.rejected) {
            showNotification('❌ Платеж отклонен администратором. Попробуйте еще раз.', 'error');
            cancelPayment();
        }
    })
    .catch(function(error) {
        console.error('Error checking payment:', error);
    });
}

// === УВЕДОМЛЕНИЯ TELEGRAM ===
function sendTelegramNotification(amount, transactionId) {
    var userId = getUserName();
    var message = '💰 Новая заявка на пополнение\n\nПользователь: ' + userId + '\nСумма: ' + formatNumber(amount.toString()) + ' ⚡\nКомментарий: ' + transactionId + '\n\nПодтверждаете перевод?';
    
    console.log('Sending deposit notification:', message);
    
    var getUrl = SCRIPT_URL + '?action=sendNotification&' + 
                 'type=deposit&' +
                 'userId=' + encodeURIComponent(userId) +
                 '&amount=' + encodeURIComponent(amount) +
                 '&transactionId=' + encodeURIComponent(transactionId) +
                 '&message=' + encodeURIComponent(message) +
                 '&timestamp=' + Date.now();
    
    console.log('🌐 Отправляем GET запрос:', getUrl.substring(0, 200) + '...');

    fetch(getUrl, {
        method: 'GET'
    }).then(function(response) {
        console.log('📋 Response status:', response.status);
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        return response.text();
    }).then(function(text) {
        console.log('📄 Raw response text:', text);
        
        try {
            var cleanText = text.trim();
            
            if (!cleanText.startsWith('{')) {
                throw new Error('Response is not JSON format');
            }
            
            const result = JSON.parse(cleanText);
            console.log('✅ Parsed JSON result:', result);
            
            if (result.success && result.messageId) {
                currentTelegramMessageId = result.messageId;
                console.log('✅ Уведомление отправлено через Google Apps Script, messageId:', result.messageId);
                showNotification('✅ Заявка создана! Ожидайте подтверждения.', 'success');
            } else if (result.success) {
                console.log('✅ Уведомление отправлено успешно (без messageId)');
                showNotification('✅ Заявка создана! Ожидайте подтверждения.', 'success');
            } else if (result.error) {
                console.error('❌ Server error:', result.error);
                showNotification('⚠️ Заявка создана, но возможны задержки с уведомлением', 'info');
            } else {
                console.log('⚠️ Неожиданный ответ от сервера');
                showNotification('⚠️ Заявка создана, статус неизвестен', 'info');
            }
        } catch (parseError) {
            console.error('❌ JSON parse error:', parseError);
            console.error('❌ Raw text was:', text);
            
            if (text.includes('success') || text.includes('true')) {
                console.log('✅ Ответ содержит признаки успеха, считаем операцию успешной');
                showNotification('✅ Заявка создана! Возможны задержки с уведомлением.', 'success');
            } else {
                throw new Error('Invalid server response');
            }
        }
    }).catch(function(error) {
        console.error('❌ Error sending deposit notification:', error);
        
        if (error.message.includes('Failed to fetch')) {
            showNotification('⚠️ Проблемы с сетью. Заявка может быть создана, проверьте позже.', 'info');
        } else if (error.message.includes('CORS')) {
            showNotification('⚠️ Заявка создана локально, уведомления могут задерживаться.', 'info');
        } else {
            showNotification('⚠️ Заявка создана, но возможны проблемы с уведомлениями.', 'info');
        }
        
        console.log('🔍 Заявка сохранена локально, администратор увидит изменения при синхронизации');
    });
}

function sendStrategyChangeNotification(strategy) {
    var strategyNames = {
        standard: 'Стандартная',
        balanced: 'Сбалансированная',
        aggressive: 'Агрессивная'
    };
    
    var userId = getUserName();
    var message = '🔄 Пользователь ' + userId + ' сменил стратегию на "' + strategyNames[strategy] + '"';
    
    console.log('Sending strategy notification:', message);
    
    var getUrl = SCRIPT_URL + '?action=sendNotification&' + 
                 'type=strategy_change&' +
                 'userId=' + encodeURIComponent(userId) +
                 '&strategy=' + encodeURIComponent(strategy) +
                 '&message=' + encodeURIComponent(message) +
                 '&timestamp=' + Date.now();
    
    console.log('Sending strategy notification via GET:', getUrl);

    fetch(getUrl, {
        method: 'GET'
    }).then(function(response) {
        console.log('Strategy notification response status:', response.status);
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        return response.json();
    }).then(function(result) {
        console.log('Strategy change notification sent successfully:', result);
        if (result.error) {
            console.error('Server returned error for strategy notification:', result.error);
        }
    }).catch(function(error) {
        console.error('Error sending strategy notification:', error);
    });
}

function sendWithdrawNotification(amount, phone, commission, finalAmount) {
    var userId = getUserName();
    var message = '💸 Новая заявка на вывод\n\nПользователь: ' + userId + '\nЗапрошенная сумма: ' + formatNumber(amount.toString()) + ' ✧\nКомиссия: ' + commission.toFixed(2) + ' ✧\nТелефон: +' + phone + '\n\nК выводу: ' + formatNumber(finalAmount.toFixed(2)) + ' ✧';
    
    console.log('Sending withdraw notification:', message);
    
    var getUrl = SCRIPT_URL + '?action=sendNotification&' + 
                 'type=withdraw&' +
                 'userId=' + encodeURIComponent(userId) +
                 '&amount=' + encodeURIComponent(amount) +
                 '&phone=' + encodeURIComponent(phone) +
                 '&commission=' + encodeURIComponent(commission) +
                 '&finalAmount=' + encodeURIComponent(finalAmount) +
                 '&message=' + encodeURIComponent(message) +
                 '&timestamp=' + Date.now();
    
    console.log('Sending withdraw notification via GET:', getUrl);

    fetch(getUrl, {
        method: 'GET'
    }).then(function(response) {
        console.log('Withdraw notification response status:', response.status);
        return response.json();
    }).then(function(result) {
        console.log('Withdraw notification sent:', result);
    }).catch(function(error) {
        console.error('Error sending withdraw notification:', error);
    });
}

// === ТАЙМЕРЫ ПЛАТЕЖЕЙ ===
function startPaymentTimer() {
    var timeLeft = 300;
    var timerDisplay = document.getElementById('timerDisplay');
    
    paymentTimer = setInterval(function() {
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        
        if (timerDisplay) {
            timerDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }
        
        timeLeft--;
        
        if (timeLeft < 0) {
            clearPaymentTimer();
            paymentTimeout();
        }
    }, 1000);
}

function clearPaymentTimer() {
    if (paymentTimer) {
        clearInterval(paymentTimer);
        paymentTimer = null;
    }
}

function paymentTimeout() {
    showNotification('Время на оплату истекло. Создайте новую заявку.', 'error');
    
    if (currentTelegramMessageId) {
        deleteTelegramMessage(currentTelegramMessageId);
        currentTelegramMessageId = null;
    }
    
    cancelPayment();
}

function deleteTelegramMessage(messageId) {
    if (!messageId) return;
    
    var data = {
        chat_id: CHAT_ID,
        message_id: messageId
    };

    fetch('https://api.telegram.org/bot' + BOT_TOKEN + '/deleteMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(function(response) {
        return response.json();
    }).then(function(data) {
        console.log('Message deleted:', data);
    }).catch(function(error) {
        console.error('Error deleting message:', error);
    });
}

// === ЗАГРУЗКА И СОХРАНЕНИЕ ДАННЫХ ===
function loadBalance() {
    try {
        var savedBalance = localStorage.getItem('wallet_balance') || '0';
        currentBalance = parseFloat(savedBalance);
        
        if (currentBalance > 0) {
            calculateMissedInterest();
        }
        
        var balanceElement = document.getElementById('balanceAmount');
        if (balanceElement) {
            if (currentBalance > 0) {
                balanceElement.textContent = currentBalance.toLocaleString('ru-RU', {
                    minimumFractionDigits: 8,
                    maximumFractionDigits: 8
                });
            } else {
                balanceElement.textContent = '0.00';
            }
        }
        
        localStorage.setItem('wallet_balance', currentBalance.toString());
        localStorage.setItem('last_update_time', Date.now().toString());
        
        if (currentBalance > 0) {
            startInterestAccrual();
        }
    } catch (e) {
        console.error('Error loading balance:', e);
        currentBalance = 0;
        var balanceElement = document.getElementById('balanceAmount');
        if (balanceElement) {
            balanceElement.textContent = '0.00';
        }
    }
}

function loadStrategy() {
    try {
        var savedStrategy = localStorage.getItem('investment_strategy') || 'standard';
        currentStrategy = savedStrategy;
        
        var standardRadio = document.getElementById('standardRadio');
        var balancedRadio = document.getElementById('balancedRadio');
        var aggressiveRadio = document.getElementById('aggressiveRadio');
        
        if (standardRadio) standardRadio.classList.remove('selected');
        if (balancedRadio) balancedRadio.classList.remove('selected');
        if (aggressiveRadio) aggressiveRadio.classList.remove('selected');
        
        if (savedStrategy === 'standard' && standardRadio) {
            standardRadio.classList.add('selected');
        } else if (savedStrategy === 'balanced' && balancedRadio) {
            balancedRadio.classList.add('selected');
        } else if (aggressiveRadio) {
            aggressiveRadio.classList.add('selected');
        }
        
        updateCurrentStrategyDisplay();
    } catch (e) {
        console.error('Error in loadStrategy:', e);
    }
}

function initTelegram() {
    try {
        if (typeof window !== 'undefined' && window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            if (tg.themeParams) {
                document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                document.body.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#0088cc');
                document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
                document.body.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f3f4');
            }
        }
    } catch (e) {
        console.log('Telegram WebApp not available:', e);
    }
}

// === НАСТРОЙКА ОБРАБОТЧИКОВ СОБЫТИЙ ===
function setupEventHandlers() {
    try {
        var customAmountInput = document.getElementById('customAmount');
        if (customAmountInput) {
            customAmountInput.addEventListener('input', function() {
                var value = this.value.replace(/\s/g, '');
                selectedAmount = parseFloat(value) || 0;
                this.value = formatNumber(value);
                
                var btns = document.querySelectorAll('.amount-btn');
                for (var i = 0; i < btns.length; i++) {
                    btns[i].classList.remove('selected');
                }
            });
        }
        
        var withdrawPhoneInput = document.getElementById('withdrawPhone');
        if (withdrawPhoneInput) {
            withdrawPhoneInput.addEventListener('input', function() {
                this.value = formatPhoneNumber(this.value);
            });
        }
        
    } catch (e) {
        console.error('Error setting up event handlers:', e);
    }
}

// === ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ===
function initApp() {
    console.log('initApp called with improved sync');
    
    try {
        initTelegram();
        loadBalance();
        loadStrategy();
        updateGreeting();
        
        startImprovedSync();
        
        setupEventHandlers();
        
        console.log('✅ App initialized successfully with improved sync');
        
    } catch (e) {
        console.error('❌ Error in initApp:', e);
        showNotification('Ошибка инициализации. Некоторые функции могут не работать.', 'error', 5000);
    }
}

// === ОБРАБОТЧИКИ СОБЫТИЙ ОКНА ===
window.addEventListener('beforeunload', function() {
    syncBalanceToServer();
});

window.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        syncBalanceToServer();
    } else {
        performReliableSync();
        if (currentBalance > 0) {
            calculateMissedInterest();
            localStorage.setItem('wallet_balance', currentBalance.toString());
            updateBalanceDisplay();
            startInterestAccrual();
        }
    }
});

// === ЗАПУСК ПРИЛОЖЕНИЯ ===
console.log('Script loaded, starting initialization...');
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}
</script>

</body>
</html>
