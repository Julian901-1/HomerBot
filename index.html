<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ—à–µ–ª—ë–∫</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
      background: var(--tg-theme-bg-color, #f8f9fa);
      color: var(--tg-theme-text-color, #000);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      position: relative;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 400px;
      margin: 0 auto;
      width: 100%;
      padding: 0 16px;
    }

    .version {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 10px;
      color: #999;
      z-index: 1000;
    }

    /* –ú–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫ */
    .tabs-menu {
      display: flex;
      background: var(--tg-theme-bg-color, #fff);
      border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
      margin: 0 -16px;
    }

    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 16px;
      font-size: 16px;
      cursor: pointer;
      color: var(--tg-theme-hint-color, #999);
      position: relative;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      color: var(--tg-theme-link-color, #0088cc);
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--tg-theme-link-color, #0088cc);
      border-radius: 3px 3px 0 0;
    }

    /* –°—Ç—Ä–∞–Ω–∏—Ü—ã */
    .page {
      display: none;
      flex: 1;
      flex-direction: column;
      padding: 20px 0;
    }

    .page.active {
      display: flex;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –±–∞–ª–∞–Ω—Å */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    #greeting {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 10px;
      color: var(--tg-theme-text-color, #000);
    }

    .balance-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      padding: 25px 20px;
      color: white;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 25px;
      position: relative;
      overflow: hidden;
    }

    .balance-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      transform: rotate(30deg);
    }

    .balance-label {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    #balance {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    #balance::after {
      content: ' ‚úß';
    }

    .balance-info {
      font-size: 14px;
      opacity: 0.8;
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }

    .action-btn {
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 16px;
      padding: 18px 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .action-btn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-icon {
      font-size: 20px;
    }

    /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
    .amount-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .amount-btn {
      background: var(--tg-theme-secondary-bg-color, #f1f3f4);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 15px 5px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--tg-theme-text-color, #000);
    }

    .amount-btn.selected {
      border-color: var(--tg-theme-link-color, #0088cc);
      background: rgba(0, 136, 204, 0.1);
      color: var(--tg-theme-link-color, #0088cc);
    }

    .custom-amount {
      margin-bottom: 20px;
    }

    .custom-amount input {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
      border-radius: 12px;
      font-size: 16px;
      text-align: center;
      background: var(--tg-theme-secondary-bg-color, #f1f3f4);
      color: var(--tg-theme-text-color, #000);
    }

    .custom-amount input:focus {
      outline: none;
      border-color: var(--tg-theme-link-color, #0088cc);
    }

    #generatePaymentBtn {
      width: 100%;
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 16px;
      padding: 18px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }

    #generatePaymentBtn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    #paymentInfo {
      background: var(--tg-theme-secondary-bg-color, #f1f3f4);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }

    .payment-label {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999);
      margin-bottom: 5px;
    }

    #paymentAmount, #paymentComment {
      font-size: 18px;
      font-weight: 500;
      color: var(--tg-theme-text-color, #000);
      word-break: break-all;
    }

    #paymentComment {
      cursor: pointer;
      text-decoration: underline;
    }

    #paymentTimer {
      text-align: center;
      font-size: 18px;
      font-weight: 500;
      color: #f44336;
      margin-top: 10px;
    }

    #cancelPaymentBtn {
      width: 100%;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 16px;
      padding: 15px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #cancelPaymentBtn:hover {
      opacity: 0.9;
    }

    /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–≤–æ–¥–∞ */
    .withdraw-form {
      background: var(--tg-theme-secondary-bg-color, #f1f3f4);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999);
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 15px;
      border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
      border-radius: 12px;
      font-size: 16px;
      background: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--tg-theme-link-color, #0088cc);
    }

    .commission-info {
      font-size: 14px;
      color: var(--tg-theme-hint-color, #999);
      text-align: center;
      margin: 15px 0;
    }

    #withdrawBtn {
      width: 100%;
      background: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 16px;
      padding: 18px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #withdrawBtn:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .strategy-selector {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }

    .strategy-option {
      background: var(--tg-theme-secondary-bg-color, #f1f3f4);
      border: 2px solid transparent;
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .strategy-option.selected {
      border-color: var(--tg-theme-link-color, #0088cc);
      background: rgba(0, 136, 204, 0.1);
    }

    .strategy-name {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 4px;
      color: var(--tg-theme-text-color, #000);
    }

    .strategy-desc {
      font-size: 13px;
      color: var(--tg-theme-hint-color, #999);
    }

    .strategy-rate {
      font-size: 11px;
      color: var(--tg-theme-link-color, #0088cc);
      font-weight: 500;
      margin-top: 2px;
    }

    .highlight-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .highlight-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Pop-up —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
    .popup-notification {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      max-width: 90%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
    }

    .popup-notification.show {
      top: 20px;
      opacity: 1;
    }

    .popup-notification.error {
      background: #f44336;
    }

    .popup-notification.info {
      background: #2196F3;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--tg-theme-bg-color, #fff);
      border-radius: 20px;
      padding: 30px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--tg-theme-text-color, #000);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--tg-theme-hint-color, #999);
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-modal:hover {
      color: var(--tg-theme-text-color, #000);
    }

    .modal-body {
      color: var(--tg-theme-text-color, #000);
      line-height: 1.6;
    }

    .modal-body p {
      margin-bottom: 15px;
    }

    .modal-body ul {
      padding-left: 20px;
      margin-bottom: 15px;
    }

    .modal-body li {
      margin-bottom: 8px;
    }

    /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" */
    .info-page {
      padding: 20px 0;
    }

    .info-title {
      font-size: 22px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 25px;
      color: var(--tg-theme-text-color, #000);
    }

    .info-text {
      background: var(--tg-theme-secondary-bg-color, #f1f3f4);
      border-radius: 16px;
      padding: 20px;
      font-size: 15px;
      line-height: 1.6;
      color: var(--tg-theme-text-color, #000);
    }

    .info-text p {
      margin-bottom: 15px;
    }

    .info-text ul {
      padding-left: 20px;
      margin-bottom: 15px;
    }

    .info-text li {
      margin-bottom: 10px;
    }

    .highlight-btn {
      background: none;
      border: none;
      color: var(--tg-theme-link-color, #0088cc);
      text-decoration: underline;
      cursor: pointer;
      font-size: inherit;
      padding: 0;
    }

    .terms-link {
      text-align: center;
      font-size: 12px;
      color: var(--tg-theme-hint-color, #999);
      margin-top: 20px;
    }

    .terms-link a {
      color: var(--tg-theme-link-color, #0088cc);
      text-decoration: none;
    }

    .terms-link a:hover {
      text-decoration: underline;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 350px) {
      .amount-selector {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- –ú–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫ -->
    <div class="tabs-menu">
      <button class="tab-btn active" onclick="showMainPage()">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="tab-btn" onclick="showDepositPage()">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
      <button class="tab-btn" onclick="showWithdrawPage()">–í—ã–≤–µ—Å—Ç–∏</button>
      <button class="tab-btn" onclick="showSettingsPage()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      <button class="tab-btn" onclick="showInfoPage()">–ò–Ω—Ñ–æ</button>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
    <div id="mainTab" class="page active">
      <div class="header">
        <div id="greeting">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
      </div>
      
      <div class="balance-container">
        <div class="balance-label">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
        <div id="balance">0</div>
        <div class="balance-info">–ù–∞—á–∏—Å–ª—è–µ–º—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã: <span id="currentInterestRate">0</span>% –≤ –≥–æ–¥</div>
        <div class="balance-info">–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: <span id="currentStrategyName">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</span></div>
      </div>

      <div class="action-buttons">
        <button class="action-btn" onclick="showDepositPage()">
          <span class="action-icon">üì•</span>
          <span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</span>
        </button>
        <button class="action-btn" onclick="showWithdrawPage()">
          <span class="action-icon">üì§</span>
          <span>–í—ã–≤–µ—Å—Ç–∏</span>
        </button>
      </div>

      <button id="syncBtn" style="margin-bottom: 20px; background: #4CAF50; color: white; border: none; border-radius: 12px; padding: 12px; font-size: 14px; cursor: pointer;" onclick="forceBalanceSync()">
        üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
      </button>
      <button id="diagnosticsBtn" style="background: #FF9800; color: white; border: none; border-radius: 12px; padding: 12px; font-size: 14px; cursor: pointer;" onclick="runSyncDiagnostics()">
        üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
      </button>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
    <div id="depositTab" class="page">
      <h2 style="text-align: center; margin-bottom: 20px; color: var(--tg-theme-text-color, #000);">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h2>
      
      <div class="amount-selector">
        <button class="amount-btn" onclick="selectAmount(1000)">1 000</button>
        <button class="amount-btn" onclick="selectAmount(2500)">2 500</button>
        <button class="amount-btn" onclick="selectAmount(5000)">5 000</button>
        <button class="amount-btn" onclick="selectAmount(10000)">10 000</button>
        <button class="amount-btn" onclick="selectAmount(25000)">25 000</button>
        <button class="amount-btn" onclick="selectAmount(0)">–î—Ä—É–≥–∞—è</button>
      </div>

      <div class="custom-amount" id="customAmountContainer" style="display: none;">
        <input type="number" id="customAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="100" max="100000000">
      </div>

      <button id="generatePaymentBtn" onclick="generatePayment()">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>

      <div id="paymentInfo">
        <div class="payment-label">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</div>
        <div id="paymentAmount">0</div>
        <div class="payment-label" style="margin-top: 15px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</div>
        <div id="paymentComment" onclick="copyToClipboard(getCommentText())">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div id="paymentTimer"></div>
        <button id="cancelPaymentBtn" onclick="cancelPayment()">–û—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
      </div>

      <div id="paymentInstructions" style="display: none; background: #e3f2fd; border-radius: 12px; padding: 15px; margin-top: 20px;">
        <h3 style="margin-bottom: 10px; color: #1976d2;">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h3>
        <p>1. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É –Ω–∞ –∫–æ—à–µ–ª–µ–∫ Telegram.</p>
        <p>2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
        <p>3. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
        <p>4. –í–∞—à –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω.</p>
      </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–≤–æ–¥–∞ -->
    <div id="withdrawTab" class="page">
      <h2 style="text-align: center; margin-bottom: 20px; color: var(--tg-theme-text-color, #000);">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
      
      <div class="withdraw-form">
        <div class="form-group">
          <label for="withdrawAmount">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞ (–≤ ‚ö°):</label>
          <input type="number" id="withdrawAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="100">
        </div>
        
        <div class="form-group">
          <label for="phoneNumber">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
          <input type="tel" id="phoneNumber" placeholder="+7 (999) 999-99-99">
        </div>
        
        <div class="commission-info">
          –ö–æ–º–∏—Å—Å–∏—è –∑–∞ –≤—ã–≤–æ–¥: 5%<br>
          –ö –ø–æ–ª—É—á–µ–Ω–∏—é: <span id="finalAmount">0</span> ‚úß
        </div>
        
        <button id="withdrawBtn" onclick="processWithdrawal()">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
      </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settingsTab" class="page">
      <h2 style="text-align: center; margin-bottom: 25px; color: var(--tg-theme-text-color, #000);">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
      
      <div class="strategy-selector">
        <div class="strategy-option" onclick="selectStrategy('standard')">
          <div class="strategy-name">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</div>
          <div class="strategy-desc">–£–º–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥</div>
          <div class="strategy-rate">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: 16.0% –≥–æ–¥–æ–≤—ã—Ö</div>
        </div>
        
        <div class="strategy-option" onclick="selectStrategy('balanced')">
          <div class="strategy-name">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</div>
          <div class="strategy-desc">–û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∏—Å–∫–∞ –∏ –ø—Ä–∏–±—ã–ª–∏</div>
          <div class="strategy-rate">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: 17.5% –≥–æ–¥–æ–≤—ã—Ö</div>
        </div>
        
        <div class="strategy-option" onclick="selectStrategy('aggressive')">
          <div class="strategy-name">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è</div>
          <div class="strategy-desc">–í—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å</div>
          <div class="strategy-rate">–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å: 18.5% –≥–æ–¥–æ–≤—ã—Ö</div>
        </div>
      </div>
    </div>

    <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" -->
    <div id="infoTab" class="info-page">
      <div class="highlight-overlay" id="highlightOverlay"></div>
      
      <div class="info-title">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</div>
      
      <div class="info-text">
        <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ HomerBot - –≤–∞—à –ª–∏—á–Ω—ã–π –∫–æ—à–µ–ª–µ–∫ –≤ Telegram!</p>
        
        <p><strong>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</strong></p>
        <ul>
          <li>–•—Ä–∞–Ω–µ–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</li>
          <li>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–≤–æ–¥—ã</li>
          <li>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω</li>
          <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤</li>
        </ul>
        
        <p><strong>–ö–∞–∫ –Ω–∞—á–∞—Ç—å:</strong></p>
        <ul>
          <li>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–ø–æ–ª–Ω–∏—Ç—å" –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</li>
          <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"</li>
          <li>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Ä–æ—Å—Ç –±–∞–ª–∞–Ω—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
        </ul>
        
        <p><strong>–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</strong></p>
        <ul>
          <li><strong>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</strong> - —É–º–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∏—Å–∫–∏, 16% –≥–æ–¥–æ–≤—ã—Ö</li>
          <li><strong>–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</strong> - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å, 17.5% –≥–æ–¥–æ–≤—ã—Ö</li>
          <li><strong>–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è</strong> - –≤—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏, 18.5% –≥–æ–¥–æ–≤—ã—Ö</li>
        </ul>
        
        <p>–ü—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –µ–∂–µ—Å–µ–∫—É–Ω–¥–Ω–æ –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.</p>
      </div>
      
      <div class="terms-link">
        –ü–æ–ª—å–∑—É—è—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ<br>
        <a href="https://docs.google.com/document/d/1LYWcZc49Lh84t-jEH8MDc5NvYfLBqQM7KvNG7Vybgrs/edit?usp=sharing" target="_blank">—É—Å–ª–æ–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
      </div>
    </div>
  </div>

  <!-- Pop-up —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
  <div id="popupNotification" class="popup-notification"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="infoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫</div>
        <button class="close-modal" onclick="hideModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="version">v3.1</div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      console.log('Telegram WebApp initialized');
    } else {
      console.log('Not in Telegram environment - using test data');
    }

    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    var currentBalance = 0;
    var selectedAmount = 0;
    var currentStrategy = 'standard';
    var tg = null;
    var paymentTimer = null;
    var currentTransactionId = null;
    var currentPaymentAmount = 0;
    var interestTimer = null;
    var lastUpdateTime = null;
    var currentTelegramMessageId = null;

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è Telegram –±–æ—Ç–∞
    var BOT_TOKEN = '7631840452:AAH4O93qQ6J914x5FhPTQX7YhJC3bTiJ_XA';
    var CHAT_ID = '487525838';

    // URL Google Apps Script
    var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_tTk4wa8xwNP3JlwFoZRAV9XyCGxEZR9t5WeYEoSsylCktVblQlD30i_fcsosnV9i-g/exec';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
    var INTEREST_RATES = {
      standard: 16.0,
      balanced: 17.5,
      aggressive: 18.5
    };

    // === –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===
    var SYNC_CONFIG = {
      maxRetries: 3,
      timeoutMs: 10000,
      retryDelayMs: 2000,
      syncIntervalMs: 120000, // 2 –º–∏–Ω—É—Ç—ã
      forceUpdateThreshold: 0.01
    };

    var syncState = {
      isActive: false,
      lastSyncTime: 0,
      consecutiveFailures: 0,
      currentMethod: 'jsonp'
    };

    // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò ===
    function showTab(tabName) {
      console.log('showTab called with:', tabName);
      try {
        var tabBtns = document.querySelectorAll('.tab-btn');
        for (var i = 0; i < tabBtns.length; i++) {
          tabBtns[i].classList.remove('active');
        }

        var pages = document.querySelectorAll('.page');
        for (var i = 0; i < pages.length; i++) {
          pages[i].classList.remove('active');
        }

        if (tabName === 'main') {
          document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
          document.getElementById('mainTab').classList.add('active');
        } else if (tabName === 'deposit') {
          document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
          document.getElementById('depositTab').classList.add('active');
        } else if (tabName === 'withdraw') {
          document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
          document.getElementById('withdrawTab').classList.add('active');
        } else if (tabName === 'settings') {
          document.querySelector('.tab-btn:nth-child(4)').classList.add('active');
          document.getElementById('settingsTab').classList.add('active');
        } else if (tabName === 'info') {
          document.querySelector('.tab-btn:nth-child(5)').classList.add('active');
          document.getElementById('infoTab').classList.add('active');
        }
      } catch (e) {
        console.error('Error in showTab:', e);
      }
    }

    function showMainPage() {
      console.log("Showing main page...");
      showTab('main');
    }

    function showDepositPage() {
      console.log("Showing deposit page...");
      showTab('deposit');
    }

    function showWithdrawPage() {
      console.log("Showing withdraw page...");
      showTab('withdraw');
    }

    function showSettingsPage() {
      console.log("Showing settings page...");
      showTab('settings');
    }

    function showInfoPage() {
      console.log("Showing info page...");
      showTab('info');
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
    function initApp() {
      try {
        console.log('initApp called with improved sync');
        tg = window.Telegram ? window.Telegram.WebApp : null;
        applyTelegramTheme();
        updateGreeting();
        loadBalance();
        showTab('main');
        startImprovedSync();
        setupEventHandlers();
        console.log('‚úÖ App initialized successfully with improved sync');
      } catch (e) {
        console.error('‚ùå Error in initApp:', e);
        showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.', 'error', 5000);
      }
    }

    // === –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ===
    function startImprovedSync() {
      console.log('üöÄ Starting improved synchronization system...');
      // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      performReliableSync().catch(e => console.error('Initial sync failed:', e));

      // –ü–ª–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
      setInterval(function () {
        console.log('‚è∞ Scheduled sync triggered');
        performReliableSync().catch(e => console.error('Scheduled sync failed:', e));
      }, SYNC_CONFIG.syncIntervalMs);
    }

    // === –ù–ê–î–ï–ñ–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° –ü–û–í–¢–û–†–ê–ú–ò ===
    function performReliableSync() {
      console.log('üöÄ Starting reliable sync process...');
      return new Promise(function (resolve, reject) {
        let attempt = 1;

        function doAttempt() {
          console.log(`üîÑ Sync attempt ${attempt} of ${SYNC_CONFIG.maxRetries}`);
          performJsonpSync()
            .then(function (result) {
              console.log('‚úÖ Sync successful on attempt', attempt);
              resolve(result);
            })
            .catch(function (error) {
              console.log(`‚ùå Sync attempt ${attempt} failed:`, error.message || error);
              attempt++;
              if (attempt <= SYNC_CONFIG.maxRetries) {
                console.log(`‚è≥ Retrying in ${SYNC_CONFIG.retryDelayMs} ms...`);
                setTimeout(doAttempt, SYNC_CONFIG.retryDelayMs);
              } else {
                console.log('üí• All sync attempts failed');
                // Fallback: –ü—Ä–æ–±—É–µ–º Image Pixel Sync
                attemptImagePixelSync()
                  .then(resolve)
                  .catch(reject);
              }
            });
        }

        doAttempt();
      });
    }

    // === –û–°–ù–û–í–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ß–ï–†–ï–ó JSONP ===
    function performJsonpSync() {
      return new Promise(function (resolve, reject) {
        console.log('üåê Attempting JSONP sync...');
        var username = getUserName();
        var callbackName = 'sync_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        var script, timeoutId;

        function cleanup() {
          clearTimeout(timeoutId);
          if (window[callbackName]) {
            delete window[callbackName];
          }
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        function complete(success, data) {
          cleanup();
          if (success) {
            resolve(data);
          } else {
            reject(new Error(data || 'JSONP request failed'));
          }
        }

        timeoutId = setTimeout(function () {
          console.log('‚è∞ JSONP timeout after', SYNC_CONFIG.timeoutMs, 'ms');
          complete(false, 'JSONP timeout');
        }, SYNC_CONFIG.timeoutMs);

        window[callbackName] = function (data) {
          console.log('‚úÖ JSONP success! Received:', data);
          try {
            var processResult = processServerData(data);
            complete(true, { success: true, data: data, processed: processResult });
          } catch (error) {
            console.error('‚ùå Error processing JSONP data:', error);
            complete(false, 'Error processing data: ' + error.message);
          }
        };

        script = document.createElement('script');
        script.id = callbackName;
        script.type = 'text/javascript';
        script.onerror = function (error) {
          console.log('‚ùå JSONP script failed to load:', error);
          complete(false, 'Script load error');
        };

        // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        var url = SCRIPT_URL +
          '?action=getBalance' +
          '&username=' + encodeURIComponent(username) +
          '&currentBalance=' + encodeURIComponent(currentBalance) +
          '&strategy=' + encodeURIComponent(currentStrategy) +
          '&callback=' + callbackName +
          '&t=' + Date.now();

        console.log('üåê JSONP request URL:', url.substring(0, 150) + '...');
        script.src = url;
        document.head.appendChild(script);
      });
    }

    // === –†–ï–ó–ï–†–í–ù–´–ô –ú–ï–¢–û–î –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò: Image Pixel ===
    function attemptImagePixelSync() {
      return new Promise(function (resolve, reject) {
        console.log('üñºÔ∏è Attempting image pixel sync fallback...');
        var username = getUserName();
        var img = new Image();
        var completed = false;

        function cleanup() {
          if (completed) return;
          completed = true;
          img.onload = null;
          img.onerror = null;
        }

        img.onload = function () {
          console.log('‚úÖ Image pixel sync successful (image loaded)');
          cleanup();
          // Image Pixel –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ—Å—Ç–æ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–± —É—Å–ø–µ—Ö–µ.
          // –ú—ã –º–æ–∂–µ–º –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ –ø–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å —á–µ—Ä–µ–∑ JSONP –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ.
          performJsonpSync().then(resolve).catch(function(err) {
              // –ï—Å–ª–∏ JSONP –ø–æ—Å–ª–µ Image Pixel —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª—Å—è, –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—á–∏—Ç–∞–µ–º Image Pixel —É—Å–ø–µ—à–Ω—ã–º
              console.log('‚ö†Ô∏è Image pixel sync OK, but follow-up JSONP failed:', err);
              resolve({ success: true, message: "Image pixel sync OK, data fetch failed" });
          });
        };

        img.onerror = function (error) {
          console.log('‚ùå Image pixel sync failed (image error):', error);
          cleanup();
          reject(new Error('Image pixel sync failed'));
        };

        // URL –¥–ª—è Image Pixel Sync (–Ω–æ–≤—ã–π action)
        var url = SCRIPT_URL +
          '?action=imagePixelSync' + // –ù–æ–≤—ã–π action
          '&username=' + encodeURIComponent(username) +
          '&currentBalance=' + encodeURIComponent(currentBalance) +
          '&strategy=' + encodeURIComponent(currentStrategy) +
          '&t=' + Date.now();

        console.log('üñºÔ∏è Image pixel URL:', url.substring(0, 150) + '...');
        img.src = url;
        // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º img –≤ DOM, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ–≤–∏–¥–∏–º –∏ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      });
    }

    // === –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• –° –°–ï–†–í–ï–†–ê ===
    function processServerData(data) {
      try {
        console.log('üì• Processing server data:', data);
        if (!data || !data.success) {
          console.log('‚ö†Ô∏è Server returned error or not success:', data);
          return { processed: false, reason: 'Server error or not success' };
        }

        if (data.action === 'getBalance' && data.username) {
          console.log('üîÑ Updating local data from server...');
          currentBalance = parseFloat(data.balance) || 0;
          currentStrategy = data.strategy || 'standard';
          lastUpdateTime = new Date(data.timestamp) || new Date();
          saveBalance();
          updateBalanceDisplay();
          updateCurrentStrategyDisplay();
          startInterestAccrual();
          console.log('‚úÖ Local data updated from server');
          return { processed: true, updated: true };
        } else if (data.action === 'updateBalance') {
          console.log('‚úÖ Server confirmed balance update');
          // –î–∞–Ω–Ω—ã–µ —É–∂–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ getBalance, —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
          return { processed: true, updated: false };
        } else {
          console.log('‚ÑπÔ∏è Server data processed, no balance update needed');
          return { processed: true, updated: false };
        }
      } catch (e) {
        console.error('‚ùå Error processing server data:', e);
        return { processed: false, error: e.message };
      }
    }

    // === –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ===
    function forceBalanceSync() {
      console.log('üîÑ User requested force sync');
      showNotification('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'info');
      return performReliableSync().then(function (result) {
        if (result.success) {
          showNotification('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        } else {
          showNotification('‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏', 'info');
        }
        return result;
      }).catch(function (error) {
        console.error('‚ùå Force sync failed:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
        throw error;
      });
    }

    // === –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ë–ê–õ–ê–ù–°–ê –ù–ê –°–ï–†–í–ï–† ===
    function syncBalanceToServer() {
      console.log('üì§ Uploading balance to server...');
      var username = getUserName();
      if (!username || username === '@test_user') {
        console.log('‚ö†Ô∏è Skipping sync for test user');
        return Promise.resolve();
      }

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Image Pixel –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ fallback)
      return new Promise(function (resolve, reject) {
        console.log('üñºÔ∏è Uploading via image pixel...');
        var img = new Image();
        var completed = false;

        function cleanup() {
          if (completed) return;
          completed = true;
          img.onload = null;
          img.onerror = null;
        }

        img.onload = function () {
          console.log('‚úÖ Balance upload via image pixel successful');
          cleanup();
          resolve({ success: true });
        };

        img.onerror = function (error) {
          console.log('‚ùå Balance upload via image pixel failed:', error);
          cleanup();
          // –î–∞–∂–µ –µ—Å–ª–∏ Image Pixel –Ω–µ —É–¥–∞–ª—Å—è, –Ω–µ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–æ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          resolve({ success: false, message: "Image pixel upload failed" });
        };

        var url = SCRIPT_URL +
          '?action=updateBalance' + // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π action
          '&username=' + encodeURIComponent(username) +
          '&balance=' + encodeURIComponent(currentBalance) +
          '&strategy=' + encodeURIComponent(currentStrategy) +
          '&t=' + Date.now();

        console.log('üñºÔ∏è Upload URL:', url.substring(0, 150) + '...');
        img.src = url;
      });
    }

    // === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ===
    function runSyncDiagnostics() {
      console.log('üîç Running sync diagnostics...');
      showNotification('üîç –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');

      diagnoseSyncIssues().then(function (serverReachable) {
        return performReliableSync();
      }).then(function (result) {
        const message = result.success ?
          '‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç.' :
          '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π.';
        showNotification(message, result.success ? 'success' : 'error');
        console.log('üìä Diagnostic Results:', { syncResult: result, currentBalance: currentBalance, currentStrategy: currentStrategy, syncState: syncState });
      }).catch(function (error) {
        showNotification('‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å: ' + error.message, 'error');
        console.error('‚ùå Diagnostics failed:', error);
      });
    }

    function diagnoseSyncIssues() {
      console.log('üîç SYNC DIAGNOSTICS:');
      console.log('- Current method:', syncState.currentMethod);
      console.log('- Is active:', syncState.isActive);
      console.log('- Last sync:', new Date(syncState.lastSyncTime).toLocaleString());
      console.log('- Consecutive failures:', syncState.consecutiveFailures);
      console.log('- Script URL:', SCRIPT_URL);
      console.log('- Current balance:', currentBalance);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
      var testUrl = SCRIPT_URL + '?action=test&t=' + Date.now();
      return fetch(testUrl, { method: 'GET', cache: 'no-cache' })
        .then(function (response) {
           console.log('‚úÖ Server test request status:', response.status);
           if(response.ok) {
               return response.json().then(data => {
                   console.log('‚úÖ Server test response data:', data);
                   return true;
               }).catch(e => {
                   console.warn('‚ö†Ô∏è Server responded OK but JSON parse failed:', e);
                   return true; // –°—á–∏—Ç–∞–µ–º —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–Ω—ã–º, –¥–∞–∂–µ –µ—Å–ª–∏ JSON –∫—Ä–∏–≤–æ–π
               });
           } else {
               console.log('‚ùå Server test request failed with status:', response.status);
               return false;
           }
        })
        .catch(function (error) {
          console.log('‚ùå Server unreachable:', error.message);
          return false;
        });
    }

    function getUserName() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        var user = tg.initDataUnsafe.user;
        return user.username ? '@' + user.username : 'user_' + user.id;
      }
      return '@test_user';
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–õ–ê–¢–ï–ñ–ê ===
    function generatePayment(amount) {
      try {
        var amountInput = document.getElementById('customAmount');
        var amount = selectedAmount;
        
        if (selectedAmount === 0 && amountInput && amountInput.value) {
          amount = parseFloat(amountInput.value.replace(/\s/g, ''));
        }

        if (!amount || amount < 100 || amount > 100000000) {
          showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –æ—Ç 100 –¥–æ 100 000 000 ‚úß', 'error');
          return;
        }

        selectedAmount = amount;
        var transactionId = 'DEP' + Date.now().toString().slice(-6);
        currentTransactionId = transactionId;
        currentPaymentAmount = amount;

        showNotification('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ—Å–ª–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');

        var paymentAmount = document.getElementById('paymentAmount');
        var paymentComment = document.getElementById('paymentComment');
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');

        if (paymentAmount) paymentAmount.textContent = formatNumber(amount.toString());
        if (paymentComment) paymentComment.textContent = transactionId;
        if (paymentInfo) paymentInfo.style.display = 'block';
        if (paymentInstructions) paymentInstructions.style.display = 'block';
        if (generateBtn) generateBtn.disabled = true;

        startPaymentTimer();
        sendTelegramNotification(amount, transactionId);

        var paymentCheckInterval = setInterval(function () {
          checkPaymentConfirmation();
        }, 5000);
        window.currentPaymentCheckInterval = paymentCheckInterval;

      } catch (e) {
        console.error('Error in generatePayment:', e);
      }
    }

    // === –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ü–õ–ê–¢–ï–ñ–ê ===
    function checkPaymentConfirmation() {
      if (!currentTransactionId) return;

      var checkUrl = SCRIPT_URL + '?action=checkPayment&transactionId=' + encodeURIComponent(currentTransactionId) + '&t=' + Date.now();
      fetch(checkUrl, { method: 'GET' })
        .then(function (response) { return response.json(); })
        .then(function (data) {
          console.log('Payment check result:', data);
          if (data.confirmed) {
            showNotification('‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω.', 'success');
            currentBalance += currentPaymentAmount;
            saveBalance();
            updateBalanceDisplay();
            clearInterval(window.currentPaymentCheckInterval);
            clearPaymentTimer();
            currentTransactionId = null;
            currentPaymentAmount = 0;
            currentTelegramMessageId = null;
            syncBalanceToServer(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å
          } else if (data.rejected) {
            showNotification('‚ùå –ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
            cancelPayment();
          }
        }).catch(function (error) {
          console.error('Error checking payment:', error);
        });
    }

    // === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø TELEGRAM ===
    function sendTelegramNotification(amount, transactionId) {
      var userId = getUserName();
      var message = 'üí∞ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + userId + '\n–°—É–º–º–∞: ' + formatNumber(amount.toString()) + ' ‚ö°\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ' + transactionId + '\n–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ–≤–æ–¥?';

      console.log('Sending deposit notification:', message);

      var getUrl = SCRIPT_URL + '?action=sendNotification&' +
        'type=deposit&' +
        'userId=' + encodeURIComponent(userId) +
        '&amount=' + encodeURIComponent(amount) +
        '&transactionId=' + encodeURIComponent(transactionId) +
        '&message=' + encodeURIComponent(message) +
        '&timestamp=' + Date.now();

      console.log('üåê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å:', getUrl.substring(0, 200) + '...');

      fetch(getUrl, { method: 'GET' })
        .then(function (response) {
          console.log('üìã Response status:', response.status);
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function (result) {
          console.log('‚úÖ Parsed JSON result:', result);
          if (result.success && result.messageId) {
            currentTelegramMessageId = result.messageId;
            console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Google Apps Script, messageId:', result.messageId);
            showNotification('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
          } else {
             console.warn('‚ö†Ô∏è Notification sent, but no messageId received or not successful:', result);
             showNotification('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.', 'info');
          }
        })
        .catch(function (error) {
          console.error('‚ùå Error sending Telegram notification:', error);
          showNotification('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è.', 'info');
        });
    }

    function sendStrategyChangeNotification(strategy) {
      var strategyNames = { standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è', balanced: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è', aggressive: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è' };
      var userId = getUserName();
      var message = 'üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + userId + ' —Å–º–µ–Ω–∏–ª —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ "' + strategyNames[strategy] + '"';

      console.log('Sending strategy notification:', message);

      var getUrl = SCRIPT_URL + '?action=sendNotification&' +
        'type=strategy_change&' +
        'userId=' + encodeURIComponent(userId) +
        '&strategy=' + encodeURIComponent(strategy) +
        '&message=' + encodeURIComponent(message) +
        '&timestamp=' + Date.now();

      console.log('Sending strategy notification via GET:', getUrl);

      fetch(getUrl, { method: 'GET' })
        .then(function (response) {
          console.log('Strategy notification response status:', response.status);
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function (result) {
          console.log('Strategy notification result:', result);
          if (result.success) {
            console.log('‚úÖ Strategy change notification sent');
          } else {
            console.warn('‚ö†Ô∏è Strategy change notification not successful:', result);
          }
        })
        .catch(function (error) {
          console.error('Error sending strategy notification:', error);
        });
    }

    function sendWithdrawalRequest(amount, phone) {
      if (!amount || amount <= 0 || !phone) {
        showNotification('‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞', 'error');
        return;
      }

      var commission = amount * 0.05;
      var finalAmount = amount - commission;
      var userId = getUserName();
      var message = 'üì§ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + userId + '\n–°—É–º–º–∞: ' + formatNumber(amount.toFixed(2)) + ' ‚úß\n–¢–µ–ª–µ—Ñ–æ–Ω: ' + phone + '\n–ö–æ–º–∏—Å—Å–∏—è (5%): ' + formatNumber(commission.toFixed(2)) + ' ‚úß\n–ö –≤—ã–≤–æ–¥—É: ' + formatNumber(finalAmount.toFixed(2)) + ' ‚úß';

      console.log('Sending withdraw notification:', message);

      var getUrl = SCRIPT_URL + '?action=sendNotification&' +
        'type=withdraw&' +
        'userId=' + encodeURIComponent(userId) +
        '&amount=' + encodeURIComponent(amount) +
        '&phone=' + encodeURIComponent(phone) +
        '&commission=' + encodeURIComponent(commission) +
        '&finalAmount=' + encodeURIComponent(finalAmount) +
        '&message=' + encodeURIComponent(message) +
        '&timestamp=' + Date.now();

      console.log('Sending withdraw notification via GET:', getUrl);

      fetch(getUrl, { method: 'GET' })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function (result) {
          console.log('Withdraw notification result:', result);
          if (result.success) {
            showNotification('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
          } else {
            showNotification('‚ö†Ô∏è –í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏.', 'error');
          }
        })
        .catch(function (error) {
          console.error('Error sending withdraw notification:', error);
          showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
        });
    }

    // === –û–¢–ú–ï–ù–ê –ü–õ–ê–¢–ï–ñ–ê ===
    function cancelPayment() {
      try {
        console.log('üö´ Cancelling payment...');
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');
        if (paymentInfo) paymentInfo.style.display = 'none';
        if (paymentInstructions) paymentInstructions.style.display = 'none';
        if (generateBtn) generateBtn.disabled = false;

        clearInterval(window.currentPaymentCheckInterval);
        clearPaymentTimer();

        if (currentTelegramMessageId) {
          deleteTelegramMessage(currentTelegramMessageId);
          currentTelegramMessageId = null;
        }

        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ–± –æ—Ç–º–µ–Ω–µ
        var cancelUrl = SCRIPT_URL + '?action=cancelPayment&' +
          'transactionId=' + encodeURIComponent(currentTransactionId) +
          '&messageId=' + encodeURIComponent(currentTelegramMessageId || '') +
          '&timestamp=' + Date.now();

        fetch(cancelUrl, { method: 'GET' })
          .then(function (response) {
            console.log('Cancel notification sent, status:', response.status);
          })
          .catch(function (error) {
            console.error('Error sending cancel notification:', error);
          });

        selectedAmount = 0;
        currentTransactionId = null;
        currentPaymentAmount = 0;
        currentTelegramMessageId = null;
        console.log('‚úÖ –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ');
      } catch (e) {
        console.error('Error in cancelPayment:', e);
      }
    }

    function deleteTelegramMessage(messageId) {
      if (!messageId) return;
      var data = {
        chat_id: CHAT_ID,
        message_id: messageId
      };
      fetch('https://api.telegram.org/bot' + BOT_TOKEN + '/deleteMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(function (response) {
        return response.json();
      }).then(function (data) {
        console.log('Message deleted:', data);
      }).catch(function (error) {
        console.error('Error deleting message:', error);
      });
    }

    // === –ó–ê–ì–†–£–ó–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ===
    function loadBalance() {
      try {
        var savedBalance = localStorage.getItem('wallet_balance') || '0';
        currentBalance = parseFloat(savedBalance);
        var savedStrategy = localStorage.getItem('wallet_strategy') || 'standard';
        currentStrategy = savedStrategy;
        updateBalanceDisplay();
        updateCurrentStrategyDisplay();
        startInterestAccrual();
        console.log('üíæ Loaded balance from localStorage:', currentBalance, currentStrategy);
      } catch (e) {
        console.error('Error loading balance:', e);
      }
    }

    function saveBalance() {
      try {
        localStorage.setItem('wallet_balance', currentBalance.toString());
        localStorage.setItem('wallet_strategy', currentStrategy);
        console.log('üíæ Balance saved to localStorage:', currentBalance, currentStrategy);
      } catch (e) {
        console.error('Error saving balance:', e);
      }
    }

    // === –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø ===
    function updateBalanceDisplay() {
      var balanceElement = document.getElementById('balance');
      var interestRateElement = document.getElementById('currentInterestRate');
      if (balanceElement) {
        balanceElement.textContent = formatNumber(currentBalance.toFixed(2));
      }
      if (interestRateElement) {
        interestRateElement.textContent = INTEREST_RATES[currentStrategy] || '0';
      }
    }

    function selectAmount(amount) {
      selectedAmount = amount;
      var buttons = document.querySelectorAll('.amount-btn');
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove('selected');
      }
      
      event.target.classList.add('selected');
      
      var customContainer = document.getElementById('customAmountContainer');
      if (amount === 0 && customContainer) {
        customContainer.style.display = 'block';
        var customInput = document.getElementById('customAmount');
        if (customInput) customInput.focus();
      } else {
        if (customContainer) customContainer.style.display = 'none';
      }
    }

    function selectStrategy(strategy) {
      currentStrategy = strategy;
      saveBalance();
      updateCurrentStrategyDisplay();
      var options = document.querySelectorAll('.strategy-option');
      for (var i = 0; i < options.length; i++) {
        options[i].classList.remove('selected');
      }
      event.target.closest('.strategy-option').classList.add('selected');
      showNotification('–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ' + strategy, 'success');
      sendStrategyChangeNotification(strategy);
      syncBalanceToServer(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    }

    function updateGreeting() {
      try {
        var greeting = document.getElementById('greeting');
        if (!greeting) return;
        var now = new Date();
        var moscowTime = new Date(now.getTime() + (3 * 60 * 60 * 1000));
        var hour = moscowTime.getHours();
        var timeGreeting = hour >= 17 ? '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä' : '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
        var userName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          userName = tg.initDataUnsafe.user.first_name || tg.initDataUnsafe.user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        greeting.textContent = timeGreeting + ', ' + userName + '!';
      } catch (e) {
        console.error('Error updating greeting:', e);
        var greeting = document.getElementById('greeting');
        if (greeting) {
          greeting.textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!';
        }
      }
    }

    // === –§–£–ù–ö–¶–ò–ò –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –ü–†–û–¶–ï–ù–¢–û–í ===
    function startInterestAccrual() {
      if (interestTimer) {
        clearInterval(interestTimer);
      }
      lastUpdateTime = Date.now();
      console.log('Starting interest accrual for balance:', currentBalance);
      interestTimer = setInterval(function() {
        if (currentBalance > 0) {
          var currentTime = Date.now();
          var timeDiff = (currentTime - lastUpdateTime) / 1000; // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
          lastUpdateTime = currentTime;
          
          var currentRate = INTEREST_RATES[currentStrategy] || INTEREST_RATES.standard;
          var yearlyRate = currentRate / 100;
          var secondlyRate = yearlyRate / (365 * 24 * 60 * 60);
          var interest = currentBalance * secondlyRate * timeDiff;
          currentBalance += interest;
          saveBalance();
          updateBalanceDisplay();
          // console.log('Added interest:', interest, 'for', timeDiff, 'seconds');
        }
      }, 1000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    }

    function calculateMissedInterest() {
      try {
        if (!lastUpdateTime) return;
        var currentTime = Date.now();
        var timeDiff = (currentTime - lastUpdateTime) / 1000; // —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        if (timeDiff > 60) { // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç—ã
          var currentRate = INTEREST_RATES[currentStrategy] || INTEREST_RATES.standard;
          var yearlyRate = currentRate / 100;
          var secondlyRate = yearlyRate / (365 * 24 * 60 * 60);
          var missedInterest = currentBalance * secondlyRate * timeDiff;
          currentBalance += missedInterest;
          var hours = Math.floor(timeDiff / 3600);
          var minutes = Math.floor((timeDiff % 3600) / 60);
          console.log('Added missed interest:', missedInterest, 'for', hours, 'hours and', minutes, 'minutes');
        }
      } catch (e) {
        console.error('Error calculating missed interest:', e);
      }
    }

    function updateCurrentStrategyDisplay() {
      var strategyNames = {standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è', balanced: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è', aggressive: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è'};
      var currentStrategyName = document.getElementById('currentStrategyName');
      if (currentStrategyName) {
        currentStrategyName.textContent = strategyNames[currentStrategy] || '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è';
      }
    }

    // === –§–£–ù–ö–¶–ò–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ===
    function showNotification(message, type, duration) {
      try {
        var notification = document.getElementById('popupNotification');
        if (!notification) return;
        notification.className = 'popup-notification';
        notification.textContent = message;
        if (type === 'error') {
          notification.classList.add('error');
        } else if (type === 'info') {
          notification.classList.add('info');
        }
        requestAnimationFrame(function() {
          notification.classList.add('show');
        });
        
        if (duration !== 0) {
          setTimeout(function() {
            notification.classList.remove('show');
          }, duration || 3000);
        }
      } catch (e) {
        console.error('Error in showNotification:', e);
      }
    }

    // === –¢–ê–ô–ú–ï–† –ü–õ–ê–¢–ï–ñ–ê ===
    function startPaymentTimer() {
      var timeLeft = 15 * 60; // 15 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
      var timerDisplay = document.getElementById('paymentTimer');
      if (timerDisplay) timerDisplay.textContent = '15:00';
      
      paymentTimer = setInterval(function() {
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        if (timerDisplay) {
          timerDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }
        timeLeft--;
        if (timeLeft < 0) {
          clearPaymentTimer();
          paymentTimeout();
        }
      }, 1000);
    }

    function clearPaymentTimer() {
      if (paymentTimer) {
        clearInterval(paymentTimer);
        paymentTimer = null;
      }
    }

    function paymentTimeout() {
      showNotification('–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.', 'error');
      if (currentTelegramMessageId) {
        deleteTelegramMessage(currentTelegramMessageId);
        currentTelegramMessageId = null;
      }
      cancelPayment();
    }

    // === –§–£–ù–ö–¶–ò–ò –í–´–í–û–î–ê ===
    function processWithdrawal() {
      var amountInput = document.getElementById('withdrawAmount');
      var phoneInput = document.getElementById('phoneNumber');
      
      if (!amountInput || !phoneInput) return;
      
      var amount = parseFloat(amountInput.value);
      var phone = phoneInput.value;
      
      if (!amount || amount < 100) {
        showNotification('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 100 ‚ö°', 'error');
        return;
      }
      
      if (amount > currentBalance) {
        showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ', 'error');
        return;
      }
      
      if (!phone || phone.length < 10) {
        showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
        return;
      }
      
      var formattedPhone = formatPhoneNumber(phone);
      sendWithdrawalRequest(amount, formattedPhone);
      
      // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å—Ä–∞–∑—É (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
      currentBalance -= amount;
      saveBalance();
      updateBalanceDisplay();
      showNotification('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
      
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      amountInput.value = '';
      phoneInput.value = '';
      updateFinalAmount();
    }

    function updateFinalAmount() {
      var amountInput = document.getElementById('withdrawAmount');
      var finalAmountDisplay = document.getElementById('finalAmount');
      
      if (!amountInput || !finalAmountDisplay) return;
      
      var amount = parseFloat(amountInput.value) || 0;
      var commission = amount * 0.05;
      var finalAmount = amount - commission;
      
      finalAmountDisplay.textContent = formatNumber(finalAmount.toFixed(2));
    }

    // === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ===
    function showModal(title, content) {
      var modal = document.getElementById('infoModal');
      var modalTitle = document.getElementById('modalTitle');
      var modalBody = document.getElementById('modalBody');
      
      if (modal && modalTitle && modalBody) {
        modalTitle.textContent = title;
        modalBody.innerHTML = content;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
    }

    function hideModal() {
      var modal = document.getElementById('infoModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
    }

    // === –§–£–ù–ö–¶–ò–ò –ë–£–§–ï–†–ê –û–ë–ú–ï–ù–ê ===
    function copyToClipboard(text) {
      try {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text).then(function() {
            showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
          });
        } else {
          var textArea = document.createElement('textarea');
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
        }
      } catch (e) {
        console.error('Error in copyToClipboard:', e);
      }
    }

    function getCommentText() {
      var commentEl = document.getElementById('paymentComment');
      return commentEl ? commentEl.textContent : '';
    }

    // === –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ===
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function formatPhoneNumber(value) {
      var numbers = value.replace(/\D/g, '');
      if (numbers.length === 0) return '';
      if (numbers.length <= 1) {
        return '+' + numbers;
      } else if (numbers.length <= 4) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1);
      } else if (numbers.length <= 7) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4);
      } else if (numbers.length <= 9) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4, 7) + '-' + numbers.slice(7);
      } else {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4, 7) + '-' + numbers.slice(7, 9) + '-' + numbers.slice(9, 11);
      }
    }

    // === –¢–ï–ú–ê TELEGRAM ===
    function applyTelegramTheme() {
      try {
        if (tg && tg.themeParams) {
          document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
          document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
          document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
          document.body.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#0088cc');
          document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
          document.body.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
          document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f3f4');
        }
      } catch (e) {
        console.log('Telegram WebApp not available:', e);
      }
    }

    // === –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í –°–û–ë–´–¢–ò–ô ===
    function setupEventHandlers() {
      try {
        var customAmountInput = document.getElementById('customAmount');
        if (customAmountInput) {
          customAmountInput.addEventListener('input', function() {
            var value = this.value.replace(/\s/g, '');
            selectedAmount = parseFloat(value) || 0;
            updateFinalAmount();
          });
        }

        var withdrawAmountInput = document.getElementById('withdrawAmount');
        if (withdrawAmountInput) {
          withdrawAmountInput.addEventListener('input', function() {
            updateFinalAmount();
          });
        }

        var phoneInput = document.getElementById('phoneNumber');
        if (phoneInput) {
          phoneInput.addEventListener('input', function(e) {
            e.target.value = formatPhoneNumber(e.target.value);
          });
        }
      } catch (e) {
        console.error('Error in setupEventHandlers:', e);
      }
    }

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –û–ö–ù–ê ===
    window.addEventListener('beforeunload', function () {
      syncBalanceToServer();
    });

    window.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        console.log('üëÄ Page is hidden, syncing...');
        syncBalanceToServer();
      } else {
        console.log('üëÄ Page became visible, syncing...');
        performReliableSync().catch(e => console.error('Visibility sync failed:', e));
        if (currentBalance > 0) {
          calculateMissedInterest();
        }
      }
    });

    // === –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ===
    console.log('Script loaded, starting initialization...');
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
