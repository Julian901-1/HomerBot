<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Кошелёк</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--tg-theme-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
            padding: 0 16px;
        }

        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
            z-index: 1000;
        }

        /* Меню вкладок */
        .tabs-menu {
            display: flex;
            background: var(--tg-theme-bg-color, #fff);
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            margin: 0 -16px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 16px;
            font-size: 16px;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #999);
            position: relative;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--tg-theme-link-color, #0088cc);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--tg-theme-link-color, #0088cc);
        }

        /* Главная страница */
        .main-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .balance-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
        }

        .balance-label {
            font-size: 18px;
            opacity: 0.6;
            margin-bottom: 16px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .balance-currency {
            font-size: 20px;
            opacity: 0.6;
            margin-bottom: 40px;
        }

        .buttons-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-deposit {
            background: linear-gradient(135deg, #0088cc, #006bb3, #4da6d9);
            color: white;
        }

        .btn-withdraw {
            background: linear-gradient(135deg, #2196F3, #1976D2, #64B5F6);
            color: white;
        }

        .current-strategy {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 16px;
            margin: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .current-strategy:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .current-strategy-label {
            font-size: 14px;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .current-strategy-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-link-color, #0088cc);
        }

        .terms-link {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #999);
            text-align: center;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .terms-link a {
            color: var(--tg-theme-link-color, #0088cc);
            text-decoration: none;
        }

        /* Страницы депозита и вывода */
        .page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .page.active {
            display: flex;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            background: var(--tg-theme-bg-color, #fff);
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-link-color, #0088cc);
            margin-right: 16px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 500;
        }

        .content {
            flex: 1;
            padding: 24px 20px;
            overflow-y: auto;
        }

        .amount-selector {
            margin-bottom: 32px;
        }

        .amount-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000);
        }

        .amount-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .amount-btn {
            background: var(--tg-theme-secondary-bg-color, #f1f3f4);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 16px 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--tg-theme-text-color, #000);
        }

        .amount-btn.selected {
            border-color: var(--tg-theme-link-color, #0088cc);
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-link-color, #0088cc);
        }

        .custom-amount {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }

        .custom-amount:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #0088cc);
        }

        .payment-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .payment-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .payment-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .payment-label {
            opacity: 0.6;
        }

        .payment-value {
            font-weight: 500;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn {
            background: var(--tg-theme-link-color, #0088cc);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .instructions-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #856404;
        }

        .instructions-text {
            font-size: 14px;
            line-height: 1.4;
            color: #856404;
        }

        /* Страница "Как это работает" */
        .info-page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 60px);
            padding: 24px 20px;
        }

        .info-page.active {
            display: flex;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .info-text {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 30px;
            flex: 1;
        }

        .strategy-selector {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .strategy-selector.highlighted {
            position: relative;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 136, 204, 0.5);
        }

        .strategy-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .strategy-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strategy-option:hover {
            transform: translateX(4px);
        }

        .strategy-left {
            display: flex;
            align-items: center;
        }

        .strategy-bonus {
            font-size: 12px;
            color: var(--tg-theme-link-color, #0088cc);
            font-weight: 600;
        }

        .strategy-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }

        .strategy-radio.selected {
            border-color: var(--tg-theme-link-color, #0088cc);
        }

        .strategy-radio.selected::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--tg-theme-link-color, #0088cc);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .strategy-info {
            flex: 1;
        }

        .strategy-name {
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--tg-theme-text-color, #000);
        }

        .strategy-desc {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
        }

        .strategy-rate {
            font-size: 11px;
            color: var(--tg-theme-link-color, #0088cc);
            font-weight: 500;
            margin-top: 2px;
        }

        .highlight-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .highlight-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Pop-up уведомление */
        .popup-notification {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            max-width: 90%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }

        .popup-notification.show {
            top: 20px;
            opacity: 1;
        }

        .popup-notification.error {
            background: #f44336;
        }

        .popup-notification.info {
            background: #2196F3;
        }

        /* Модальное окно */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #fff);
            padding: 24px;
            border-radius: 16px;
            margin: 20px;
            text-align: center;
            max-width: 300px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .modal-btn {
            background: var(--tg-theme-link-color, #0088cc);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .centered-btn {
            margin: 0 auto;
            width: fit-content;
            padding: 18px 32px;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            margin: 16px auto 0;
            padding: 14px 24px;
        }
    </style>
</head>
<body>
    
    <!-- Версия приложения -->
    <div class="version">28.1-qwen</div>

    <!-- Pop-up уведомление -->
    <div id="popupNotification" class="popup-notification"></div>

    <div class="container">
        <!-- Меню вкладок -->
        <div class="tabs-menu">
            <button class="tab-btn active" onclick="showTab('main')">Кошелек</button>
            <button class="tab-btn" onclick="showTab('info')">Как работает</button>
        </div>

        <!-- Главная страница -->
        <div id="mainTab" class="main-page">
            <div class="balance-section">
                <div id="greeting" class="balance-label" style="margin-bottom: 24px; font-size: 16px;">Добро пожаловать!</div>
                <div class="balance-label">Баланс:</div>
                <div class="balance-amount" id="balanceAmount">0.00</div>
                <div class="balance-currency">✧</div>
            </div>
            
            <div class="buttons-section">
                <button class="btn btn-deposit" onclick="showDepositPage()">
                    Пополнить
                </button>
                <button class="btn btn-withdraw" onclick="showWithdrawPage()">
                    Вывести
                </button>
                
                <!-- Кнопка принудительной синхронизации -->
                <button class="btn centered-btn" onclick="forceBalanceSync()" style="background: #6c757d; margin-top: 10px;">
                    🔄 Обновить баланс
                </button>
                
                <!-- Диагностика синхронизации -->
                <button class="btn centered-btn" onclick="runSyncDiagnostics()" style="background: #17a2b8; margin-top: 5px;">
                    🔍 ДИАГНОСТИКА: Проверка синхронизации
                </button>
            </div>

            <div class="current-strategy" id="currentStrategy" onclick="showStrategyPage()">
                <div class="current-strategy-label">Ваша текущая стратегия:</div>
                <div class="current-strategy-name" id="currentStrategyName">Стандартная</div>
            </div>

            <div class="terms-link">
                Пользуясь приложением вы подтверждаете<br>
                <a href="https://docs.google.com/document/d/1LYWcZc49Lh84t-jEH8MDc5NvYfLBqQM7KvNG7Vybgrs/edit?usp=sharing" target="_blank">условия пользования</a>
            </div>
        </div>

        <!-- Страница "Как это работает" -->
        <div id="infoTab" class="info-page">
            <div class="highlight-overlay" id="highlightOverlay"></div>
            <div class="info-title">Как это работает:</div>
            <div class="info-text">
                <strong>Надёжная основа:</strong> Мы создали для вас максимально безопасное решение. Ваш депозит размещается в банках, застрахованных АСВ, а вы в режиме реального времени видите, как копится доход. Идеальный баланс надёжности и прибыли.
                
                <br><br><strong>Расширьте границы доходности:</strong> Готовы на большее? Подключите опцию с повышенной ставкой. Мы диверсифицируем ваши вложения в высокодоходные инструменты, такие как ЦФЗ от лидеров рынка (Альфа-Банк / Озон-Банк), где каждая возможность тщательно отобрана для оптимального соотношения риска и доходности.
            </div>

            <div class="strategy-selector" id="strategySelector">
                <div class="strategy-title">Выберите стратегию:</div>
                
                <div class="strategy-option" onclick="selectStrategy('standard')">
                    <div class="strategy-left">
                        <div class="strategy-radio selected" id="standardRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">Стандартная</div>
                            <div class="strategy-desc">Банковские вклады под лучший %</div>
                            <div class="strategy-rate">Текущий курс: 16% годовых</div>
                        </div>
                    </div>
                </div>

                <div class="strategy-option balanced" onclick="selectStrategy('balanced')">
                    <div class="strategy-left">
                        <div class="strategy-radio" id="balancedRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">Сбалансированная</div>
                            <div class="strategy-desc">50% Банковские вклады, 50% ЦФЗ/Займы</div>
                            <div class="strategy-rate">Текущий курс: 17,5% годовых</div>
                        </div>
                    </div>
                    <div class="strategy-bonus">+1,5%</div>
                </div>

                <div class="strategy-option" onclick="selectStrategy('aggressive')">
                    <div class="strategy-left">
                        <div class="strategy-radio" id="aggressiveRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">Агрессивная</div>
                            <div class="strategy-desc">Займы, ЦФЗ, Акции</div>
                            <div class="strategy-rate">Текущий курс: 18,5% годовых</div>
                        </div>
                    </div>
                    <div class="strategy-bonus">+2,5%</div>
                </div>
            </div>
        </div>

        <!-- Страница пополнения -->
        <div id="depositPage" class="page">
            <div class="header">
                <button class="back-btn" onclick="showMainPage()">‹</button>
                <div class="header-title">Пополнение</div>
            </div>
            
            <div class="content">
                <div class="amount-selector">
                    <div class="amount-title">Выберите сумму</div>
                    <div class="amount-grid">
                        <button class="amount-btn" onclick="selectAmount(500)">500 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(1000)">1 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(2000)">2 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(5000)">5 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(10000)">10 000 ✧</button>
                        <button class="amount-btn" onclick="selectAmount(25000)">25 000 ✧</button>
                    </div>
                    <input type="text" class="custom-amount" id="customAmount" placeholder="Или введите свою сумму (макс. 100млн)" maxlength="20">
                </div>

                <div class="payment-info" id="paymentInfo" style="display: none;">
                    <div class="payment-title">Реквизиты для перевода</div>
                    <div class="payment-details">
                        <div class="payment-row">
                            <span class="payment-label">Номер телефона:</span>
                            <div class="payment-value">
                                +7 (916) 643-54-94
                                <button class="copy-btn" onclick="copyToClipboard('+79166435494')">📋</button>
                            </div>
                        </div>
                        <div class="payment-row">
                            <span class="payment-label">Сумма:</span>
                            <span class="payment-value" id="paymentAmount">0 ✧</span>
                        </div>
                        <div class="payment-row">
                            <span class="payment-label">Комментарий:</span>
                            <div class="payment-value">
                                <span id="paymentComment">DEP123456</span>
                                <button class="copy-btn" onclick="copyToClipboard(getCommentText())">📋</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="instructions" id="paymentInstructions" style="display: none;">
                    <div class="instructions-title">Как пополнить:</div>
                    <div class="instructions-text">
                        1. Откройте банковское приложение<br>
                        2. Выберите "Перевод по номеру телефона" или "СБП"<br>
                        3. Введите номер телефона и сумму<br>
                        4. Обязательно укажите комментарий для автоматического зачисления<br>
                        5. Средства поступят на баланс в течение 5 минут
                    </div>
                </div>

                <div id="paymentTimer" style="display: none; text-align: center; margin-top: 16px; font-size: 14px; color: #ff6b6b;">
                    Время на оплату: <span id="timerDisplay">5:00</span>
                </div>

                <button class="btn centered-btn" id="generatePaymentBtn" onclick="generatePayment()">
                    Пополнить баланс
                </button>

                <button class="btn centered-btn cancel-btn" id="cancelPaymentBtn" onclick="cancelPayment()" style="display: none;">
                    Отмена пополнения
                </button>
            </div>
        </div>

        <!-- Страница вывода -->
        <div id="withdrawPage" class="page">
            <div class="header">
                <button class="back-btn" onclick="showMainPage()">‹</button>
                <div class="header-title">Вывод средств</div>
            </div>
            
            <div class="content">
                <div class="amount-selector">
                    <div class="amount-title">Сумма вывода</div>
                    <input type="text" class="custom-amount" id="withdrawAmount" placeholder="Введите сумму" maxlength="20">
                </div>

                <div class="amount-selector">
                    <div class="amount-title">Номер телефона для перевода</div>
                    <input type="tel" class="custom-amount" id="withdrawPhone" placeholder="+7 (999) 123-45-67" maxlength="18">
                </div>

                <div class="instructions">
                    <div class="instructions-title">Условия вывода:</div>
                    <div class="instructions-text">
                        • Минимальная сумма: 100 ✧<br>
                        • Время обработки: до 48 часов<br>
                        • Комиссия: 0,5%
                    </div>
                </div>

                <button class="btn btn-withdraw centered-btn" onclick="processWithdraw()">
                    Создать заявку на вывод
                </button>
            </div>
        </div>

        <!-- Модальное окно -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-title">Новая стратегия будет применена в течение суток</div>
                <button class="modal-btn" onclick="hideModal()">Понятно</button>
            </div>
        </div>
    </div>

  <script>
    // Инициализация Telegram WebApp
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      console.log('Telegram WebApp initialized');
    } else {
      console.log('Not in Telegram environment - using test data');
    }

    // === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===
    var currentBalance = 0;
    var selectedAmount = 0;
    var currentStrategy = 'standard';
    var tg = null;
    var paymentTimer = null;
    var currentTransactionId = null;
    var currentPaymentAmount = 0;
    var interestTimer = null;
    var lastUpdateTime = null;
    var currentTelegramMessageId = null;

    // Константы для Telegram бота
    var BOT_TOKEN = '7631840452:AAH4O93qQ6J914x5FhPTQX7YhJC3bTiJ_XA';
    var CHAT_ID = '487525838';

    // URL Google Apps Script
    var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_tTk4wa8xwNP3JlwFoZRAV9XyCGxEZR9t5WeYEoSsylCktVblQlD30i_fcsosnV9i-g/exec';

    // Настройки процентных ставок
    var INTEREST_RATES = {
      standard: 0.0005,
      balanced: 0.0007,
      aggressive: 0.0010
    };

    // Настройки синхронизации
    var SYNC_CONFIG = {
      maxRetries: 3,
      retryDelayMs: 2000,
      timeoutMs: 10000,
      syncIntervalMs: 30000
    };

    // === ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ===
    function initApp() {
      try {
        console.log('initApp called with improved sync');
        tg = window.Telegram ? window.Telegram.WebApp : null;
        applyTelegramTheme();
        updateGreeting();
        loadBalance();
        showTab('main');
        startImprovedSync();
        setupEventHandlers();
        console.log('✅ App initialized successfully with improved sync');
      } catch (e) {
        console.error('❌ Error in initApp:', e);
        showNotification('Ошибка инициализации. Некоторые функции могут не работать.', 'error', 5000);
      }
    }

    // === УЛУЧШЕННАЯ СИНХРОНИЗАЦИЯ ===
    function startImprovedSync() {
      console.log('🚀 Starting improved synchronization system...');
      // Запускаем синхронизацию при инициализации
      performReliableSync().catch(e => console.error('Initial sync failed:', e));

      // Планируем периодическую синхронизацию
      setInterval(function () {
        console.log('⏰ Scheduled sync triggered');
        performReliableSync().catch(e => console.error('Scheduled sync failed:', e));
      }, SYNC_CONFIG.syncIntervalMs);
    }

    // === НАДЕЖНАЯ СИНХРОНИЗАЦИЯ С ПОВТОРАМИ ===
    function performReliableSync() {
      console.log('🚀 Starting reliable sync process...');
      return new Promise(function (resolve, reject) {
        let attempt = 1;

        function doAttempt() {
          console.log(`🔄 Sync attempt ${attempt} of ${SYNC_CONFIG.maxRetries}`);
          performJsonpSync()
            .then(function (result) {
              console.log('✅ Sync successful on attempt', attempt);
              resolve(result);
            })
            .catch(function (error) {
              console.log(`❌ Sync attempt ${attempt} failed:`, error.message || error);
              attempt++;
              if (attempt <= SYNC_CONFIG.maxRetries) {
                console.log(`⏳ Retrying in ${SYNC_CONFIG.retryDelayMs} ms...`);
                setTimeout(doAttempt, SYNC_CONFIG.retryDelayMs);
              } else {
                console.log('💥 All sync attempts failed');
                // Fallback: Пробуем Image Pixel Sync
                attemptImagePixelSync()
                  .then(resolve)
                  .catch(reject);
              }
            });
        }

        doAttempt();
      });
    }

    // === ОСНОВНАЯ СИНХРОНИЗАЦИЯ ЧЕРЕЗ JSONP ===
    function performJsonpSync() {
      return new Promise(function (resolve, reject) {
        console.log('🌐 Attempting JSONP sync...');
        var username = getUserName();
        var callbackName = 'sync_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        var script, timeoutId;

        function cleanup() {
          clearTimeout(timeoutId);
          if (window[callbackName]) {
            delete window[callbackName];
          }
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        function complete(success, data) {
          cleanup();
          if (success) {
            resolve(data);
          } else {
            reject(new Error(data || 'JSONP request failed'));
          }
        }

        timeoutId = setTimeout(function () {
          console.log('⏰ JSONP timeout after', SYNC_CONFIG.timeoutMs, 'ms');
          complete(false, 'JSONP timeout');
        }, SYNC_CONFIG.timeoutMs);

        window[callbackName] = function (data) {
          console.log('✅ JSONP success! Received:', data);
          try {
            var processResult = processServerData(data);
            complete(true, { success: true, data: data, processed: processResult });
          } catch (error) {
            console.error('❌ Error processing JSONP data:', error);
            complete(false, 'Error processing data: ' + error.message);
          }
        };

        script = document.createElement('script');
        script.id = callbackName;
        script.type = 'text/javascript';
        script.onerror = function (error) {
          console.log('❌ JSONP script failed to load:', error);
          complete(false, 'Script load error');
        };

        // Передаем текущий баланс и стратегию для синхронизации
        var url = SCRIPT_URL +
          '?action=getBalance' +
          '&username=' + encodeURIComponent(username) +
          '&currentBalance=' + encodeURIComponent(currentBalance) +
          '&strategy=' + encodeURIComponent(currentStrategy) +
          '&callback=' + callbackName +
          '&t=' + Date.now();

        console.log('🌐 JSONP request URL:', url.substring(0, 150) + '...');
        script.src = url;
        document.head.appendChild(script);
      });
    }

    // === РЕЗЕРВНЫЙ МЕТОД СИНХРОНИЗАЦИИ: Image Pixel ===
    function attemptImagePixelSync() {
      return new Promise(function (resolve, reject) {
        console.log('🖼️ Attempting image pixel sync fallback...');
        var username = getUserName();
        var img = new Image();
        var completed = false;

        function cleanup() {
          if (completed) return;
          completed = true;
          img.onload = null;
          img.onerror = null;
          // Удаляем элемент из DOM, если он был добавлен (обычно нет, но на всякий)
          if (img.parentNode) img.parentNode.removeChild(img);
        }

        img.onload = function () {
          console.log('✅ Image pixel sync successful (image loaded)');
          cleanup();
          // Image Pixel не возвращает данных, просто сигнализирует об успехе.
          // Мы можем попробовать снова получить баланс через JSONP после этого.
          performJsonpSync().then(resolve).catch(function(err) {
              // Если JSONP после Image Pixel тоже не удался, всё равно считаем Image Pixel успешным
              console.log('⚠️ Image pixel sync OK, but follow-up JSONP failed:', err);
              resolve({ success: true, message: "Image pixel sync OK, data fetch failed" });
          });
        };

        img.onerror = function (error) {
          console.log('❌ Image pixel sync failed (image error):', error);
          cleanup();
          reject(new Error('Image pixel sync failed'));
        };

        // URL для Image Pixel Sync (новый action)
        var url = SCRIPT_URL +
          '?action=imagePixelSync' + // Новый action
          '&username=' + encodeURIComponent(username) +
          '&currentBalance=' + encodeURIComponent(currentBalance) +
          '&strategy=' + encodeURIComponent(currentStrategy) +
          '&t=' + Date.now();

        console.log('🖼️ Image pixel URL:', url.substring(0, 150) + '...');
        img.src = url;
        // Не добавляем img в DOM, так как он невидим и не нужен для отображения
      });
    }


    // === ОБРАБОТКА ДАННЫХ С СЕРВЕРА ===
    function processServerData(data) {
      try {
        console.log('📥 Processing server data:', data);
        if (!data || !data.success) {
          console.log('⚠️ Server returned error or not success:', data);
          return { processed: false, reason: 'Server error or not success' };
        }

        if (data.action === 'getBalance' && data.username) {
          console.log('🔄 Updating local data from server...');
          currentBalance = parseFloat(data.balance) || 0;
          currentStrategy = data.strategy || 'standard';
          lastUpdateTime = new Date(data.timestamp) || new Date();
          saveBalance();
          updateBalanceDisplay();
          updateCurrentStrategyDisplay();
          startInterestAccrual();
          console.log('✅ Local data updated from server');
          return { processed: true, updated: true };
        } else if (data.action === 'updateBalance') {
          console.log('✅ Server confirmed balance update');
          // Данные уже должны быть обновлены через getBalance, это просто подтверждение
          return { processed: true, updated: false };
        } else {
          console.log('ℹ️ Server data processed, no balance update needed');
          return { processed: true, updated: false };
        }
      } catch (e) {
        console.error('❌ Error processing server data:', e);
        return { processed: false, error: e.message };
      }
    }

    // === ПРИНУДИТЕЛЬНАЯ СИНХРОНИЗАЦИЯ ===
    function forceBalanceSync() {
      console.log('🔄 User requested force sync');
      showNotification('🔄 Выполняется принудительная синхронизация...', 'info');
      return performReliableSync().then(function (result) {
        if (result.success) {
          showNotification('✅ Синхронизация завершена успешно!', 'success');
        } else {
          showNotification('⚠️ Синхронизация завершена с предупреждениями', 'info');
        }
        return result;
      }).catch(function (error) {
        console.error('❌ Force sync failed:', error);
        showNotification('❌ Ошибка синхронизации: ' + error.message, 'error');
        throw error;
      });
    }

    // === СИНХРОНИЗАЦИЯ БАЛАНСА НА СЕРВЕР ===
    function syncBalanceToServer() {
      console.log('📤 Uploading balance to server...');
      var username = getUserName();
      if (!username || username === '@test_user') {
        console.log('⚠️ Skipping sync for test user');
        return Promise.resolve();
      }

      // Используем Image Pixel для отправки данных (как fallback)
      return new Promise(function (resolve, reject) {
        console.log('🖼️ Uploading via image pixel...');
        var img = new Image();
        var completed = false;

        function cleanup() {
          if (completed) return;
          completed = true;
          img.onload = null;
          img.onerror = null;
        }

        img.onload = function () {
          console.log('✅ Balance upload via image pixel successful');
          cleanup();
          resolve({ success: true });
        };

        img.onerror = function (error) {
          console.log('❌ Balance upload via image pixel failed:', error);
          cleanup();
          // Даже если Image Pixel не удался, не считаем это критической ошибкой для пользователя
          resolve({ success: false, message: "Image pixel upload failed" });
        };

        var url = SCRIPT_URL +
          '?action=updateBalance' + // Используем существующий action
          '&username=' + encodeURIComponent(username) +
          '&balance=' + encodeURIComponent(currentBalance) +
          '&strategy=' + encodeURIComponent(currentStrategy) +
          '&t=' + Date.now();

        console.log('🖼️ Upload URL:', url.substring(0, 150) + '...');
        img.src = url;
      });
    }

    // === ДИАГНОСТИКА СИНХРОНИЗАЦИИ ===
    function runSyncDiagnostics() {
      console.log('🔍 Running sync diagnostics...');
      showNotification('🔍 Запуск диагностики...', 'info');

      diagnoseSyncIssues().then(function (serverReachable) {
        return performReliableSync();
      }).then(function (result) {
        const message = result.success ?
          '✅ Диагностика пройдена. Синхронизация работает.' :
          '⚠️ Обнаружены проблемы с синхронизацией.';
        showNotification(message, result.success ? 'success' : 'error');
        console.log('📊 Diagnostic Results:', { syncResult: result, currentBalance: currentBalance, currentStrategy: currentStrategy });
      }).catch(function (error) {
        console.error('❌ Diagnostics failed:', error);
        showNotification('❌ Ошибка диагностики: ' + error.message, 'error');
      });
    }

    function diagnoseSyncIssues() {
      console.log('🔍 Diagnosing server reachability...');
      console.log('- Current balance:', currentBalance);
      console.log('- Current strategy:', currentStrategy);
      console.log('- Username:', getUserName());

      var testUrl = SCRIPT_URL + '?action=test&t=' + Date.now();
      return fetch(testUrl, { method: 'GET', cache: 'no-cache' })
        .then(function (response) {
           console.log('✅ Server test request status:', response.status);
           if(response.ok) {
               return response.json().then(data => {
                   console.log('✅ Server test response data:', data);
                   return true;
               }).catch(e => {
                   console.warn('⚠️ Server responded OK but JSON parse failed:', e);
                   return true; // Считаем сервер доступным, даже если JSON кривой
               });
           } else {
               console.log('❌ Server test request failed with status:', response.status);
               return false;
           }
        })
        .catch(function (error) {
          console.log('❌ Server unreachable:', error.message);
          return false;
        });
    }

    function getUserName() {
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        var user = tg.initDataUnsafe.user;
        return user.username ? '@' + user.username : 'user_' + user.id;
      }
      return '@test_user';
    }

    // === ГЕНЕРАЦИЯ ПЛАТЕЖА ===
    function generatePayment(amount) {
      try {
        if (!amount || amount <= 0) {
          showNotification('❌ Некорректная сумма', 'error');
          return;
        }

        selectedAmount = amount;
        var transactionId = 'TX_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
        currentTransactionId = transactionId;
        currentPaymentAmount = amount;

        showNotification('✅ Заявка на пополнение создана! После поступления средств баланс будет обновлён автоматически.');
        startPaymentTimer();
        sendTelegramNotification(amount, transactionId);

        var paymentCheckInterval = setInterval(function () {
          checkPaymentConfirmation();
        }, 5000);
        window.currentPaymentCheckInterval = paymentCheckInterval;

      } catch (e) {
        console.error('Error in generatePayment:', e);
      }
    }

    // === ПРОВЕРКА СТАТУСА ПЛАТЕЖА ===
    function checkPaymentConfirmation() {
      if (!currentTransactionId) return;

      var checkUrl = SCRIPT_URL + '?action=checkPayment&transactionId=' + encodeURIComponent(currentTransactionId) + '&t=' + Date.now();
      fetch(checkUrl, { method: 'GET' })
        .then(function (response) { return response.json(); })
        .then(function (data) {
          console.log('Payment check result:', data);
          if (data.confirmed) {
            showNotification('✅ Платеж подтвержден! Баланс пополнен.', 'success');
            currentBalance += currentPaymentAmount;
            saveBalance();
            updateBalanceDisplay();
            clearInterval(window.currentPaymentCheckInterval);
            clearPaymentTimer();
            currentTransactionId = null;
            currentPaymentAmount = 0;
            currentTelegramMessageId = null;
            syncBalanceToServer(); // Синхронизируем обновленный баланс
          } else if (data.rejected) {
            showNotification('❌ Платеж отклонен администратором. Попробуйте еще раз.', 'error');
            cancelPayment();
          }
        }).catch(function (error) {
          console.error('Error checking payment:', error);
        });
    }

    // === УВЕДОМЛЕНИЯ TELEGRAM ===
    function sendTelegramNotification(amount, transactionId) {
      var userId = getUserName();
      var message = '💰 Новая заявка на пополнение\nПользователь: ' + userId + '\nСумма: ' + formatNumber(amount.toString()) + ' ⚡\nКомментарий: ' + transactionId + '\nПодтверждаете перевод?';

      console.log('Sending deposit notification:', message);

      var getUrl = SCRIPT_URL + '?action=sendNotification&' +
        'type=deposit&' +
        'userId=' + encodeURIComponent(userId) +
        '&amount=' + encodeURIComponent(amount) +
        '&transactionId=' + encodeURIComponent(transactionId) +
        '&message=' + encodeURIComponent(message) +
        '&timestamp=' + Date.now();

      console.log('🌐 Отправляем GET запрос:', getUrl.substring(0, 200) + '...');

      fetch(getUrl, { method: 'GET' })
        .then(function (response) {
          console.log('📋 Response status:', response.status);
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function (result) {
          console.log('✅ Parsed JSON result:', result);
          if (result.success && result.messageId) {
            currentTelegramMessageId = result.messageId;
            console.log('✅ Уведомление отправлено через Google Apps Script, messageId:', result.messageId);
            showNotification('✅ Заявка создана! Ожидайте подтверждения.');
          } else {
             console.warn('⚠️ Notification sent, but no messageId received or not successful:', result);
             showNotification('⚠️ Заявка создана, но возможны задержки уведомления.', 'info');
          }
        })
        .catch(function (error) {
          console.error('❌ Error sending Telegram notification:', error);
          showNotification('⚠️ Заявка создана локально, уведомления могут задерживаться.', 'info');
        });
    }

    function sendStrategyChangeNotification(strategy) {
      var strategyNames = { standard: 'Стандартная', balanced: 'Сбалансированная', aggressive: 'Агрессивная' };
      var userId = getUserName();
      var message = '🔄 Пользователь ' + userId + ' сменил стратегию на "' + strategyNames[strategy] + '"';

      console.log('Sending strategy notification:', message);

      var getUrl = SCRIPT_URL + '?action=sendNotification&' +
        'type=strategy_change&' +
        'userId=' + encodeURIComponent(userId) +
        '&strategy=' + encodeURIComponent(strategy) +
        '&message=' + encodeURIComponent(message) +
        '&timestamp=' + Date.now();

      console.log('Sending strategy notification via GET:', getUrl);

      fetch(getUrl, { method: 'GET' })
        .then(function (response) {
          console.log('Strategy notification response status:', response.status);
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function (result) {
          console.log('Strategy notification result:', result);
          if (result.success) {
            console.log('✅ Strategy change notification sent');
          } else {
            console.warn('⚠️ Strategy change notification not successful:', result);
          }
        })
        .catch(function (error) {
          console.error('Error sending strategy notification:', error);
        });
    }

    function sendWithdrawalRequest(amount, phone) {
      if (!amount || amount <= 0 || !phone) {
        showNotification('❌ Укажите корректные данные для вывода', 'error');
        return;
      }

      var commission = amount * 0.05;
      var finalAmount = amount - commission;
      var userId = getUserName();
      var message = '📤 Новая заявка на вывод\nПользователь: ' + userId + '\nСумма: ' + formatNumber(amount.toFixed(2)) + ' ✧\nТелефон: ' + phone + '\nКомиссия (5%): ' + formatNumber(commission.toFixed(2)) + ' ✧\nК выводу: ' + formatNumber(finalAmount.toFixed(2)) + ' ✧';

      console.log('Sending withdraw notification:', message);

      var getUrl = SCRIPT_URL + '?action=sendNotification&' +
        'type=withdraw&' +
        'userId=' + encodeURIComponent(userId) +
        '&amount=' + encodeURIComponent(amount) +
        '&phone=' + encodeURIComponent(phone) +
        '&commission=' + encodeURIComponent(commission) +
        '&finalAmount=' + encodeURIComponent(finalAmount) +
        '&message=' + encodeURIComponent(message) +
        '&timestamp=' + Date.now();

      console.log('Sending withdraw notification via GET:', getUrl);

      fetch(getUrl, { method: 'GET' })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(function (result) {
          console.log('Withdraw notification result:', result);
          if (result.success) {
            showNotification('✅ Заявка на вывод отправлена!');
          } else {
            showNotification('⚠️ Возникла ошибка при отправке заявки.', 'error');
          }
        })
        .catch(function (error) {
          console.error('Error sending withdraw notification:', error);
          showNotification('❌ Ошибка отправки заявки. Попробуйте позже.', 'error');
        });
    }

    // === ОТМЕНА ПЛАТЕЖА ===
    function cancelPayment() {
      try {
        console.log('🚫 Cancelling payment...');
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        if (paymentInfo) paymentInfo.style.display = 'none';
        if (paymentInstructions) paymentInstructions.style.display = 'none';

        clearInterval(window.currentPaymentCheckInterval);
        clearPaymentTimer();

        if (currentTelegramMessageId) {
          deleteTelegramMessage(currentTelegramMessageId);
          currentTelegramMessageId = null;
        }

        // Уведомляем сервер об отмене
        var cancelUrl = SCRIPT_URL + '?action=cancelPayment&' +
          'transactionId=' + encodeURIComponent(currentTransactionId) +
          '&messageId=' + encodeURIComponent(currentTelegramMessageId || '') +
          '&timestamp=' + Date.now();

        fetch(cancelUrl, { method: 'GET' })
          .then(function (response) {
            console.log('Cancel notification sent, status:', response.status);
          })
          .catch(function (error) {
            console.error('Error sending cancel notification:', error);
          });

        selectedAmount = 0;
        currentTransactionId = null;
        currentPaymentAmount = 0;
        currentTelegramMessageId = null;
        console.log('✅ Платеж отменен локально');
      } catch (e) {
        console.error('Error in cancelPayment:', e);
      }
    }

    function deleteTelegramMessage(messageId) {
      if (!messageId) return;
      var data = {
        chat_id: CHAT_ID,
        message_id: messageId
      };
      fetch('https://api.telegram.org/bot' + BOT_TOKEN + '/deleteMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(function (response) {
        return response.json();
      }).then(function (data) {
        console.log('Message deleted:', data);
      }).catch(function (error) {
        console.error('Error deleting message:', error);
      });
    }

    // === ЗАГРУЗКА И СОХРАНЕНИЕ ДАННЫХ ===
    function loadBalance() {
      try {
        var savedBalance = localStorage.getItem('wallet_balance') || '0';
        currentBalance = parseFloat(savedBalance);
        var savedStrategy = localStorage.getItem('wallet_strategy') || 'standard';
        currentStrategy = savedStrategy;
        updateBalanceDisplay();
        updateCurrentStrategyDisplay();
        startInterestAccrual();
        console.log('💾 Loaded balance from localStorage:', currentBalance, currentStrategy);
      } catch (e) {
        console.error('Error loading balance:', e);
      }
    }

    function saveBalance() {
      try {
        localStorage.setItem('wallet_balance', currentBalance.toString());
        localStorage.setItem('wallet_strategy', currentStrategy);
        console.log('💾 Balance saved to localStorage:', currentBalance, currentStrategy);
      } catch (e) {
        console.error('Error saving balance:', e);
      }
    }

    // ... (остальные функции без изменений: updateBalanceDisplay, formatNumber, showTab, showDepositPage, selectAmount, selectStrategy, updateGreeting, showNotification, startPaymentTimer, clearPaymentTimer, paymentTimeout, applyTelegramTheme, setupEventHandlers, calculateMissedInterest, startInterestAccrual, updateCurrentStrategyDisplay, showModal, hideModal, copyToClipboard) ...

    // === ОБРАБОТЧИКИ СОБЫТИЙ ОКНА ===
    window.addEventListener('beforeunload', function () {
      syncBalanceToServer();
    });

    window.addEventListener('visibilitychange', function () {
      if (document.hidden) {
        console.log('👀 Page is hidden, syncing...');
        syncBalanceToServer();
      } else {
        console.log('👀 Page became visible, syncing...');
        performReliableSync().catch(e => console.error('Visibility sync failed:', e));
        if (currentBalance > 0) {
          calculateMissedInterest();
        }
      }
    });

    // === ЗАПУСК ПРИЛОЖЕНИЯ ===
    console.log('Script loaded, starting initialization...');
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
