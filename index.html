<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ—à–µ–ª—ë–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: var(--tg-theme-bg-color, #f8f9fa);
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            position: relative;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
            padding: 0 16px;
        }

        .version {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            color: #999;
            z-index: 1000;
        }

        /* –ú–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫ */
        .tabs-menu {
            display: flex;
            background: var(--tg-theme-bg-color, #fff);
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            margin: 0 -16px;
        }

        .tab-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 16px;
            font-size: 16px;
            cursor: pointer;
            color: var(--tg-theme-hint-color, #999);
            position: relative;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: var(--tg-theme-link-color, #0088cc);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--tg-theme-link-color, #0088cc);
        }

        /* –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ */
        .main-page {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .balance-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
        }

        .balance-label {
            font-size: 18px;
            opacity: 0.6;
            margin-bottom: 16px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 8px;
            letter-spacing: -1px;
        }

        .balance-currency {
            font-size: 20px;
            opacity: 0.6;
            margin-bottom: 40px;
        }

        .buttons-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn {
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-deposit {
            background: linear-gradient(135deg, #0088cc, #006bb3, #4da6d9);
            color: white;
        }

        .btn-withdraw {
            background: linear-gradient(135deg, #2196F3, #1976D2, #64B5F6);
            color: white;
        }

        .current-strategy {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 16px;
            margin: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .current-strategy:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .current-strategy-label {
            font-size: 14px;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .current-strategy-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-link-color, #0088cc);
        }

        .terms-link {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #999);
            text-align: center;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .terms-link a {
            color: var(--tg-theme-link-color, #0088cc);
            text-decoration: none;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ–ø–æ–∑–∏—Ç–∞ –∏ –≤—ã–≤–æ–¥–∞ */
        .page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 60px);
        }

        .page.active {
            display: flex;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            background: var(--tg-theme-bg-color, #fff);
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--tg-theme-link-color, #0088cc);
            margin-right: 16px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 500;
        }

        .content {
            flex: 1;
            padding: 24px 20px;
            overflow-y: auto;
        }

        .amount-selector {
            margin-bottom: 32px;
        }

        .amount-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--tg-theme-text-color, #000);
        }

        .amount-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .amount-btn {
            background: var(--tg-theme-secondary-bg-color, #f1f3f4);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 16px 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--tg-theme-text-color, #000);
        }

        .amount-btn.selected {
            border-color: var(--tg-theme-link-color, #0088cc);
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-link-color, #0088cc);
        }

        .custom-amount {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }

        .custom-amount:focus {
            outline: none;
            border-color: var(--tg-theme-link-color, #0088cc);
        }

        .payment-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .payment-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .payment-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .payment-label {
            opacity: 0.6;
        }

        .payment-value {
            font-weight: 500;
            font-family: monospace;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn {
            background: var(--tg-theme-link-color, #0088cc);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .instructions-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #856404;
        }

        .instructions-text {
            font-size: 14px;
            line-height: 1.4;
            color: #856404;
        }

        /* –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" */
        .info-page {
            display: none;
            flex-direction: column;
            height: calc(100vh - 60px);
            padding: 24px 20px;
        }

        .info-page.active {
            display: flex;
        }

        .info-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .info-text {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 30px;
            flex: 1;
        }

        .strategy-selector {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .strategy-selector.highlighted {
            position: relative;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 136, 204, 0.5);
        }

        .strategy-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .strategy-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strategy-option:hover {
            transform: translateX(4px);
        }

        .strategy-left {
            display: flex;
            align-items: center;
        }

        .strategy-bonus {
            font-size: 12px;
            color: var(--tg-theme-link-color, #0088cc);
            font-weight: 600;
        }

        .strategy-radio {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-theme-hint-color, #ccc);
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }

        .strategy-radio.selected {
            border-color: var(--tg-theme-link-color, #0088cc);
        }

        .strategy-radio.selected::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--tg-theme-link-color, #0088cc);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .strategy-info {
            flex: 1;
        }

.strategy-name {
    font-weight: 500;
    margin-bottom: 4px;
    color: var(--tg-theme-text-color, #000);
}

        .strategy-desc {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
        }

        .strategy-rate {
            font-size: 11px;
            color: var(--tg-theme-link-color, #0088cc);
            font-weight: 500;
            margin-top: 2px;
        }

        .highlight-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .highlight-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Pop-up —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
.popup-notification {
    position: fixed;
    top: -100px;
    left: 50%;
    transform: translateX(-50%);
    background: #4CAF50;
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 1001;
    font-size: 14px;
    font-weight: 500;
    text-align: center;
    max-width: 90%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
}

.popup-notification.show {
    top: 20px;
    opacity: 1;
}

        .popup-notification.error {
            background: #f44336;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color, #fff);
            padding: 24px;
            border-radius: 16px;
            margin: 20px;
            text-align: center;
            max-width: 300px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .modal-btn {
            background: var(--tg-theme-link-color, #0088cc);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 16px;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .centered-btn {
            margin: 0 auto;
            width: fit-content;
            padding: 18px 32px;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
            margin: 16px auto 0;
            padding: 14px 24px;
        }
    </style>
</head>
<body>
	
    <!-- –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div class="version">27.8-debug</div>

    <!-- Pop-up —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="popupNotification" class="popup-notification"></div>

    <div class="container">
        <!-- –ú–µ–Ω—é –≤–∫–ª–∞–¥–æ–∫ -->
        <div class="tabs-menu">
            <button class="tab-btn active" onclick="showTab('main')">–ö–æ—à–µ–ª–µ–∫</button>
            <button class="tab-btn" onclick="showTab('info')">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
        </div>

        <!-- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
        <div id="mainTab" class="main-page">
            <div class="balance-section">
                <div id="greeting" class="balance-label" style="margin-bottom: 24px; font-size: 16px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</div>
                <div class="balance-label">–ë–∞–ª–∞–Ω—Å:</div>
                <div class="balance-amount" id="balanceAmount">0.00</div>
                <div class="balance-currency">‚úß</div>
            </div>
            
            <div class="buttons-section">
                <button class="btn btn-deposit" onclick="showDepositPage()">
                    –ü–æ–ø–æ–ª–Ω–∏—Ç—å
                </button>
                <button class="btn btn-withdraw" onclick="showWithdrawPage()">
                    –í—ã–≤–µ—Å—Ç–∏
                </button>
				<button onclick="forceBalanceSync()" style="background: red; color: white; padding: 10px;">–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø</button>
				<!-- –í —Å–µ–∫—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ: -->
<button class="btn centered-btn" onclick="runSyncDiagnostics()" style="background: #6c757d; margin-top: 10px;">
    üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
</button>

<script>
function runSyncDiagnostics() {
    console.log('üîç Running sync diagnostics...');
    showNotification('üîç –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
    
    diagnoseSyncIssues()
        .then(function(serverReachable) {
            return performReliableSync();
        })
        .then(function(result) {
            const message = result.success ? 
                '‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç.' : 
                '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π.';
            
            showNotification(message, result.success ? 'success' : 'error');
            
            // –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å
            console.log('üìä Diagnostic Results:', {
                syncResult: result,
                currentBalance: currentBalance,
                currentStrategy: currentStrategy,
                syncState: syncState
            });
        })
        .catch(function(error) {
            showNotification('‚ùå –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å: ' + error.message, 'error');
            console.error('‚ùå Diagnostics failed:', error);
        });
}
</script>
            </div>

            <div class="current-strategy" id="currentStrategy" onclick="showStrategyPage()">
                <div class="current-strategy-label">–í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:</div>
                <div class="current-strategy-name" id="currentStrategyName">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</div>
            </div>

            <div class="terms-link">
                –ü–æ–ª—å–∑—É—è—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ<br>
                <a href="https://docs.google.com/document/d/1LYWcZc49Lh84t-jEH8MDc5NvYfLBqQM7KvNG7Vybgrs/edit?usp=sharing" target="_blank">—É—Å–ª–æ–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç" -->
        <div id="infoTab" class="info-page">
            <div class="highlight-overlay" id="highlightOverlay"></div>
            <div class="info-title">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</div>
            <div class="info-text">
                <strong>–ù–∞–¥—ë–∂–Ω–∞—è –æ—Å–Ω–æ–≤–∞:</strong> –ú—ã —Å–æ–∑–¥–∞–ª–∏ –¥–ª—è –≤–∞—Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ. –í–∞—à –¥–µ–ø–æ–∑–∏—Ç —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –±–∞–Ω–∫–∞—Ö, –∑–∞—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–Ω—ã—Ö –ê–°–í, –∞ –≤—ã –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤–∏–¥–∏—Ç–µ, –∫–∞–∫ –∫–æ–ø–∏—Ç—Å—è –¥–æ—Ö–æ–¥. –ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏–±—ã–ª–∏.
                
                <br><br><strong>–†–∞—Å—à–∏—Ä—å—Ç–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏:</strong> –ì–æ—Ç–æ–≤—ã –Ω–∞ –±–æ–ª—å—à–µ–µ? –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –æ–ø—Ü–∏—é —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π. –ú—ã –¥–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –≤–∞—à–∏ –≤–ª–æ–∂–µ–Ω–∏—è –≤ –≤—ã—Å–æ–∫–æ–¥–æ—Ö–æ–¥–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Ç–∞–∫–∏–µ –∫–∞–∫ –¶–§–ó –æ—Ç –ª–∏–¥–µ—Ä–æ–≤ —Ä—ã–Ω–∫–∞ (–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫ / –û–∑–æ–Ω-–ë–∞–Ω–∫), –≥–¥–µ –∫–∞–∂–¥–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ç—â–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–Ω–∞ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Ä–∏—Å–∫–∞ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏.
            </div>

            <div class="strategy-selector" id="strategySelector">
                <div class="strategy-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:</div>
                
                <div class="strategy-option" onclick="selectStrategy('standard')">
                    <div class="strategy-left">
                        <div class="strategy-radio selected" id="standardRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</div>
                            <div class="strategy-desc">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –≤–∫–ª–∞–¥—ã –ø–æ–¥ –ª—É—á—à–∏–π %</div>
                            <div class="strategy-rate">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: 16% –≥–æ–¥–æ–≤—ã—Ö</div>
                        </div>
                    </div>
                </div>

                <div class="strategy-option balanced" onclick="selectStrategy('balanced')">
                    <div class="strategy-left">
                        <div class="strategy-radio" id="balancedRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</div>
                            <div class="strategy-desc">50% –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –≤–∫–ª–∞–¥—ã, 50% –¶–§–ó/–ó–∞–π–º—ã</div>
                            <div class="strategy-rate">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: 17,5% –≥–æ–¥–æ–≤—ã—Ö</div>
                        </div>
                    </div>
                    <div class="strategy-bonus">+1,5%</div>
                </div>

                <div class="strategy-option" onclick="selectStrategy('aggressive')">
                    <div class="strategy-left">
                        <div class="strategy-radio" id="aggressiveRadio"></div>
                        <div class="strategy-info">
                            <div class="strategy-name">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è</div>
                            <div class="strategy-desc">–ó–∞–π–º—ã, –¶–§–ó, –ê–∫—Ü–∏–∏</div>
                            <div class="strategy-rate">–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: 18,5% –≥–æ–¥–æ–≤—ã—Ö</div>
                        </div>
                    </div>
                    <div class="strategy-bonus">+2,5%</div>
                </div>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <div id="depositPage" class="page">
            <div class="header">
                <button class="back-btn" onclick="showMainPage()">‚Äπ</button>
                <div class="header-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
            </div>
            
            <div class="content">
                <div class="amount-selector">
                    <div class="amount-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É</div>
                    <div class="amount-grid">
                        <button class="amount-btn" onclick="selectAmount(500)">500 ‚úß</button>
                        <button class="amount-btn" onclick="selectAmount(1000)">1 000 ‚úß</button>
                        <button class="amount-btn" onclick="selectAmount(2000)">2 000 ‚úß</button>
                        <button class="amount-btn" onclick="selectAmount(5000)">5 000 ‚úß</button>
                        <button class="amount-btn" onclick="selectAmount(10000)">10 000 ‚úß</button>
                        <button class="amount-btn" onclick="selectAmount(25000)">25 000 ‚úß</button>
                    </div>
                    <input type="text" class="custom-amount" id="customAmount" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ—é —Å—É–º–º—É (–º–∞–∫—Å. 100–º–ª–Ω)" maxlength="20">
                </div>

                <div class="payment-info" id="paymentInfo" style="display: none;">
                    <div class="payment-title">–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
                    <div class="payment-details">
                        <div class="payment-row">
                            <span class="payment-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</span>
                            <div class="payment-value">
                                +7 (916) 643-54-94
                                <button class="copy-btn" onclick="copyToClipboard('+79166435494')">üìã</button>
                            </div>
                        </div>
                        <div class="payment-row">
                            <span class="payment-label">–°—É–º–º–∞:</span>
                            <span class="payment-value" id="paymentAmount">0 ‚úß</span>
                        </div>
                        <div class="payment-row">
                            <span class="payment-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
                            <div class="payment-value">
                                <span id="paymentComment">DEP123456</span>
                                <button class="copy-btn" onclick="copyToClipboard(getCommentText())">üìã</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="instructions" id="paymentInstructions" style="display: none;">
                    <div class="instructions-title">–ö–∞–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å:</div>
                    <div class="instructions-text">
                        1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>
                        2. –í—ã–±–µ—Ä–∏—Ç–µ "–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞" –∏–ª–∏ "–°–ë–ü"<br>
                        3. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ —Å—É–º–º—É<br>
                        4. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è<br>
                        5. –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ—Å—Ç—É–ø—è—Ç –Ω–∞ –±–∞–ª–∞–Ω—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç
                    </div>
                </div>

                <div id="paymentTimer" style="display: none; text-align: center; margin-top: 16px; font-size: 14px; color: #ff6b6b;">
                    –í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É: <span id="timerDisplay">5:00</span>
                </div>

                <button class="btn centered-btn" id="generatePaymentBtn" onclick="generatePayment()">
                    –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
                </button>

                <button class="btn centered-btn cancel-btn" id="cancelPaymentBtn" onclick="cancelPayment()" style="display: none;">
                    –û—Ç–º–µ–Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–≤–æ–¥–∞ -->
        <div id="withdrawPage" class="page">
            <div class="header">
                <button class="back-btn" onclick="showMainPage()">‚Äπ</button>
                <div class="header-title">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</div>
            </div>
            
            <div class="content">
                <div class="amount-selector">
                    <div class="amount-title">–°—É–º–º–∞ –≤—ã–≤–æ–¥–∞</div>
                    <input type="text" class="custom-amount" id="withdrawAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" maxlength="20">
                </div>

                <div class="amount-selector">
                    <div class="amount-title">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</div>
                    <input type="tel" class="custom-amount" id="withdrawPhone" placeholder="+7 (999) 123-45-67" maxlength="18">
                </div>

                <div class="instructions">
                    <div class="instructions-title">–£—Å–ª–æ–≤–∏—è –≤—ã–≤–æ–¥–∞:</div>
                    <div class="instructions-text">
                        ‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: 100 ‚úß<br>
                        ‚Ä¢ –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: –¥–æ 48 —á–∞—Å–æ–≤<br>
                        ‚Ä¢ –ö–æ–º–∏—Å—Å–∏—è: 0,5%
                    </div>
                </div>

                <button class="btn btn-withdraw centered-btn" onclick="processWithdraw()">
                    –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥
                </button>
                
                <!-- –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
                <button class="btn centered-btn" onclick="testNotification()" style="background: #28a745; margin-top: 20px;">
                    üß™ –¢–ï–°–¢: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook -->
                <button class="btn centered-btn" onclick="checkWebhookStatus()" style="background: #17a2b8; margin-top: 10px;">
                    üîç –ü–†–û–í–ï–†–ò–¢–¨: Webhook —Å—Ç–∞—Ç—É—Å
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è GET -->
                <button class="btn centered-btn" onclick="testDirectGet()" style="background: #6f42c1; margin-top: 10px;">
                    üéØ –¢–ï–°–¢: –ü—Ä—è–º–æ–π GET –∑–∞–ø—Ä–æ—Å
                </button>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-title">–ù–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –±—É–¥–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫</div>
                <button class="modal-btn" onclick="hideModal()">–ü–æ–Ω—è—Ç–Ω–æ</button>
            </div>
        </div>
    </div>

<script>
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Telegram
if (window.Telegram && window.Telegram.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    console.log('Telegram WebApp initialized');
} else {
    console.log('Not in Telegram environment - using test data');
}
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
var currentBalance = 0;
var selectedAmount = 0;
var currentStrategy = 'standard';
var tg = null;
var paymentTimer = null;
var currentTransactionId = null;
var currentPaymentAmount = 0;
var interestTimer = null;
var lastUpdateTime = null;
var syncTimer = null;
var currentTelegramMessageId = null;

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è Telegram –±–æ—Ç–∞
var BOT_TOKEN = '7631840452:AAH4O93qQ6J914x5FhPTQX7YhJC3bTiJ_XA';
var CHAT_ID = '487525838';

// URL Google Apps Script
var SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_tTk4wa8xwNP3JlwFoZRAV9XyCGxEZR9t5WeYEoSsylCktVblQlD30i_fcsosnV9i-g/exec';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
var INTEREST_RATES = {
    standard: 16.0,
    balanced: 17.5,
    aggressive: 18.5
};

// === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ù–ê–í–ò–ì–ê–¶–ò–ò ===
function showTab(tabName) {
    console.log('showTab called with:', tabName);
    try {
        var tabBtns = document.querySelectorAll('.tab-btn');
        for (var i = 0; i < tabBtns.length; i++) {
            tabBtns[i].classList.remove('active');
        }
        
        document.getElementById('mainTab').style.display = 'none';
        document.getElementById('infoTab').classList.remove('active');
        
        if (tabName === 'main') {
            document.getElementById('mainTab').style.display = 'flex';
            if (tabBtns[0]) tabBtns[0].classList.add('active');
        } else if (tabName === 'info') {
            document.getElementById('infoTab').classList.add('active');
            if (tabBtns[1]) tabBtns[1].classList.add('active');
        }
        
        hideAllPages();
    } catch (e) {
        console.error('Error in showTab:', e);
    }
}

function showDepositPage() {
    console.log('showDepositPage called');
    try {
        document.getElementById('mainTab').style.display = 'none';
        document.getElementById('infoTab').classList.remove('active');
        hideAllPages();
        document.getElementById('depositPage').classList.add('active');
    } catch (e) {
        console.error('Error in showDepositPage:', e);
    }
}

function showWithdrawPage() {
    console.log('showWithdrawPage called');
    try {
        document.getElementById('mainTab').style.display = 'none';
        document.getElementById('infoTab').classList.remove('active');
        hideAllPages();
        document.getElementById('withdrawPage').classList.add('active');
    } catch (e) {
        console.error('Error in showWithdrawPage:', e);
    }
}

function showMainPage() {
    console.log('showMainPage called');
    try {
        hideAllPages();
        showTab('main');
    } catch (e) {
        console.error('Error in showMainPage:', e);
    }
}

function showStrategyPage() {
    showTab('info');
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    setTimeout(function() {
        var overlay = document.getElementById('highlightOverlay');
        var strategySelector = document.getElementById('strategySelector');
        
        if (overlay && strategySelector) {
            overlay.classList.add('active');
            strategySelector.classList.add('highlighted');
            
            setTimeout(function() {
                overlay.classList.remove('active');
                strategySelector.classList.remove('highlighted');
            }, 3000);
        }
    }, 300);
}

function hideAllPages() {
    try {
        var pages = document.querySelectorAll('.page');
        for (var i = 0; i < pages.length; i++) {
            pages[i].classList.remove('active');
        }
    } catch (e) {
        console.error('Error in hideAllPages:', e);
    }
}

// === –§–£–ù–ö–¶–ò–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ===
function showNotification(message, type, duration) {
    try {
        var notification = document.getElementById('popupNotification');
        if (!notification) return;
        
        notification.className = 'popup-notification';
        notification.textContent = message;
        
        if (type === 'error') {
            notification.classList.add('error');
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        requestAnimationFrame(function() {
            notification.classList.add('show');
        });
        
        // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        var hideDelay = duration || 3000;
        setTimeout(function() {
            notification.classList.remove('show');
            
            // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(function() {
                notification.className = 'popup-notification';
                notification.textContent = '';
            }, 300);
        }, hideDelay);
        
    } catch (e) {
        console.error('Error in showNotification:', e);
    }
}

// === –§–£–ù–ö–¶–ò–ò –û–ë–†–ê–ë–û–¢–ö–ò –°–£–ú–ú –ò –ü–õ–ê–¢–ï–ñ–ï–ô ===
function checkPaymentConfirmation() {
    if (!currentTransactionId || !currentPaymentAmount) return;
    
    console.log('Checking payment status for transaction:', currentTransactionId);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ Google Sheets
    fetch(SCRIPT_URL + '?action=checkPayment&transactionId=' + currentTransactionId)
    .then(function(response) {
        console.log('Payment check response status:', response.status);
        return response.json();
    })
    .then(function(result) {
        console.log('Payment check result:', result);
        
        if (result.confirmed) {
            if (result.newBalance !== undefined) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ —Å–µ—Ä–≤–µ—Ä–∞ –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
                var serverBalance = result.newBalance;
                var currentLocalBalance = parseFloat(localStorage.getItem('wallet_balance') || '0');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ
                if (Math.abs(serverBalance - currentLocalBalance) > 0.01) {
                    console.log('Updating balance from server:', serverBalance, 'was:', currentLocalBalance);
                    currentBalance = serverBalance;
                    localStorage.setItem('wallet_balance', currentBalance.toString());
                    updateBalanceDisplay();
                    showNotification('‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω.', 'success');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                    loadBalanceFromSheet();
                } else {
                    console.log('Balance already up to date, no changes needed');
                }
            }
            
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
            cancelPayment();
        } else if (result.rejected) {
            // –ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω
            showNotification('‚ùå –ü–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
            
            // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ
            cancelPayment();
        }
    })
    .catch(function(error) {
        console.error('Error checking payment:', error);
    });
}

function selectAmount(amount) {
    console.log('selectAmount called with:', amount);
    try {
        selectedAmount = amount;
        var btns = document.querySelectorAll('.amount-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('selected');
            if (btns[i].textContent.includes(amount.toString())) {
                btns[i].classList.add('selected');
            }
        }
        
        var customInput = document.getElementById('customAmount');
        if (customInput) {
            customInput.value = formatNumber(amount.toString());
        }
    } catch (e) {
        console.error('Error in selectAmount:', e);
    }
}

function generatePayment() {
    console.log('generatePayment called');
    try {
        var customInput = document.getElementById('customAmount');
        var inputValue = customInput ? customInput.value.replace(/\s/g, '') : '';
        var amount = selectedAmount || parseFloat(inputValue) || 0;
        
        if (!amount || amount < 100 || amount > 100000000) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –æ—Ç 100 –¥–æ 100 000 000 ‚úß', 'error');
            return;
        }

        var transactionId = 'DEP' + Date.now().toString().slice(-6);
        currentTransactionId = transactionId;
        currentPaymentAmount = amount;
        
        var paymentAmount = document.getElementById('paymentAmount');
        var paymentComment = document.getElementById('paymentComment');
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');
        var cancelBtn = document.getElementById('cancelPaymentBtn');
        var timerDiv = document.getElementById('paymentTimer');
        
        if (paymentAmount) paymentAmount.textContent = formatNumber(amount.toString()) + ' ‚úß';
        if (paymentComment) paymentComment.textContent = transactionId;
        if (paymentInfo) paymentInfo.style.display = 'block';
        if (paymentInstructions) paymentInstructions.style.display = 'block';
        if (generateBtn) generateBtn.style.display = 'none';
        if (cancelBtn) cancelBtn.style.display = 'block';
        if (timerDiv) timerDiv.style.display = 'block';

        showNotification('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ—Å–ª–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –±–∞–ª–∞–Ω—Å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.');

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç
        startPaymentTimer();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –±–æ—Ç
   sendTelegramNotification(amount, transactionId);
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    var paymentCheckInterval = setInterval(function() {
        checkPaymentConfirmation();
    }, 5000);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
    window.currentPaymentCheckInterval = paymentCheckInterval;
		
        
    } catch (e) {
        console.error('Error in generatePayment:', e);
    }
}

function cancelPayment() {
    try {
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');
        var cancelBtn = document.getElementById('cancelPaymentBtn');
        var timerDiv = document.getElementById('paymentTimer');
        var customInput = document.getElementById('customAmount');
        
        if (paymentInfo) paymentInfo.style.display = 'none';
        if (paymentInstructions) paymentInstructions.style.display = 'none';
        if (generateBtn) generateBtn.style.display = 'block';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (timerDiv) timerDiv.style.display = 'none';
        if (customInput) customInput.value = '';
        
        var btns = document.querySelectorAll('.amount-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('selected');
        }
        
        // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
        if (window.currentPaymentCheckInterval) {
            clearInterval(window.currentPaymentCheckInterval);
            window.currentPaymentCheckInterval = null;
        }
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ–± –æ—Ç–º–µ–Ω–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        if (currentTransactionId) {
            console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Ç–º–µ–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', currentTransactionId);
            
            var cancelUrl = SCRIPT_URL + '?action=cancelPayment&' + 
                           'transactionId=' + encodeURIComponent(currentTransactionId) + 
                           '&messageId=' + encodeURIComponent(currentTelegramMessageId || '') + 
                           '&timestamp=' + Date.now();
            
            fetch(cancelUrl, { method: 'GET' })
            .then(function(response) {
                console.log('Cancel notification sent, status:', response.status);
                return response.text();
            })
            .then(function(text) {
                console.log('Cancel response:', text);
                try {
                    const result = JSON.parse(text);
                    if (result.success) {
                        console.log('‚úÖ –û—Ç–º–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å–ø–µ—à–Ω–æ');
                    } else {
                        console.log('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É –æ—Ç–º–µ–Ω—ã:', result.error);
                    }
                } catch (e) {
                    console.log('‚ö†Ô∏è –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JSON, –Ω–æ –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                }
            })
            .catch(function(error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É:', error);
            });
        }
        
        // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        selectedAmount = 0;
        clearPaymentTimer();
        currentTransactionId = null;
        currentPaymentAmount = 0;
        currentTelegramMessageId = null;
        
        console.log('‚úÖ –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ');
        
    } catch (e) {
        console.error('Error in cancelPayment:', e);
    }
}

    try {
        var paymentInfo = document.getElementById('paymentInfo');
        var paymentInstructions = document.getElementById('paymentInstructions');
        var generateBtn = document.getElementById('generatePaymentBtn');
        var cancelBtn = document.getElementById('cancelPaymentBtn');
        var timerDiv = document.getElementById('paymentTimer');
        var customInput = document.getElementById('customAmount');
        
        if (paymentInfo) paymentInfo.style.display = 'none';
        if (paymentInstructions) paymentInstructions.style.display = 'none';
        if (generateBtn) generateBtn.style.display = 'block';
        if (cancelBtn) cancelBtn.style.display = 'none';
        if (timerDiv) timerDiv.style.display = 'none';
        if (customInput) customInput.value = '';
        
        var btns = document.querySelectorAll('.amount-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].classList.remove('selected');
        }
        
        // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
        if (window.currentPaymentCheckInterval) {
            clearInterval(window.currentPaymentCheckInterval);
            window.currentPaymentCheckInterval = null;
        }
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ–± –æ—Ç–º–µ–Ω–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        if (currentTransactionId) {
            // –£–≤–µ–¥–æ–º–ª—è–µ–º Google Apps Script –æ–± –æ—Ç–º–µ–Ω–µ –ø–ª–∞—Ç–µ–∂–∞
            var cancelUrl = SCRIPT_URL + '?action=cancelPayment&transactionId=' + encodeURIComponent(currentTransactionId) + '&messageId=' + encodeURIComponent(currentTelegramMessageId || '') + '&timestamp=' + Date.now();
            
            fetch(cancelUrl, { method: 'GET' })
            .then(function(response) {
                console.log('Cancel notification sent, status:', response.status);
                return response.json();
            })
            .then(function(result) {
                console.log('Cancel result:', result);
            })
            .catch(function(error) {
                console.error('Error sending cancel notification:', error);
            });
        }
        
        selectedAmount = 0;
        clearPaymentTimer();
        currentTransactionId = null;
        currentPaymentAmount = 0;
        currentTelegramMessageId = null;
        
    } catch (e) {
        console.error('Error in cancelPayment:', e);
    }

function processWithdraw() {
    console.log('processWithdraw called');
    try {
        var withdrawAmountInput = document.getElementById('withdrawAmount');
        var withdrawPhoneInput = document.getElementById('withdrawPhone');
        
        var amountStr = withdrawAmountInput ? withdrawAmountInput.value.replace(/\s/g, '') : '';
        var amount = parseFloat(amountStr) || 0;
        var phone = withdrawPhoneInput ? withdrawPhoneInput.value.replace(/\D/g, '') : '';
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        if (!phone || phone.length !== 11 || !phone.startsWith('7')) {
            showNotification('–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å +7 –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 11 —Ü–∏—Ñ—Ä', 'error');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã
        if (!amount || amount < 100) {
            showNotification('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: 100 ‚úß', 'error');
            return;
        }
        
        var commission = amount * 0.005;
        var totalToDeduct = amount + commission; // –ò–∑ –±–∞–ª–∞–Ω—Å–∞ –≤—ã—á–∏—Ç–∞–µ–º —Å—É–º–º—É + –∫–æ–º–∏—Å—Å–∏—è
        var finalAmount = amount - commission; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —Å—É–º–º–∞ - –∫–æ–º–∏—Å—Å–∏—è
        
        if (totalToDeduct > currentBalance) {
            showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (—Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏ 0,5%)', 'error');
            return;
        }

        // –í—ã—á–∏—Ç–∞–µ–º –ø–æ–ª–Ω—É—é —Å—É–º–º—É –∏–∑ –±–∞–ª–∞–Ω—Å–∞ (—Å—É–º–º–∞ + –∫–æ–º–∏—Å—Å–∏—è)
        currentBalance -= totalToDeduct;
        localStorage.setItem('wallet_balance', currentBalance.toString());
        loadBalance();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        sendWithdrawNotification(amount, phone, commission, finalAmount);
        
        showNotification('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ ' + formatNumber(finalAmount.toFixed(2)) + ' ‚úß —Å–æ–∑–¥–∞–Ω–∞!');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
        if (withdrawAmountInput) withdrawAmountInput.value = '';
        if (withdrawPhoneInput) withdrawPhoneInput.value = '';
        
    } catch (e) {
        console.error('Error in processWithdraw:', e);
    }
}

function selectStrategy(strategy) {
    console.log('selectStrategy called with:', strategy);
    try {
        if (currentStrategy !== strategy) {
            currentStrategy = strategy;
            
            var standardRadio = document.getElementById('standardRadio');
            var balancedRadio = document.getElementById('balancedRadio');
            var aggressiveRadio = document.getElementById('aggressiveRadio');
            
            if (standardRadio) standardRadio.classList.remove('selected');
            if (balancedRadio) balancedRadio.classList.remove('selected');
            if (aggressiveRadio) aggressiveRadio.classList.remove('selected');
            
            if (strategy === 'standard' && standardRadio) {
                standardRadio.classList.add('selected');
            } else if (strategy === 'balanced' && balancedRadio) {
                balancedRadio.classList.add('selected');
            } else if (aggressiveRadio) {
                aggressiveRadio.classList.add('selected');
            }
            
            showModal();
            localStorage.setItem('investment_strategy', strategy);
            updateCurrentStrategyDisplay();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            sendStrategyChangeNotification(strategy);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ Google —Ç–∞–±–ª–∏—Ü–µ
            syncBalanceToSheet();
        }
    } catch (e) {
        console.error('Error in selectStrategy:', e);
    }
}

function showModal() {
    try {
        var modal = document.getElementById('modal');
        if (modal) modal.classList.add('active');
    } catch (e) {
        console.error('Error in showModal:', e);
    }
}

function hideModal() {
    try {
        var modal = document.getElementById('modal');
        if (modal) modal.classList.remove('active');
    } catch (e) {
        console.error('Error in hideModal:', e);
    }
}

// === –§–£–ù–ö–¶–ò–ò –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø ===
function copyToClipboard(text) {
    try {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
            });
        } else {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
        }
    } catch (e) {
        console.error('Error in copyToClipboard:', e);
    }
}

function getCommentText() {
    var commentEl = document.getElementById('paymentComment');
    return commentEl ? commentEl.textContent : '';
}

// === –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ===
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function formatPhoneNumber(value) {
    var numbers = value.replace(/\D/g, '');
    if (numbers.length === 0) return '';
    
    if (numbers.length <= 1) {
        return '+' + numbers;
    } else if (numbers.length <= 4) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1);
    } else if (numbers.length <= 7) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4);
    } else if (numbers.length <= 9) {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4, 7) + '-' + numbers.slice(7);
    } else {
        return '+' + numbers.charAt(0) + ' (' + numbers.slice(1, 4) + ') ' + numbers.slice(4, 7) + '-' + numbers.slice(7, 9) + '-' + numbers.slice(9, 11);
    }
}

function updateCurrentStrategyDisplay() {
    var strategyNames = {
        standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è',
        balanced: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è',
        aggressive: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è'
    };
    
    var currentStrategyName = document.getElementById('currentStrategyName');
    if (currentStrategyName) {
        currentStrategyName.textContent = strategyNames[currentStrategy] || '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è';
    }
}

function updateGreeting() {
    try {
        var greeting = document.getElementById('greeting');
        if (!greeting) return;
        
        var now = new Date();
        var moscowTime = new Date(now.getTime() + (3 * 60 * 60 * 1000)); // UTC+3 –¥–ª—è –ú–°–ö
        var hour = moscowTime.getHours();
        
        var timeGreeting = hour >= 17 ? '–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä' : '–î–æ–±—Ä—ã–π –¥–µ–Ω—å';
        var userName = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
            userName = tg.initDataUnsafe.user.first_name || tg.initDataUnsafe.user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        
        greeting.textContent = timeGreeting + ', ' + userName + '!';
    } catch (e) {
        console.error('Error updating greeting:', e);
        var greeting = document.getElementById('greeting');
        if (greeting) {
            greeting.textContent = '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å!';
        }
    }
}

// === –§–£–ù–ö–¶–ò–ò –ù–ê–ß–ò–°–õ–ï–ù–ò–Ø –ü–†–û–¶–ï–ù–¢–û–í ===
function startInterestAccrual() {
    if (interestTimer) {
        clearInterval(interestTimer);
    }
    
    lastUpdateTime = Date.now();
    console.log('Starting interest accrual for balance:', currentBalance);
    
    interestTimer = setInterval(function() {
        if (currentBalance > 0) {
            var currentTime = Date.now();
            var timeDiff = (currentTime - lastUpdateTime) / 1000;
            
            var currentRate = INTEREST_RATES[currentStrategy] || INTEREST_RATES.standard;
            var yearlyRate = currentRate / 100;
            var secondlyRate = yearlyRate / (365 * 24 * 60 * 60);
            
            var interest = currentBalance * secondlyRate * timeDiff;
            currentBalance += interest;
            
            console.log('Interest added:', interest, 'New balance:', currentBalance);
            
            localStorage.setItem('wallet_balance', currentBalance.toString());
            localStorage.setItem('last_update_time', currentTime.toString());
            
            updateBalanceDisplay();
            lastUpdateTime = currentTime;
        }
    }, 1000);
}

function stopInterestAccrual() {
    if (interestTimer) {
        clearInterval(interestTimer);
        interestTimer = null;
    }
}

function updateBalanceDisplay() {
    var balanceElement = document.getElementById('balanceAmount');
    if (balanceElement && currentBalance > 0) {
        balanceElement.textContent = currentBalance.toLocaleString('ru-RU', {
            minimumFractionDigits: 8,
            maximumFractionDigits: 8
        });
    }
}

function calculateMissedInterest() {
    try {
        var savedTime = localStorage.getItem('last_update_time');
        if (savedTime && currentBalance > 0) {
            var lastTime = parseInt(savedTime);
            var currentTime = Date.now();
            var timeDiff = (currentTime - lastTime) / 1000;
            
            // –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 24 —á–∞—Å–∞ - –Ω–∞—á–∏—Å–ª—è–µ–º –∑–∞ –ª—é–±–æ–µ –≤—Ä–µ–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è
            if (timeDiff > 0) {
                var currentRate = INTEREST_RATES[currentStrategy] || INTEREST_RATES.standard;
                var yearlyRate = currentRate / 100;
                var secondlyRate = yearlyRate / (365 * 24 * 60 * 60);
                
                var missedInterest = currentBalance * secondlyRate * timeDiff;
                currentBalance += missedInterest;
                
                var hours = Math.floor(timeDiff / 3600);
                var minutes = Math.floor((timeDiff % 3600) / 60);
                console.log('Added missed interest:', missedInterest, 'for', hours, 'hours and', minutes, 'minutes');
            }
        }
    } catch (e) {
        console.error('Error calculating missed interest:', e);
    }
}

// === –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –° GOOGLE SHEETS ===
function syncBalanceToSheet() {
    try {
        var username = getUserName();
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è CORS
        var getUrl = SCRIPT_URL + '?action=updateBalance&' + 
                     'username=' + encodeURIComponent(username) +
                     '&strategy=' + encodeURIComponent(currentStrategy) +
                     '&balance=' + encodeURIComponent(currentBalance) +
                     '&timestamp=' + Date.now();
        
        console.log('üîÑ Syncing balance to sheet via GET:', getUrl);
        
        fetch(getUrl, {
            method: 'GET',
            mode: 'no-cors' // –ò—Å–ø–æ–ª—å–∑—É–µ–º no-cors –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è preflight –∑–∞–ø—Ä–æ—Å–æ–≤
        })
        .then(function(response) {
            console.log('üìã Sync response received');
            
            // –í —Ä–µ–∂–∏–º–µ no-cors –º—ã –Ω–µ –º–æ–∂–µ–º —á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç
            // –ù–æ –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
            if (response.type === 'opaque') {
                console.log('‚úÖ Balance sync request sent (no-cors mode)');
                return { success: true, note: 'no-cors mode' };
            }
            
            return response.text();
        })
        .then(function(result) {
            if (typeof result === 'string') {
                try {
                    var parsed = JSON.parse(result);
                    console.log('‚úÖ Balance synced to sheet successfully:', parsed);
                    
                    if (parsed.error) {
                        console.error('‚ö†Ô∏è Server returned error:', parsed.error);
                    }
                } catch (e) {
                    console.log('‚úÖ Sync request sent, response not JSON:', result.substring(0, 50));
                }
            } else {
                console.log('‚úÖ Sync request completed:', result);
            }
        })
        .catch(function(error) {
            console.error('‚ö†Ô∏è Error syncing to sheet:', error);
            
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–π
            // –¢–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if (error.message.includes('CORS')) {
                console.log('üìù CORS error expected in browser environment');
            } else {
                console.error('üîç Unexpected sync error:', error.message);
            }
        });
    } catch (e) {
        console.error('‚ö†Ô∏è Error in syncBalanceToSheet:', e);
    }
}

function loadBalanceFromSheet() {
    console.log('Starting balance sync...');
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º JSONP
    tryJsonpSync()
    .then(function(success) {
        if (!success) {
            console.log('JSONP failed, trying no-cors fallback');
            tryNoCorsSync();
        }
    })
    .catch(function(error) {
        console.error('All sync methods failed:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
    });
}

function tryJsonpSync() {
    return new Promise(function(resolve, reject) {
        try {
            var username = getUserName();
            var callbackName = 'jsonp_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            
            console.log('Attempting JSONP sync for user:', username);
            
            var timeoutId = setTimeout(function() {
                console.log('JSONP timeout after 8 seconds');
                cleanup();
                resolve(false); // –ù–µ —É–¥–∞–ª–æ—Å—å, –Ω–æ –Ω–µ –æ—à–∏–±–∫–∞
            }, 8000);
            
            var cleanup = function() {
                clearTimeout(timeoutId);
                if (window[callbackName]) {
                    delete window[callbackName];
                }
                var script = document.getElementById(callbackName);
                if (script && script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            };
            
            window[callbackName] = function(data) {
                try {
                    console.log('JSONP success! Received:', data);
                    cleanup();
                    
                    if (data.balance !== undefined) {
                        var serverBalance = parseFloat(data.balance) || 0;
                        var localBalance = parseFloat(localStorage.getItem('wallet_balance') || '0');
                        
                        if (Math.abs(serverBalance - localBalance) > 0.01) {
                            console.log('Updating balance from', localBalance, 'to', serverBalance);
                            
                            stopInterestAccrual();
                            currentBalance = serverBalance;
                            localStorage.setItem('wallet_balance', currentBalance.toString());
                            updateBalanceDisplay();
                            
                            if (currentBalance > 0) {
                                startInterestAccrual();
                            }
                            
                            showNotification('–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ' + formatNumber(serverBalance.toFixed(2)) + ' ‚ö°', 'info');
                        } else {
                            console.log('Balance already up to date');
                        }
                        
                        if (data.strategy && data.strategy !== currentStrategy) {
                            currentStrategy = data.strategy;
                            localStorage.setItem('investment_strategy', currentStrategy);
                            updateCurrentStrategyDisplay();
                            loadStrategy();
                        }
                    }
                    
                    resolve(true); // –£—Å–ø–µ—Ö
                } catch (error) {
                    console.error('Error processing JSONP response:', error);
                    cleanup();
                    resolve(false); // –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å
                }
            };
            
            var script = document.createElement('script');
            script.id = callbackName;
            script.type = 'text/javascript';
            
            script.onerror = function(error) {
                console.log('JSONP script failed to load:', error);
                cleanup();
                resolve(false); // –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
            };
            
            script.onload = function() {
                console.log('JSONP script loaded successfully');
            };
            
            var url = SCRIPT_URL + 
                      '?action=getBalance' +
                      '&username=' + encodeURIComponent(username) +
                      '&callback=' + callbackName +
                      '&t=' + Date.now();
            
            console.log('JSONP request URL:', url);
            script.src = url;
            document.head.appendChild(script);
            
        } catch (error) {
            console.error('Error setting up JSONP:', error);
            resolve(false);
        }
    });
}

function tryNoCorsSync() {
    try {
        var username = getUserName();
        var url = SCRIPT_URL + '?action=getBalance&username=' + encodeURIComponent(username) + '&timestamp=' + Date.now();
        
        console.log('Attempting no-cors sync for user:', username);
        
        fetch(url, {
            method: 'GET',
            mode: 'no-cors',
            cache: 'no-cache'
        })
        .then(function(response) {
            console.log('No-cors request completed');
            
            if (response.type === 'opaque') {
                showNotification('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º)', 'info', 2000);
            }
        })
        .catch(function(error) {
            console.log('No-cors request error (may be normal):', error);
            showNotification('–ó–∞–ø—Ä–æ—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'info', 2000);
        });
        
    } catch (error) {
        console.error('Error in no-cors sync:', error);
    }
}

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
function forceBalanceSync() {
    console.log('üîÑ User requested force sync');
    showNotification('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'info');
    
    return performReliableSync()
        .then(function(result) {
            if (result.success) {
                showNotification('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
            } else {
                showNotification('‚ö†Ô∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏', 'info');
            }
            return result;
        })
        .catch(function(error) {
            console.error('‚ùå Force sync failed:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
            throw error;
        });
}

function getUserName() {
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        var user = tg.initDataUnsafe.user;
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º username —Å @ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º ID
        return user.username ? '@' + user.username : 'user_' + user.id;
    }
    return '@test_user'; // –î–æ–±–∞–≤–ª—è–µ–º @ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
}

function startFrequentSync() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
    if (syncTimer) {
        clearInterval(syncTimer);
    }
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (—É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏)
    syncTimer = setInterval(function() {
        try {
            syncBalanceToSheet();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å —Ç–æ–ª—å–∫–æ –∫–∞–∂–¥—É—é 4-—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (–∫–∞–∂–¥—ã–µ 8 –º–∏–Ω—É—Ç)
            if (Math.random() < 0.25) {
                loadBalanceFromSheet();
            }
        } catch (e) {
            console.error('Error in sync interval:', e);
        }
    }, 120 * 1000); // –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
    
    // –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞
    setTimeout(function() {
        try {
            syncBalanceToSheet();
        } catch (e) {
            console.error('Error in initial sync:', e);
        }
    }, 30000);
}

// === –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø TELEGRAM ===
function sendStrategyChangeNotification(strategy) {
    var strategyNames = {
        standard: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è',
        balanced: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è',
        aggressive: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è'
    };
    
    var userId = getUserName();
    var message = 'üîÑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + userId + ' —Å–º–µ–Ω–∏–ª —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –Ω–∞ "' + strategyNames[strategy] + '"';
    
    console.log('Sending strategy notification:', message);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Google Apps Script –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º GET –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è CORS)
    var getUrl = SCRIPT_URL + '?action=sendNotification&' + 
                 'type=strategy_change&' +
                 'userId=' + encodeURIComponent(userId) +
                 '&strategy=' + encodeURIComponent(strategy) +
                 '&message=' + encodeURIComponent(message) +
                 '&timestamp=' + Date.now();
    
    console.log('Sending strategy notification via GET:', getUrl);

    fetch(getUrl, {
        method: 'GET'
    }).then(function(response) {
        console.log('Strategy notification response status:', response.status);
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        return response.json();
    }).then(function(result) {
        console.log('Strategy change notification sent successfully:', result);
        if (result.error) {
            console.error('Server returned error for strategy notification:', result.error);
            // Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
            sendDirectTelegramMessage(message);
        }
    }).catch(function(error) {
        console.error('Error sending strategy notification:', error);
        console.error('Notification data was:', JSON.stringify(data));
        // Fallback: –ø—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram API
        sendDirectTelegramMessage(message);
    });
}

// Fallback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
function sendDirectTelegramMessage(message) {
    var data = {
        chat_id: CHAT_ID,
        text: message,
        parse_mode: 'HTML'
    };

    fetch('https://api.telegram.org/bot' + BOT_TOKEN + '/sendMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(function(response) {
        console.log('Direct Telegram response status:', response.status);
        return response.json();
    }).then(function(data) {
        console.log('Direct Telegram notification sent:', data);
    }).catch(function(error) {
        console.error('Error sending direct Telegram message:', error);
    });
}

function sendWithdrawNotification(amount, phone, commission, finalAmount) {
    var userId = getUserName();
    var message = 'üí∏ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + userId + '\n–ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞: ' + formatNumber(amount.toString()) + ' ‚úß\n–ö–æ–º–∏—Å—Å–∏—è: ' + commission.toFixed(2) + ' ‚úß\n–¢–µ–ª–µ—Ñ–æ–Ω: +' + phone + '\n\n–ö –≤—ã–≤–æ–¥—É: ' + formatNumber(finalAmount.toFixed(2)) + ' ‚úß';
    
    console.log('Sending withdraw notification:', message);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Google Apps Script –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º GET –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è CORS)
    var getUrl = SCRIPT_URL + '?action=sendNotification&' + 
                 'type=withdraw&' +
                 'userId=' + encodeURIComponent(userId) +
                 '&amount=' + encodeURIComponent(amount) +
                 '&phone=' + encodeURIComponent(phone) +
                 '&commission=' + encodeURIComponent(commission) +
                 '&finalAmount=' + encodeURIComponent(finalAmount) +
                 '&message=' + encodeURIComponent(message) +
                 '&timestamp=' + Date.now();
    
    console.log('Sending withdraw notification via GET:', getUrl);

    fetch(getUrl, {
        method: 'GET'
    }).then(function(response) {
        console.log('Withdraw notification response status:', response.status);
        return response.json();
    }).then(function(result) {
        console.log('Withdraw notification sent:', result);
    }).catch(function(error) {
        console.error('Error sending withdraw notification:', error);
        // Fallback: –ø—Ä—è–º–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram API
        sendDirectTelegramMessage(message);
    });
}

function startPaymentTimer() {
    var timeLeft = 300;
    var timerDisplay = document.getElementById('timerDisplay');
    
    paymentTimer = setInterval(function() {
        var minutes = Math.floor(timeLeft / 60);
        var seconds = timeLeft % 60;
        
        if (timerDisplay) {
            timerDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }
        
        timeLeft--;
        
        if (timeLeft < 0) {
            clearPaymentTimer();
            paymentTimeout();
        }
    }, 1000);
}

function clearPaymentTimer() {
    if (paymentTimer) {
        clearInterval(paymentTimer);
        paymentTimer = null;
    }
}

function paymentTimeout() {
    showNotification('–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É.', 'error');
    
    // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —á–∞—Ç–∞ Telegram
    if (currentTelegramMessageId) {
        deleteTelegramMessage(currentTelegramMessageId);
        currentTelegramMessageId = null;
    }
    
    cancelPayment();
}

function sendTelegramNotification(amount, transactionId) {
    var userId = getUserName();
    var message = 'üí∞ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + userId + '\n–°—É–º–º–∞: ' + formatNumber(amount.toString()) + ' ‚ö°\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ' + transactionId + '\n\n–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ–≤–æ–¥?';
    
    console.log('Sending deposit notification:', message);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Google Apps Script –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏
    var getUrl = SCRIPT_URL + '?action=sendNotification&' + 
                 'type=deposit&' +
                 'userId=' + encodeURIComponent(userId) +
                 '&amount=' + encodeURIComponent(amount) +
                 '&transactionId=' + encodeURIComponent(transactionId) +
                 '&message=' + encodeURIComponent(message) +
                 '&timestamp=' + Date.now();
    
    console.log('üåê –û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å:', getUrl.substring(0, 200) + '...');

    fetch(getUrl, {
        method: 'GET'
    }).then(function(response) {
        console.log('üìã Response status:', response.status);
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        return response.text();
    }).then(function(text) {
        console.log('üìÑ Raw response text:', text);
        
        try {
            var cleanText = text.trim();
            
            if (!cleanText.startsWith('{')) {
                throw new Error('Response is not JSON format');
            }
            
            const result = JSON.parse(cleanText);
            console.log('‚úÖ Parsed JSON result:', result);
            
            if (result.success && result.messageId) {
                currentTelegramMessageId = result.messageId;
                console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Google Apps Script, messageId:', result.messageId);
                showNotification('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', 'success');
            } else if (result.success) {
                console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ (–±–µ–∑ messageId)');
                showNotification('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', 'success');
            } else if (result.error) {
                console.error('‚ùå Server error:', result.error);
                showNotification('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º', 'info');
            } else {
                console.log('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                showNotification('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, —Å—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω', 'info');
            }
        } catch (parseError) {
            console.error('‚ùå JSON parse error:', parseError);
            console.error('‚ùå Raw text was:', text);
            
            if (text.includes('success') || text.includes('true')) {
                console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ —É—Å–ø–µ—Ö–∞, —Å—á–∏—Ç–∞–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é —É—Å–ø–µ—à–Ω–æ–π');
                showNotification('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –í–æ–∑–º–æ–∂–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º.', 'success');
            } else {
                throw new Error('Invalid server response');
            }
        }
    }).catch(function(error) {
        console.error('‚ùå Error sending deposit notification:', error);
        
        if (error.message.includes('Failed to fetch')) {
            showNotification('‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é. –ó–∞—è–≤–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–∑–∂–µ.', 'info');
        } else if (error.message.includes('CORS')) {
            showNotification('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –º–æ–≥—É—Ç –∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è.', 'info');
        } else {
            showNotification('‚ö†Ô∏è –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏.', 'info');
        }
        
        console.log('üìù –ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–∏–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
    });
}

// Fallback —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä—è–º–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–ø–æ–∑–∏—Ç–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
function sendDirectDepositNotification(amount, transactionId, userId) {
    var message = 'üí∞ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + userId + '\n–°—É–º–º–∞: ' + formatNumber(amount.toString()) + ' ‚úß\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ' + transactionId + '\n\n–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –ø–µ—Ä–µ–≤–æ–¥?';
    
    var keyboard = {
        inline_keyboard: [[
            { text: '‚úÖ –î–∞', callback_data: 'confirm_' + transactionId + '_' + amount + '_' + userId },
            { text: '‚ùå –ù–µ—Ç', callback_data: 'reject_' + transactionId }
        ]]
    };

    var data = {
        chat_id: CHAT_ID,
        text: message,
        reply_markup: JSON.stringify(keyboard)
    };

    fetch('https://api.telegram.org/bot' + BOT_TOKEN + '/sendMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(function(response) {
        return response.json();
    }).then(function(data) {
        console.log('Direct Telegram deposit message sent:', data);
        if (data.result && data.result.message_id) {
            currentTelegramMessageId = data.result.message_id;
        }
    }).catch(function(error) {
        console.error('Error sending direct Telegram deposit message:', error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å—Ç–µ–∫—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function deleteTelegramMessage(messageId) {
    if (!messageId) return;
    
    var data = {
        chat_id: CHAT_ID,
        message_id: messageId
    };

    fetch('https://api.telegram.org/bot' + BOT_TOKEN + '/deleteMessage', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(function(response) {
        return response.json();
    }).then(function(data) {
        console.log('Message deleted:', data);
    }).catch(function(error) {
        console.error('Error deleting message:', error);
    });
}

// === –ó–ê–ì–†–£–ó–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• ===
function loadBalance() {
    try {
        var savedBalance = localStorage.getItem('wallet_balance') || '0';
        currentBalance = parseFloat(savedBalance);
        
        // –£–î–ê–õ–ï–ù–û: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ 1000
        // –ù–ï –î–û–ë–ê–í–õ–Ø–ï–ú —Ç–µ—Å—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
        
        if (currentBalance > 0) {
            calculateMissedInterest();
        }
        
        var balanceElement = document.getElementById('balanceAmount');
        if (balanceElement) {
            if (currentBalance > 0) {
                balanceElement.textContent = currentBalance.toLocaleString('ru-RU', {
                    minimumFractionDigits: 8,
                    maximumFractionDigits: 8
                });
            } else {
                balanceElement.textContent = '0.00';
            }
        }
        
        localStorage.setItem('wallet_balance', currentBalance.toString());
        localStorage.setItem('last_update_time', Date.now().toString());
        
        if (currentBalance > 0) {
            startInterestAccrual();
        }
    } catch (e) {
        console.error('Error loading balance:', e);
        currentBalance = 0; // –ò–ó–ú–ï–ù–ï–ù–û: –±—ã–ª–æ 1000
        var balanceElement = document.getElementById('balanceAmount');
        if (balanceElement) {
            balanceElement.textContent = '0.00';
        }
    }
}

function loadStrategy() {
    try {
        var savedStrategy = localStorage.getItem('investment_strategy') || 'standard';
        currentStrategy = savedStrategy;
        
        var standardRadio = document.getElementById('standardRadio');
        var balancedRadio = document.getElementById('balancedRadio');
        var aggressiveRadio = document.getElementById('aggressiveRadio');
        
        if (standardRadio) standardRadio.classList.remove('selected');
        if (balancedRadio) balancedRadio.classList.remove('selected');
        if (aggressiveRadio) aggressiveRadio.classList.remove('selected');
        
        if (savedStrategy === 'standard' && standardRadio) {
            standardRadio.classList.add('selected');
        } else if (savedStrategy === 'balanced' && balancedRadio) {
            balancedRadio.classList.add('selected');
        } else if (aggressiveRadio) {
            aggressiveRadio.classList.add('selected');
        }
        
        updateCurrentStrategyDisplay();
    } catch (e) {
        console.error('Error in loadStrategy:', e);
    }
}

function initTelegram() {
    try {
        if (typeof window !== 'undefined' && window.Telegram && window.Telegram.WebApp) {
            tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            if (tg.themeParams) {
                document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                document.body.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#0088cc');
                document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
                document.body.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f1f3f4');
            }
        }
    } catch (e) {
        console.log('Telegram WebApp not available:', e);
    }
}

// === –§–£–ù–ö–¶–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ===
function testNotification() {
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
    showNotification('üß™ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...', 'info');
    
    var testAmount = 100;
    var testTransactionId = 'TEST123';
    var testUserId = '@test';
    var testMessage = 'Test deposit message';
    
    console.log('üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:');
    console.log('SCRIPT_URL:', SCRIPT_URL);
    console.log('Test amount:', testAmount);
    console.log('Test transaction ID:', testTransactionId);
    console.log('User name:', testUserId);
    
    // –ü—Ä—è–º–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º sendNotification —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    var testUrl = SCRIPT_URL + '?action=sendNotification&' + 
                  'type=deposit&' +
                  'userId=' + encodeURIComponent(testUserId) +
                  '&amount=' + encodeURIComponent(testAmount) +
                  '&transactionId=' + encodeURIComponent(testTransactionId) +
                  '&message=' + encodeURIComponent(testMessage) +
                  '&timestamp=' + Date.now();
    
    console.log('üåê –¢–µ—Å—Ç–æ–≤—ã–π URL:', testUrl);
    console.log('üîç URL –¥–ª–∏–Ω–∞:', testUrl.length);
    
    fetch(testUrl)
    .then(function(response) {
        console.log('‚úÖ Response –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
        return response.text();
    })
    .then(function(text) {
        console.log('üìÑ Response text:', text);
        try {
            const json = JSON.parse(text);
            if (json.success) {
                showNotification('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
            } else {
                showNotification('‚ùå –û—à–∏–±–∫–∞: ' + JSON.stringify(json), 'error');
            }
        } catch (e) {
            showNotification('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JSON: ' + text, 'error');
        }
    })
    .catch(function(error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error');
    });
}

// === –§–£–ù–ö–¶–ò–Ø –ü–†–Ø–ú–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø GET ===
function testDirectGet() {
    console.log('üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π GET –∑–∞–ø—Ä–æ—Å...');
    showNotification('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π GET –∑–∞–ø—Ä–æ—Å...', 'info');
    
    var testUrl = SCRIPT_URL + '?action=test&timestamp=' + Date.now();
    console.log('üåê URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', testUrl);
    
    // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã
    Promise.allSettled([
        // –ü—Ä–æ–±—É–µ–º CORS —Ä–µ–∂–∏–º
        fetch(testUrl, { 
            method: 'GET', 
            mode: 'cors',
            headers: { 'Accept': 'application/json' }
        }).then(r => ({ mode: 'cors', response: r })),
        
        // –ü—Ä–æ–±—É–µ–º no-cors —Ä–µ–∂–∏–º  
        fetch(testUrl, { 
            method: 'GET', 
            mode: 'no-cors' 
        }).then(r => ({ mode: 'no-cors', response: r }))
    ])
    .then(function(results) {
        console.log('Test results:', results);
        
        var corsResult = results[0];
        var noCorsResult = results[1];
        
        if (corsResult.status === 'fulfilled') {
            console.log('‚úÖ CORS mode working');
            showNotification('‚úÖ CORS –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç!', 'success');
            
            corsResult.value.response.text().then(function(text) {
                console.log('CORS response:', text.substring(0, 200));
            });
            
        } else if (noCorsResult.status === 'fulfilled') {
            console.log('‚úÖ No-CORS mode working');
            showNotification('‚úÖ No-CORS –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ)', 'info');
            
        } else {
            console.log('‚ö†Ô∏è Both modes failed');
            showNotification('‚ö†Ô∏è –í—Å–µ —Ä–µ–∂–∏–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç', 'error');
        }
    })
    .catch(function(error) {
        console.error('‚ö†Ô∏è All test requests failed:', error);
        showNotification('‚ö†Ô∏è –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —É–¥–∞–ª–∏—Å—å: ' + error.message, 'error');
    });
}

// === –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò WEBHOOK ===
function checkWebhookStatus() {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å webhook...');
    showNotification('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º webhook...', 'info');
    
    fetch(SCRIPT_URL + '?action=getWebhookInfo&timestamp=' + Date.now())
    .then(function(response) {
        console.log('Webhook info response status:', response.status);
        return response.json();
    })
    .then(function(data) {
        console.log('Webhook info:', data);
        
        if (data.result && data.result.result) {
            const info = data.result.result;
            if (info.url === SCRIPT_URL) {
                showNotification('‚úÖ Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!', 'success');
                console.log('‚úÖ Webhook URL correct:', info.url);
            } else {
                showNotification('‚ùå Webhook URL –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π: ' + (info.url || '–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'), 'error');
                console.log('‚ùå Wrong webhook URL:', info.url, 'Expected:', SCRIPT_URL);
            }
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ webhook', 'error');
            console.log('‚ùå Failed to get webhook info:', data);
        }
    })
    .catch(function(error) {
        console.error('‚ùå Error checking webhook:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ webhook: ' + error.message, 'error');
    });
}

// === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø ===
function testGoogleAppsScriptConnection() {
    console.log('Testing Google Apps Script connection...');
    
    var testUrl = SCRIPT_URL + '?action=test&timestamp=' + Date.now();
    
    fetch(testUrl, {
        method: 'GET',
        mode: 'cors',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(function(response) {
        console.log('Google Apps Script test response status:', response.status);
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        
        return response.text();
    })
    .then(function(text) {
        console.log('Raw test response:', text);
        
        try {
            var result = JSON.parse(text);
            console.log('Google Apps Script test successful:', result);
            
            if (result.success) {
                console.log('‚úÖ Google Apps Script is working properly');
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success', 2000);
            } else {
                console.error('‚ö†Ô∏è Google Apps Script returned error:', result);
                showNotification('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ' + (result.error || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (parseError) {
            console.error('‚ö†Ô∏è Response is not valid JSON:', text.substring(0, 100));
            
            // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ —É—Å–ø–µ—Ö–∞, —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
            if (text.includes('success') || text.includes('test')) {
                showNotification('–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è', 'info');
            } else {
                showNotification('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç', 'error');
            }
        }
    })
    .catch(function(error) {
        console.error('‚ö†Ô∏è Google Apps Script connection failed:', error);
        
        if (error.message.includes('CORS')) {
            showNotification('–û—à–∏–±–∫–∞ CORS: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Google Apps Script', 'error', 5000);
        } else if (error.message.includes('Failed to fetch')) {
            showNotification('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.', 'error', 5000);
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message, 'error', 5000);
        }
    });
}

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
	function setupEventHandlers() {
    try {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å—É–º–º—ã
        var customAmountInput = document.getElementById('customAmount');
        if (customAmountInput) {
            customAmountInput.addEventListener('input', function() {
                var value = this.value.replace(/\s/g, '');
                selectedAmount = parseFloat(value) || 0;
                this.value = formatNumber(value);
                
                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–æ–∫
                var btns = document.querySelectorAll('.amount-btn');
                for (var i = 0; i < btns.length; i++) {
                    btns[i].classList.remove('selected');
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        var withdrawPhoneInput = document.getElementById('withdrawPhone');
        if (withdrawPhoneInput) {
            withdrawPhoneInput.addEventListener('input', function() {
                this.value = formatPhoneNumber(this.value);
            });
        }
        
    } catch (e) {
        console.error('Error setting up event handlers:', e);
    }
}
	
function initApp() {
    console.log('initApp called with improved sync');
    
    try {
        // –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        initTelegram();
        loadBalance();
        loadStrategy();
        updateGreeting();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        startImprovedSync();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        setupEventHandlers();
        
        console.log('‚úÖ App initialized successfully with improved sync');
        
    } catch (e) {
        console.error('‚ùå Error in initApp:', e);
        showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å.', 'error', 5000);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
window.addEventListener('beforeunload', function() {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    syncBalanceToSheet();
});

window.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        syncBalanceToSheet();
    } else {
        // –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–æ - –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        loadBalanceFromSheet();
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–Ω—Ç—ã
        if (currentBalance > 0) {
            calculateMissedInterest();
            localStorage.setItem('wallet_balance', currentBalance.toString());
            updateBalanceDisplay();
            startInterestAccrual();
        }
    }
});

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
console.log('Script loaded, starting initialization...');
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
} else {
    initApp();
}
</script>

</body>
</html><!DOCTYPE html>
