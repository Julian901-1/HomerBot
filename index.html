<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>HomerBot ‚Äî –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ö–æ—à–µ–ª—ë–∫</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f8fafc;
      --text-primary: #1e293b;
      --text-secondary: rgba(30,41,59,0.7);
      --accent: #4c8bf5;
      --accent-hover: #5a95f7;
      --success: #34d399;
      --warning: #fbbf24;
      --error: #f87171;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif; 
      background: var(--bg-primary); 
      color: var(--text-primary); 
      -webkit-text-size-adjust: 100%;
    }
    .app-container { max-width: 430px; margin: 0 auto; min-height: 100vh; position: relative; }
    
    /* Header & Nav */
    .header { position: sticky; top: 0; z-index: 100; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-family: 'Comfortaa', cursive; font-size: 24px; color: var(--text-primary); }
    .profile-btn, .btn, .copy-btn, .quick-amount-btn, .method-card, .filter-chip { background: var(--glass-bg); border: 1px solid var(--glass-border); transition: all 0.2s ease; cursor: pointer; color: var(--text-primary); }
    .profile-btn:hover, .btn:hover:not(:disabled), .copy-btn:hover, .quick-amount-btn:hover, .method-card:not(.disabled):hover, .filter-chip:hover:not(.active) { background: rgba(255,255,255,0.95); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .profile-btn { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: var(--glass-bg); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); padding: 12px 20px 20px; z-index: 100; border-radius: 24px 24px 0 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
/* Bottom nav ‚Äî –≤—Å–µ–≥–¥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ */
.nav-items {
  display: flex !important;
  flex-direction: row !important;
  justify-content: space-around;
  align-items: center;
  gap: 8px;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 12px;
  border-radius: 12px;
  opacity: .6;
  cursor: pointer;
  transition: transform .15s ease, opacity .2s ease, background .2s ease;
  flex: 0 0 auto;       /* –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å, –Ω–µ –ª–æ–º–∞—Ç—å —Ä—è–¥ */
}

.nav-item:hover { transform: translateY(-2px); opacity: .9; }
.nav-item.active { opacity: 1; background: rgba(255,255,255,0.2); }
    .nav-icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
    .nav-label { font-size: 11px; font-weight: 500; }
    
    /* Modals */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: flex-end; justify-content:center;}
    .modal-overlay.active { display: flex; }
    .modal { background: rgba(255, 255, 255, 0.95); border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; max-height: 90vh; overflow-y: auto; padding: 24px; animation: slideUp 0.3s ease; border-top: 1px solid var(--glass-border); box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    
    /* General */
    .page { display: none; padding: 20px 20px 120px; }
    .page.active { display: block; }
    .card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 24px; margin-bottom: 16px; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .glass-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

    /* Balance + stats (centered + autosize) */
    .balance-section { text-align: center; }
    .balance-label-container { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 8px; position: relative;}
    .balance-label { font-size: 14px; color: var(--text-secondary); }
    .balance-main { font-size: 42px; white-space: nowrap; font-weight: 800; display:block; margin: 0 auto; line-height: 1.15; color: var(--text-primary); }
    .balance-currency { font-size: 14px; color: var(--text-secondary); font-weight: 600; cursor: pointer; position: relative; border-radius: 8px; padding: 2px 6px; }
    .currency-arrow { font-size: 10px; opacity: 0.7; margin-left: 4px; }
    .currency-dropdown { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 8px; display: none; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .currency-dropdown.open { display: block; }
    .currency-option { padding: 8px 16px; cursor: pointer; border-radius: 8px; transition: background 0.2s; color: var(--text-primary); }
    .currency-option:hover { background: rgba(0,0,0,0.05); }
    .currency-option.active { background: var(--accent); color: white; }

    .balance-stats { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border); gap: 8px; }
    .balance-stat { flex: 1; text-align: center; }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 16px; font-weight: 700; color: var(--text-primary); }
    .stat-positive { color: var(--success); }

    .btn-group { display: flex; gap: 12px; margin-bottom: 24px; }
    .btn { flex: 1; padding: 16px 24px; border-radius: 16px; font-size: 16px; font-weight: 700; color: var(--text-primary); border: 1px solid var(--glass-border); }
    .btn-primary { background: var(--accent); border-color: var(--accent) !important; color: white !important; }
/* –°–∏–Ω–∏–π —Ñ–æ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π primary-–∫–Ω–æ–ø–∫–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –±–∞–∑–æ–≤–æ–≥–æ .btn */
.btn.btn-primary:not(:disabled) {
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: #fff !important;
  box-shadow: 0 4px 12px rgba(76,139,245,0.3);
}

.btn.btn-primary:hover:not(:disabled) {
  background: var(--accent-hover) !important;
  transform: translateY(-1px);
}

.cur-sym { opacity: .7; margin-left: 4px; }
    .strategies-section h2 { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
    .strategy-cards { display: flex; flex-direction: column; gap: 12px; }
    .strategy-card { cursor: pointer; }
    .strategy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .strategy-name { font-size: 18px; font-weight: 700; }
    .strategy-rate { font-size: 24px; font-weight: 800; color: var(--accent); }
    .strategy-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
    .strategy-features { display: flex; gap: 8px; flex-wrap: wrap; }
    .feature-tag { padding: 4px 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; font-size: 12px; }
   
   /* New Investment Strategies Design */
   .strategy-grid {
     display: flex;
     flex-direction: column;
     gap: 16px;
     margin-top: 16px;
   }
   .strategy-option {
     background: var(--glass-bg);
     border: 1px solid var(--glass-border);
     border-radius: 20px;
     padding: 20px;
     cursor: pointer;
     transition: all 0.3s ease;
     box-shadow: 0 4px 12px rgba(0,0,0,0.08);
     display: flex;
     flex-direction: column;
     align-items: center;
     text-align: center;
   }
   .strategy-option:hover {
     transform: translateY(-2px);
     box-shadow: 0 8px 25px rgba(0,0,0,0.12);
   }
   .option-tools {
     display: flex;
     gap: 8px;
     margin-bottom: 12px;
   }
   .tool-icon {
     font-size: 20px;
   }
   .rate-badge {
     background: var(--accent);
     color: white;
     padding: 8px 16px;
     border-radius: 20px;
     font-size: 18px;
     font-weight: 700;
     margin: 8px 0;
   }
   .lock-info {
     font-size: 14px;
     color: var(--text-secondary);
     margin: 8px 0;
   }
   .option-name {
     font-size: 18px;
     font-weight: 700;
     margin: 8px 0 4px;
   }
   .option-desc {
     font-size: 14px;
     color: var(--text-secondary);
     margin: 12px 0;
     line-height: 1.4;
   }
   .invest-btn {
     margin-top: 16px;
     width: 100%;
     font-size: 14px;
   }

    .status { position:fixed; top:80px; right:20px; padding:8px 12px; border-radius:12px; background:var(--glass-bg); border:1px solid var(--glass-border); font-size:12px; backdrop-filter:blur(10px); z-index:9999; transform:translateX(130%); opacity:0; transition:transform .35s ease, opacity .35s ease; pointer-events:none; color: var(--text-primary); }
    .status.show { transform:translateX(0); opacity:1; }
    .status.loading { color:var(--warning); } .status.synced { color:var(--success); } .status.error { color:var(--error); }

    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .close-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; color: var(--text-primary); display: flex; align-items: center; justify-content: center; }

    .popup { position: fixed; left: 50%; bottom: 120px; transform: translateX(-50%); background: rgba(255,255,255,0.95); color: var(--text-primary); padding: 16px 20px; border-radius: 16px; font-size: 14px; z-index: 9999; max-width: 90vw; text-align: center; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); white-space: pre-line; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }

    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 14px; }
    .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

    .amount-input, .input-field { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; color: var(--text-primary); padding: 12px; width: 100%; }
    .amount-input { font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 16px; }
    .quick-amounts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 16px 0; }
    .quick-amount-btn { padding: 12px; border-radius: 12px; font-size: 14px; color: var(--text-primary); background: var(--glass-bg); border: 1px solid var(--glass-border); }

    .method-card { border-radius: 16px; padding: 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; background: var(--glass-bg); }
    .method-card.disabled { opacity: 0.5; cursor: not-allowed; }
    .method-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: var(--text-primary); }
    .method-info p { font-size: 14px; color: var(--text-secondary); }

    .dev-notice { background: var(--warning); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; display: inline-block; margin-left: 8px; vertical-align: middle; }

    .copy-btn { border-radius: 8px; width: 48px; height: 48px; display:flex; align-items:center; justify-content:center; margin-left:8px; flex-shrink: 0;}

    .history-item.status-approved { background: rgba(52, 211, 153, 0.1); border-color: rgba(52, 211, 153, 0.3); }
    .history-item.status-pending { background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3); }
    .history-item.status-rejected, .history-item.status-canceled { background: rgba(248, 113, 113, 0.1); border-color: rgba(248, 113, 113, 0.3); }

    .bank-icons { gap: 12px; justify-content: center; }
    .bank-icon.selected { border-color: var(--accent); }
    .bank-icon {
      width: 64px;            /* –º–æ–∂–Ω–æ 72px, –µ—Å–ª–∏ —Ç–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ */
      height: 64px;
      border-radius: 12px;
      overflow: hidden;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border); /* –Ω–µ –±–µ–ª—ã–π, –∞ "—Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π" –∫–æ–Ω—Ç—É—Ä */
      flex: 0 0 auto;
      transition: all 0.2s ease;
    }
    .bank-icon:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .bank-icon.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(76,139,245,0.2); }

.bank-icon img {
  width: 100%; height: 100%;
  object-fit: cover;
  display: block;
  border-radius: inherit;
}

    #withdraw-recipient-select { width: 100%; padding: 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-primary); border-radius: 12px; margin: 16px 0; }

    /* Toggle Switch */
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--glass-bg); border: 1px solid var(--glass-border); transition: .4s; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #fff; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(24px); }

/* –°–ø—Ä—è—Ç–∞—Ç—å –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —É –í–°–ï–• .page, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–æ–ª–ª */
.page {
  -ms-overflow-style: none;   /* IE/—Å—Ç–∞—Ä—ã–π Edge */
  scrollbar-width: none;      /* Firefox */
}
.page::-webkit-scrollbar {
  display: none;              /* Chrome/Safari/–Ω–æ–≤—ã–π Edge */
}
    
/* –ë–µ–ª—ã–µ –∏–∫–æ–Ω–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è/–≥–∞–ª–æ—á–∫–∏ */
.copy-btn, .copy-btn svg { color: var(--text-primary); stroke: var(--text-primary); }

/* –¢—É–º–±–ª–µ—Ä —Å–æ–≥–ª–∞—Å–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É */
.agree-row {
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; padding:12px 14px; border-radius:12px;
  background: var(--glass-bg); border:1px solid var(--glass-border);
  margin: 8px 0 16px;
  color: var(--text-primary);
}
.agree-row a { color: var(--accent); text-decoration: underline; }

/* –ë–æ–ª—å—à–æ–π —Å–ø–∏–Ω–Ω–µ—Ä –Ω–∞ —à–∞–≥–µ 2 */
.spinner-big {
  width:56px; height:56px; border-radius:50%;
  border:4px solid rgba(255,255,255,0.15); border-top-color:#fff;
  margin: 0 auto;
  animation: sp 1s linear infinite;
}
@keyframes sp { to { transform: rotate(360deg); } }

/* –†–∞–∑—Ä–µ—à–∞–µ–º –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ –±—ã—Å—Ç—Ä—ã—Ö —Å—É–º–º–∞—Ö */
.quick-amount-btn { color: var(--text-primary); }
    
    /* Disable scroll when modal is open */
    body.modal-open { overflow: hidden; }

    /* --- FIX: disabled-–∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –º–µ–Ω—è—Ç—å –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏/–Ω–∞–≤–µ–¥–µ–Ω–∏–∏ --- */

/* –±–∞–∑–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ disabled */
.btn:disabled,
.btn[disabled],
.btn.disabled {
  pointer-events: none;            /* –Ω–µ –ø—É—Å–∫–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏/—Ç–∞—á–∞ */
  cursor: not-allowed;
  opacity: 0.6;
  transform: none !important;
  filter: none !important;
}

/* –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–∞—Å–∏–º –≤—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã hover/active/focus —É disabled */
.btn:disabled:hover,
.btn[disabled]:hover,
.btn.disabled:hover,
.btn:disabled:active,
.btn[disabled]:active,
.btn.disabled:active,
.btn:disabled:focus,
.btn[disabled]:focus,
.btn.disabled:focus {
  background: inherit !important;  /* –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–æ–Ω, —á—Ç–æ –∏ –±—ã–ª */
  box-shadow: none !important;
  transform: none !important;
  filter: none !important;
}

/* —ç—Ñ—Ñ–µ–∫—Ç—ã hover/active —Ç–æ–ª—å–∫–æ –¥–ª—è –ù–ï disabled */
.btn:hover:not(:disabled):not(.disabled),
.btn:focus-visible:not(:disabled):not(.disabled) {
  /* –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Ö–æ–≤–µ—Ä-—ç—Ñ—Ñ–µ–∫—Ç—ã ‚Äî –æ–Ω–∏ —Å—Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö */
}

.btn:active:not(:disabled):not(.disabled),
.btn.btn-primary:active:not(:disabled):not(.disabled) {
  /* –µ—Å–ª–∏ –µ—Å—Ç—å "–Ω–∞–∂–∞—Ç–æ–µ" —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî —Ç–æ–∂–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö */
}

/* –¥–ª—è iOS/Android —É–±–∏—Ä–∞–µ–º —Å–µ—Ä—É—é –≤—Å–ø—ã—à–∫—É –ø—Ä–∏ —Ç–∞–ø–µ */
button, .btn { -webkit-tap-highlight-color: transparent; }

    /* Boot overlay */
    #boot-screen {
      position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999;
      display: grid; place-items: center; opacity: 1; pointer-events: auto;
      transition: opacity .5s ease;
    }
    #boot-center { width: 90%; max-width: 420px; text-align: center; }
    #boot-title {
      font-size: 28px; font-weight: 800; letter-spacing: .5px;
      color: var(--text-primary); margin-bottom: 18px;
    }
    #boot-progress {
      width: 100%; height: 10px; border-radius: 999px;
      background: rgba(0,0,0,0.05); overflow: hidden; position: relative;
    }
    #boot-progress-fill {
      position: absolute; left: 0; top: 0; bottom: 0; width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: inherit; transition: width .4s ease; /* –∏–º–∏—Ç–∞—Ü–∏—è "–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ" */
    }
    #boot-hint { margin-top: 12px; color: var(--text-secondary); font-size: 13px; }

/* –≤—ã–ª–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∫ —É–≥–ª—É */
#boot-screen.fly-out #boot-title {
  position: fixed; left: 16px; top: 12px; transform-origin: top left;
  animation: flyToCorner .6s cubic-bezier(.22,.61,.36,1) forwards;
}
@keyframes flyToCorner {
  0% { transform: translate(0,0) scale(1); opacity: 1; }
  100% { transform: translate(-42vw,-38vh) scale(.72); opacity: .0; }
}

/* —Å–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π */
#boot-screen.hidden { opacity: 0; pointer-events: none; }

/* –ü–æ–ø–∞–ø —Å—Ç–∞—Ç—É—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—à–∏–±–æ–∫ */
.status { display: none !important; } /* –ø—Ä—è—á–µ–º —Å—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å-–±–∞—Ä */

/* –ì–ª–æ–±–∞–ª—å–Ω–æ –ø—Ä—è—á–µ–º –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (—Å–∫—Ä–æ–ª–ª –æ—Å—Ç–∞—ë—Ç—Å—è –∫–æ–ª–µ—Å–æ–º/—Ç–∞—á–µ–º) */
html, body, .page, .modal, .modal .modal-content, #app, #root {
  -ms-overflow-style: none;     /* IE/—Å—Ç–∞—Ä—ã–π Edge */
  scrollbar-width: none;        /* Firefox */
}
html::-webkit-scrollbar,
body::-webkit-scrollbar,
.page::-webkit-scrollbar,
.modal::-webkit-scrollbar,
*::-webkit-scrollbar {
  width: 0 !important;
  height: 0 !important;
  display: none !important;
}
    /* –°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã –≤ —Å—Ç–∞—Ç–∞—Ö ‚Äî —Ç–æ–π –∂–µ —è—Ä–∫–æ—Å—Ç–∏, —á—Ç–æ –∏ —á–∏—Å–ª–æ */
.stat-value .cur-sym { opacity: 1 !important; color: currentColor !important; }

  </style>
</head>
<body>
  <!-- Boot screen -->
<div id="boot-screen">
  <div id="boot-center">
    <div id="boot-title">HomerBot</div>
    <div id="boot-progress">
      <div id="boot-progress-fill"></div>
    </div>
    <div id="boot-hint">–ì–æ—Ç–æ–≤–∏–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—É‚Ä¶</div>
  </div>
</div>

    <div class="app-container">
        <div class="header">
          <div class="header-content">
            <div id="appBrand" style="opacity:0">HomerBot</div>
            <button class="profile-btn" onclick="openModal('profile')">
              <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </button>
          </div>
        </div>
        <div id="status" class="status"></div>

        <div id="pageContainer">
            <div class="page active" id="pageHome">
                <div class="card">
                    <div class="balance-section">
                        <div class="balance-label-container">
                            <div class="balance-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                            <div class="balance-currency" onclick="toggleCurrencyDropdown(event)">
                                <span id="currentCurrency">RUB</span><span class="currency-arrow">‚ñº</span>
                                <div class="currency-dropdown" id="currencyDropdown">
                                    <div class="currency-option active" onclick="selectCurrency('RUB', event)">RUB</div>
                                    <div class="currency-option" onclick="selectCurrency('USD', event)">USD</div>
                                    <div class="currency-option" onclick="selectCurrency('EUR', event)">EUR</div>
                                </div>
                            </div>
                        </div>
                        <div class="balance-main" id="balanceValue">‚Äî</div>
                        <div class="balance-stats">
                            <div class="balance-stat">
                              <div class="stat-label">–°–≤–æ–±–æ–¥–Ω–æ</div>
                              <div class="stat-value" id="freeBalance">‚Äî</div>
                            </div>
                            <div class="balance-stat">
                              <div class="stat-label">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ</div>
                              <div class="stat-value stat-positive" id="investedBalance">‚Äî</div>
                            </div>
                            <div class="balance-stat">
                              <div class="stat-label">–î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è</div>
                              <div class="stat-value stat-positive" id="todayIncome">‚Äî</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                  <button class="btn btn-primary" onclick="openModal('deposit')">–î–µ–ø–æ–∑–∏—Ç</button>
                  <button class="btn" onclick="openModal('withdraw')">–í—ã–≤–æ–¥</button>
                </div>

                <div class="strategies-section">
                    <h2>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</h2>
                    <div class="strategy-grid">
                        <div class="strategy-option" onclick="openModal('strategy16')">
                          <div class="option-tools">
                            <span class="tool-icon">üè¶</span>
                          </div>
                          <h3 class="option-name">–õ–∏–∫–≤–∏–¥–Ω—ã–π 16%</h3>
                          <div class="rate-badge">16% –≥–æ–¥–æ–≤—ã—Ö</div>
                          <div class="lock-info">–í—ã–≤–æ–¥ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –±–µ–∑ —à—Ç—Ä–∞—Ñ–∞</div>
                          <p class="option-desc">–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—É—à–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –¢–æ–ª—å–∫–æ –Ω–∞–¥–µ–∂–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –≤–∫–ª–∞–¥—ã.</p>
                          <button class="btn btn-primary invest-btn" onclick="event.stopPropagation(); openModal('strategy16')">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                        <div class="strategy-option" onclick="openModal('strategy17')">
                          <div class="option-tools">
                            <span class="tool-icon">üè¶</span>
                            <span class="tool-icon">üìà</span>
                          </div>
                          <h3 class="option-name">–°—Ç–∞–±–∏–ª—å–Ω—ã–π 17%</h3>
                          <div class="rate-badge">17% –≥–æ–¥–æ–≤—ã—Ö</div>
                          <div class="lock-info">–ó–∞–º–æ—Ä–æ–∑–∫–∞ –Ω–∞ 30 –¥–Ω–µ–π (–¥–æ—Å—Ä–æ—á–Ω—ã–π —Å –ø–æ—Ç–µ—Ä–µ–π %)</div>
                          <p class="option-desc">–ë–∞–ª–∞–Ω—Å —Ä–∏—Å–∫–∞ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏. –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –≤–∫–ª–∞–¥—ã + –¶–§–ê —É–º–µ—Ä–µ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞.</p>
                          <button class="btn btn-primary invest-btn" onclick="event.stopPropagation(); openModal('strategy17')">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                        <div class="strategy-option" onclick="openModal('strategy18')">
                          <div class="option-tools">
                            <span class="tool-icon">üè¶</span>
                            <span class="tool-icon">üìà</span>
                            <span class="tool-icon">üí∞</span>
                          </div>
                          <h3 class="option-name">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π 18%</h3>
                          <div class="rate-badge">18% –≥–æ–¥–æ–≤—ã—Ö</div>
                          <div class="lock-info">–ó–∞–º–æ—Ä–æ–∑–∫–∞ –Ω–∞ 90 –¥–Ω–µ–π (–¥–æ—Å—Ä–æ—á–Ω—ã–π —Å –ø–æ—Ç–µ—Ä–µ–π %)</div>
                          <p class="option-desc">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å. –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –≤–∫–ª–∞–¥—ã + –¶–§–ê + –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –∑–∞–π–º—ã.</p>
                          <button class="btn btn-primary invest-btn" onclick="event.stopPropagation(); openModal('strategy18')">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="pagePortfolio">
              <div class="card">
                <h2 style="margin-bottom: 16px;">–ú–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å</h2>
                <div id="portfolio-list"></div>
                <p id="portfolio-placeholder" style="text-align: center; padding: 40px 0;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π.</p>
              </div>
            </div>

            <div class="page" id="pageHistory">
              <div class="card">
                <h2 style="margin-bottom: 16px;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
                <div class="filter-chips">
                  <div class="filter-chip active" onclick="applyHistoryFilter(this, 'all')">–í—Å–µ</div>
                  <div class="filter-chip" onclick="applyHistoryFilter(this, 'deposit')">–î–µ–ø–æ–∑–∏—Ç</div>
                  <div class="filter-chip" onclick="applyHistoryFilter(this, 'withdraw')">–í—ã–≤–æ–¥</div>
                  <div class="filter-chip" onclick="applyHistoryFilter(this, 'invest')">–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</div>
                </div>
                <div id="history-list"></div>
                <button class="btn" id="load-more-history" style="width:100%; margin-top:16px; display:none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë</button>
                <p id="history-placeholder" style="text-align: center; padding: 40px 0;">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞.</p>
              </div>
            </div>
        </div>

        <div class="bottom-nav">
          <div class="nav-items">
            <div class="nav-item active" onclick="openPage('Home')">
              <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
              <span class="nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
            </div>
            <div class="nav-item" onclick="openPage('Portfolio')">
              <svg class="nav-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
              <span class="nav-label">–ü–æ—Ä—Ç—Ñ–µ–ª—å</span>
            </div>
            <div class="nav-item" onclick="openPage('History')">
              <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
              <span class="nav-label">–ò—Å—Ç–æ—Ä–∏—è</span>
            </div>
          </div>
        </div>
    </div>

    <!-- Profile -->
    <div id="modalProfile" class="modal-overlay">
      <div class="modal">
        <div class="modal-header"><h2 class="modal-title">–ü—Ä–æ—Ñ–∏–ª—å</h2><button class="close-btn" onclick="closeModal('profile')">‚úï</button></div>
        <div class="card" style="text-align: center; margin: 0;">
          <h3 id="profileUsername">‚Äî</h3>
          <p style="color: var(--text-secondary); font-size: 14px;">Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
        </div>
        <div style="margin-top: 16px;">
          <div class="method-card disabled"><div class="method-info"><h3>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å <span class="dev-notice">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span></h3><p>KYC, –ü–∏–Ω-–∫–æ–¥, –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞</p></div></div>
          <div class="method-card disabled"><div class="method-info"><h3>–Ø–∑—ã–∫ <span class="dev-notice">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span></h3><p>–†—É—Å—Å–∫–∏–π, English</p></div></div>
          <div class="method-card" onclick="window.open('https://docs.google.com/document/d/1Rv3N2iTgwHXhTkSgv-BwKLrekVpZtoGfU_ct2lDw00g/edit?usp=sharing', '_blank')"><div class="method-info"><h3>–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3><p>–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</p></div></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-top:16px; background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:12px;">
          <label for="devModeToggle">–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</label>
          <label class="toggle-switch"><input type="checkbox" id="devModeToggle"><span class="slider"></span></label>
          <div id="devVersion" class="dev-version" style="display:none; text-align:center; font-size:12px; opacity:.7; margin-top:6px;">
  v1
</div>
        </div>
      </div>
    </div>

<!-- Deposit -->
<div id="modalDeposit" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2 class="modal-title">–î–µ–ø–æ–∑–∏—Ç</h2>
        <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É –¥–µ–ø–æ–∑–∏—Ç–∞</div>
      </div>
      <button class="close-btn" onclick="closeModal('deposit')">‚úï</button>
    </div>

    <!-- –®–∞–≥ 1: –≤–≤–æ–¥ —Å—É–º–º—ã + —Å–æ–≥–ª–∞—Å–∏–µ -->
    <div id="deposit-step1">
      <input type="text" id="depositAmount" class="amount-input" placeholder="0" oninput="formatAmountInput(this)" inputmode="decimal">
      <div class="quick-amounts">
        <button class="quick-amount-btn" onclick="setDepositAmount(1000)">1 000</button>
        <button class="quick-amount-btn" onclick="setDepositAmount(5000)">5 000</button>
        <button class="quick-amount-btn" onclick="setDepositAmount(10000)">10 000</button>
        <button class="quick-amount-btn" onclick="setDepositAmount(25000)">25 000</button>
        <button class="quick-amount-btn" onclick="setDepositAmount(50000)">50 000</button>
        <button class="quick-amount-btn" onclick="setDepositAmount(100000)">100 000</button>
      </div>

      <!-- –¢—É–º–±–ª–µ—Ä —Å–æ–≥–ª–∞—Å–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
      <div class="agree-row">
        <span>–°–æ–≥–ª–∞—Å–µ–Ω —Å&nbsp;<a href="https://docs.google.com/document/d/1Rv3N2iTgwHXhTkSgv-BwKLrekVpZtoGfU_ct2lDw00g/edit?usp=sharing" target="_blank">—É—Å–ª–æ–≤–∏—è–º–∏</a></span>
        <label class="toggle-switch">
          <input type="checkbox" id="depositAgree">
          <span class="slider"></span>
        </label>
      </div>
<button class="btn btn-primary" id="depositConfirmBtn" style="width:100%" disabled>
  –ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å—á—ë—Ç –ø–æ –°–ë–ü
</button>
    </div>

    <!-- –®–∞–≥ 2: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ + –Ω–æ–º–µ—Ä –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ + –æ—Ç–º–µ–Ω–∞ -->
<div id="deposit-step2" style="display:none;">
  <div class="spinner-big" aria-label="–ó–∞–≥—Ä—É–∑–∫–∞"></div>

  <div class="glass-card" style="margin-top:16px;">
    <!-- –°—É–º–º–∞ -->
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <input type="text" id="deposit-amount-display" class="input-field" value="‚Äî" readonly
             style="text-align:center;font-size:18px;font-weight:700;">
      <button class="copy-btn" onclick="copyToClipboard(document.getElementById('deposit-amount-display').value, this)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
    </div>

    <!-- –ö–æ–¥ –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <input type="text" id="deposit-short-display" class="input-field" value="‚Äî" readonly
             style="text-align:center;font-size:18px;font-weight:700;">
      <button class="copy-btn" onclick="copyToClipboard((document.getElementById('deposit-short-display').value||'').replace('#',''), this)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
    </div>

    <div style="font-size:13px;color:var(--text-secondary);text-align:center;margin-bottom:10px;">
      <b>–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û</b> —É–∫–∞–∂–∏—Ç–µ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–µ—Ä–µ–≤–æ–¥—É –¥–∞–Ω–Ω—ã–π –∫–æ–¥, —á—Ç–æ–±—ã –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
    </div>

    <!-- –¢–µ–ª–µ—Ñ–æ–Ω -->
    <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
      <input type="text" class="input-field" value="+7 (916) 643-54-94" readonly
             style="text-align:center;font-size:18px;font-weight:700;">
      <button class="copy-btn" onclick="copyToClipboard('+79166435494', this)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
    </div>

    <div style="font-size:13px;color:var(--text-secondary);margin-top:12px;">
      –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ –°–ë–ü (–¢-–ë–∞–Ω–∫) –ø–æ –¥–∞–Ω–Ω–æ–º—É –Ω–æ–º–µ—Ä—É –¥–ª—è –∑–∞—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á—ë—Ç.
      –ü–æ—Å–ª–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫.
    </div>
  </div>
</div>
    </div> <!-- / .modal -->
</div> <!-- / #modalDeposit -->

    <!-- Withdraw -->
    <div id="modalWithdraw" class="modal-overlay">
      <div class="modal">
        <div class="modal-header"><h2 class="modal-title">–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2><button class="close-btn" onclick="closeModal('withdraw')">‚úï</button></div>

        <div id="withdraw-method-choice" style="display:none;">
<div class="method-card" onclick="selectWithdrawMethod('sbp')">
  <div class="method-info"><h3>–ü–µ—Ä–µ–≤–æ–¥ –ø–æ –°–ë–ü</h3></div>
</div>
          <div class="method-card disabled"><div class="method-info"><h3>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ <span class="dev-notice">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span></h3></div></div>
          <div class="method-card disabled"><div class="method-info"><h3>–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã <span class="dev-notice">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</span></h3></div></div>
        </div>

        <div id="withdraw-view" style="display:none;">
          <p style="text-align: center; color: var(--text-secondary);">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞: <b id="withdrawAvailable">0.00 ‚ÇΩ</b></p>
          <select id="withdraw-recipient-select"></select>
          <input type="text" class="amount-input" id="withdrawAmount" placeholder="0" oninput="formatAmountInput(this)" inputmode="decimal">
          <button class="btn btn-primary" id="withdrawConfirmBtn" style="width:100%">–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        </div>

        <div id="withdraw-add-sbp-form" style="display:none;">
          <input type="text" class="input-field" id="withdraw-sbp-phone" style="text-align:center; margin-bottom: 16px;" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –°–ë–ü">
          <p style="text-align:center; color: var(--text-secondary); font-size: 14px;">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</p>
<div class="bank-icons">
  <div class="bank-icon" data-bank="Alfa">
    <img src="./assets/alphabank.jpg" alt="–ê–ª—å—Ñ–∞" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'–ê–ª—å—Ñ–∞'}))">
  </div>
  <div class="bank-icon" data-bank="Sberbank">
    <img src="./assets/sberbank.jpg" alt="–°–±–µ—Ä–±–∞–Ω–∫" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'–°–±–µ—Ä–±–∞–Ω–∫'}))">
  </div>
  <div class="bank-icon" data-bank="TBank">
    <img src="./assets/tbank.jpg" alt="–¢-–ë–∞–Ω–∫" onerror="this.replaceWith(Object.assign(document.createElement('span'),{textContent:'–¢-–ë–∞–Ω–∫'}))">
  </div>
</div>
          <button class="btn btn-primary" id="save-sbp-btn" style="width:100%; margin-top: 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
      </div>
    </div>
    
    <!-- Strategies -->
<div id="modalStrategy16" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">–ì–∏–±–∫–∞—è 16%</h2>
      <button class="close-btn" onclick="closeModal('strategy16')">‚úï</button>
    </div>
    <div class="glass-card" style="margin-bottom:12px;">
      <p style="color:var(--text-secondary);font-size:14px;">
        ‚Ä¢ –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ, –≤—ã–≤–æ–¥ –±–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤.<br>
        ‚Ä¢ –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –º–æ–º–µ–Ω—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –±—É–¥—É—â–µ–º –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π.<br>
        ‚Ä¢ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è ¬´–ø–æ–¥—É—à–∫–∏¬ª ‚Äî –º–æ–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å/–≤—ã–≤–µ—Å—Ç–∏ –≤ –ª—é–±–æ–π –¥–µ–Ω—å.
      </p>
    </div>
    <button class="btn btn-primary" onclick="openNewInvestment('16')" style="width:100%;">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>
    <div id="modalStrategy17" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">30 –¥–Ω–µ–π 17%</h2>
      <button class="close-btn" onclick="closeModal('strategy17')">‚úï</button>
    </div>
    <div class="glass-card" style="margin-bottom:12px;">
      <p style="color:var(--text-secondary);font-size:14px;">
        ‚Ä¢ –ó–∞–º–æ—Ä–æ–∑–∫–∞ –Ω–∞ 30 –¥–Ω–µ–π, —á–∞—Å—Ç–∏—á–Ω—ã–π –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ —Å –ø–æ—Ç–µ—Ä–µ–π –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞.<br>
        ‚Ä¢ –°–æ—Å—Ç–∞–≤: –≤–∫–ª–∞–¥—ã + –¶–§–ê —É–º–µ—Ä–µ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞.<br>
        ‚Ä¢ –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å—é –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é —Å—Ä–µ–¥—Å—Ç–≤.
      </p>
    </div>
    <button class="btn btn-primary" onclick="openNewInvestment('17')" style="width:100%;">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>
   <div id="modalStrategy18" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">90 –¥–Ω–µ–π 18%</h2>
      <button class="close-btn" onclick="closeModal('strategy18')">‚úï</button>
    </div>
    <div class="glass-card" style="margin-bottom:12px;">
      <p style="color:var(--text-secondary);font-size:14px;">
        ‚Ä¢ –ó–∞–º–æ—Ä–æ–∑–∫–∞ –Ω–∞ 90 –¥–Ω–µ–π, –¥–æ—Å—Ä–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ ‚Äî —Å –ø–æ—Ç–µ—Ä–µ–π –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤.<br>
        ‚Ä¢ –°–æ—Å—Ç–∞–≤: –≤–∫–ª–∞–¥—ã, –¶–§–ê, —á–∞—Å—Ç–∏—á–Ω–æ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –∑–∞–π–º—ã ‚Äî –≤—ã—à–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, –≤—ã—à–µ —Ä–∏—Å–∫ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.<br>
        ‚Ä¢ –î–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É –∏ –≥–æ—Ç–æ–≤ –∫ –æ–∂–∏–¥–∞–Ω–∏—é.
      </p>
    </div>
    <button class="btn btn-primary" onclick="openNewInvestment('18')" style="width:100%;">–ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
  </div>
</div>
    <!-- New Investment -->
    <div id="modalNewInvestment" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">–ù–æ–≤–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è</h2>
          <button class="close-btn" onclick="closeModal('newInvestment')">‚úï</button>
        </div>
        <div class="input-field" id="niStrategyReadonly" style="text-align:center;font-weight:700;margin-bottom:12px;">‚Äî</div>
        <input type="text" class="amount-input" id="niAmount" placeholder="0" oninput="formatAmountInput(this)" inputmode="decimal">
        <button class="btn btn-primary" style="width:100%" id="niConfirmBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>

    <script>
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIAGI3xqdLJeOGHs8cgvLbMll5x82pc7clF_HTmQBQkc-5jbONBaq27NPZuaQAfuR_oA/exec';

      // -------- STATE --------
      let username = null;
      let serverState = { balance: 0, rate: 16, monthBase: 0, lockedAmount: 0, history: [], portfolio: [] };
      let userPrefs = { currency: 'RUB', sbpMethods: [] };
      let devMode = false;
      let lastChosenRate = null;
let syncTimer = null;
let syncInFlight = false;
let syncBackoffMs = 20000;       // —Å—Ç–∞—Ä—Ç 20—Å
const SYNC_BACKOFF_MAX = 60000;  // –º–∞–∫—Å–∏–º—É–º 60—Å
      let lastDepositAmount = 0;
let lastDepositShortId = null;
      let hasPendingDeposit = false;


      // Status: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º loading/synced —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
      let hasShownInitialStatus = false;

      // –ö—É—Ä—Å—ã –∏ –¥–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è (–≤ RUB) –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞
      const exchangeRates = { RUB: 1, USD: 0.011, EUR: 0.010 };
      let latestTodayIncomeRub = 0;

      // –ò—Å—Ç–æ—Ä–∏—è ‚Äî –ø–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä
      let historyOffset = 0;
      // –í—ã–≤–æ–¥: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –≤—ã–±—Ä–∞–ª "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã"
let withdrawAddingNew = false;
      const HISTORY_PAGE_SIZE = 10;
      let currentHistoryFilterType = 'all';
      let filteredHistory = [];

      // -------- HELPERS --------
      const fmtMoney = (val, currency) => {
        const rate = exchangeRates[currency];
        const num = (Number(val) || 0) * rate;
        return num.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      };

function parseAmount(str) {
  if (!str) return 0;
  const s = String(str).replace(/\s/g, '').replace(',', '.');
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

      // –°–ø—Ä—è—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–π —à—É–º, –Ω–µ —Ç—Ä–æ–≥–∞—è –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏
window.addEventListener('unhandledrejection', (e) => {
  const msg = String((e.reason && e.reason.message) || e.reason || '');
  if (msg.includes('A listener indicated an asynchronous response')) {
    e.preventDefault(); // –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ –∫–æ–Ω—Å–æ–ª—å
  }
});

window.addEventListener('error', (e) => {
  const msg = String(e.message || '');
  if (msg.includes('A listener indicated an asynchronous response')) {
    e.stopImmediatePropagation();
  }
});

// —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —á–∞—Å—Ç–∏
function formatAmountInput(input) {
  let v = (input.value || '').replace(/[^\d.,]/g, '');
  // –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —É–¥–∞–ª—è–µ–º
  const firstSep = v.search(/[.,]/);
  if (firstSep !== -1) {
    const intPart = v.slice(0, firstSep).replace(/[.,]/g, '');
    const fracPartRaw = v.slice(firstSep + 1).replace(/[^\d]/g, '');
    const fracPart = fracPartRaw.slice(0, 2); // –¥–æ 2 –∑–Ω–∞–∫–æ–≤
    input.value = formatIntWithSpaces(intPart) + ',' + fracPart;
  } else {
    input.value = formatIntWithSpaces(v.replace(/[.,]/g, ''));
  }
}
function formatIntWithSpaces(s) {
  if (!s) return '';
  const num = s.replace(/\D/g, '');
  return num.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
}

function scheduleSync(delay = syncBackoffMs) {
  clearTimeout(syncTimer);
  const jitter = Math.floor(Math.random() * 3000);
  const next = Math.min(Math.max(delay, 5000), SYNC_BACKOFF_MAX); // 5—Å..60—Å
  syncTimer = setTimeout(() => syncBalance(true), next + jitter);
}
document.addEventListener('visibilitychange', () => {
  // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–∏–Ω–≥
  if (!document.hidden) scheduleSync(2000);
});
      
      function showPopup(text, timeout = 3000) {
        const el = document.createElement('div');
        el.className = 'popup';
        el.textContent = text;
        document.body.appendChild(el);
        setTimeout(() => {
          el.style.transition = 'opacity .25s ease, transform .25s ease';
          el.style.opacity = '0';
          el.style.transform = 'translateX(-50%) translateY(10px)';
          setTimeout(() => el.remove(), 250);
        }, timeout);
      }

      function setStatus(text, type = 'loading') {
        const el = document.getElementById('status');
        if (!el) return;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "loading/synced" —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        if ((type === 'loading' || type === 'synced') && hasShownInitialStatus) return;

        el.textContent = text;
        el.className = `status ${type} show`;

        if (type === 'error') {
          setTimeout(() => el.classList.remove('show'), 3000);
        } else if (type === 'synced') {
          setTimeout(() => el.classList.remove('show'), 1500);
          hasShownInitialStatus = true;
        }
      }

function computeHasPendingDeposit() {
  const h = serverState.history || [];
  return h.some(x => x.type === 'DEPOSIT' && x.status === 'PENDING');
}
function showDepositStep(step) {
  const s1 = document.getElementById('deposit-step1');
  const s2 = document.getElementById('deposit-step2');
  if (!s1 || !s2) return;
  if (step === 1) { s1.style.display = 'block'; s2.style.display = 'none'; }
  else { s1.style.display = 'none'; s2.style.display = 'block'; }
}
      // –î–µ–ø–æ–∑–∏—Ç: —Ç—É–º–±–ª–µ—Ä —Å–æ–≥–ª–∞—Å–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –∫–Ω–æ–ø–∫–∏
function updateDepositBtnState() {
  const agree = document.getElementById('depositAgree');
  const btn = document.getElementById('depositConfirmBtn');
  if (btn) btn.disabled = !(agree && agree.checked);
}

      
      // -------- NAV & MODALS --------
      function openPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page${pageId}`).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => {
          n.classList.remove('active');
          if (n.onclick.toString().includes(`'${pageId}'`)) n.classList.add('active');
        });
      }
// NEW: –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ –º–æ–¥–∞–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –Ω–æ–≤–æ–π
function closeAllModals() {
  document.querySelectorAll('.modal-overlay.active').forEach(m => {
    m.classList.remove('active');
    m.style.display = '';
  });
  document.body.classList.remove('modal-open');
}

function openModal(modalId) {
  // NEW: –≥–∞—Å–∏–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –º–æ–¥–∞–ª–∫–∏
  closeAllModals();

  const modal = document.getElementById(`modal${modalId.charAt(0).toUpperCase() + modalId.slice(1)}`);
  if (!modal) return;
  modal.classList.add('active');
  modal.style.display = 'flex';          // NEW: –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å
  document.body.classList.add('modal-open');

        // –°–ø–µ—Ü-–ª–æ–≥–∏–∫–∞ –¥–ª—è "–í—ã–≤–æ–¥"
if (modalId === 'withdraw') {
  // –ù–æ–≤—ã–π –∑–∞—Ö–æ–¥ –≤ –º–æ–¥–∞–ª–∫—É ‚Äî –∑–∞–±—ã–≤–∞–µ–º –ø—Ä–æ—à–ª–æ–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã¬ª
  withdrawAddingNew = false;

  const methodChoice = document.getElementById('withdraw-method-choice');
  const addForm      = document.getElementById('withdraw-add-sbp-form');
  const view         = document.getElementById('withdraw-view');
  const sel          = document.getElementById('withdraw-recipient-select');

  // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
  // - –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã ‚Üí —Å—Ä–∞–∑—É —ç–∫—Ä–∞–Ω –≤—ã–≤–æ–¥–∞;
  // - –µ—Å–ª–∏ –Ω–µ—Ç ‚Üí —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞.
  const hasMethods = (userPrefs.sbpMethods || []).length > 0;

  if (hasMethods) {
    if (methodChoice) methodChoice.style.display = 'none';
    if (addForm)      addForm.style.display      = 'none';
    if (view)         view.style.display         = 'block';
    if (sel) {
      // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –≤—ã–±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∞–ª—å–Ω—ã–π —Ä–µ–∫–≤–∏–∑–∏—Ç (–Ω–µ "add_new")
      if (sel.value === 'add_new' || sel.selectedIndex < 0) sel.selectedIndex = 0;
    }
  } else {
    if (methodChoice) methodChoice.style.display = 'block';
    if (addForm)      addForm.style.display      = 'none';
    if (view)         view.style.display         = 'none';
    if (sel) sel.selectedIndex = -1; // –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ
  }

  // –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ—à–ª–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
  const modalEl = document.getElementById('modalWithdraw');
  const inner   = modalEl && modalEl.querySelector('.modal');
  if (inner) inner.scrollTop = 0;
}
if (modalId === 'deposit') {
  if (hasPendingDeposit) {
  // –ø–æ–ø—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π PENDING –¥–µ–ø–æ–∑–∏—Ç
  const pending = (serverState.history || [])
    .filter(x => x.type === 'DEPOSIT' && x.status === 'PENDING')
    .sort((a,b) => b.date - a.date)[0];
  const amt = pending ? Math.abs(Number(pending.amount||0)) : lastDepositAmount;
  const sid = pending ? pending.shortId : lastDepositShortId;
  hydrateDepositStep2(amt || 0, sid || null);
}
  showDepositStep(hasPendingDeposit ? 2 : 1);
  // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –≤—Ö–æ–¥–µ
  setTimeout(updateDepositBtnState, 0);
}
}

function closeModal(modalId) {
  const modal = document.getElementById(`modal${modalId.charAt(0).toUpperCase() + modalId.slice(1)}`);
  if (modal) {
    modal.classList.remove('active');
    modal.style.display = ''; // NEW
  }
  if (modalId === 'withdraw') withdrawAddingNew = false;
  const anyOpen = Array.from(document.querySelectorAll('.modal-overlay')).some(m => m.classList.contains('active'));
  if (!anyOpen) document.body.classList.remove('modal-open');
}

      // -------- BALANCE AUTOSIZE --------
      function fitBalanceText() {
        const el = document.getElementById('balanceValue');
        if (!el) return;
        const max = 42, min = 18;
        el.style.fontSize = max + 'px';
        const limit = el.parentElement ? el.parentElement.clientWidth - 24 : el.clientWidth;
        let size = max, safety = 50;
        while (el.scrollWidth > limit && size > min && safety-- > 0) {
          size -= 1;
          el.style.fontSize = size + 'px';
        }
      }
      window.addEventListener('resize', fitBalanceText);

      // -------- RENDER --------
      function updateDashboard(data) {
        serverState = { ...serverState, ...data };
        const { balance, monthBase, lockedAmount } = serverState;
        const currency = userPrefs.currency;
        const currencySymbol = currency === 'RUB' ? '‚ÇΩ' : (currency === 'USD' ? '$' : '‚Ç¨');

        document.getElementById('balanceValue').textContent = `${fmtMoney(balance, currency)} ${currencySymbol}`;
        document.getElementById('freeBalance').textContent = `${fmtMoney(balance - lockedAmount, currency)} ${currencySymbol}`;
        document.getElementById('investedBalance').textContent = `${fmtMoney(monthBase, currency)} ${currencySymbol}`;
        document.getElementById('profileUsername').textContent = username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('withdrawAvailable').innerHTML = `${fmtMoney(balance - lockedAmount, currency)} ${currencySymbol}`;

        // –î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∞–ª—é—Ç—É
renderTodayIncome();


        fitBalanceText();
      }
function renderTodayIncome() {
  const currency = userPrefs.currency;
  const symbol = currency === 'RUB' ? '‚ÇΩ' : (currency === 'USD' ? '$' : '‚Ç¨');
  const el = document.getElementById('todayIncome');
  if (el) el.innerHTML = `+${fmtMoney(latestTodayIncomeRub, currency)} <span class="cur-sym">${symbol}</span>`;
}
      function getHistoryFilterPredicate(type) {
        if (!type || type === 'all') return () => true;
        const map = { deposit: 'DEPOSIT', withdraw: 'WITHDRAW', invest: 'INVEST' };
        const wanted = map[type] || null;
        return (item) => !wanted || (item.type === wanted);
      }

      function recomputeFilteredHistory() {
        const pred = getHistoryFilterPredicate(currentHistoryFilterType);
        filteredHistory = (serverState.history || []).filter(pred);
      }

      function renderHistoryPage(append = false) {
        const list = document.getElementById('history-list');
        const placeholder = document.getElementById('history-placeholder');
        const loadMoreBtn = document.getElementById('load-more-history');

        if (!append) {
          historyOffset = 0;
          list.innerHTML = '';
        }

        const slice = filteredHistory.slice(historyOffset, historyOffset + HISTORY_PAGE_SIZE);

        if (!append && filteredHistory.length === 0) {
          placeholder.style.display = 'block';
          loadMoreBtn.style.display = 'none';
          return;
        }
        placeholder.style.display = 'none';

        const currency = userPrefs.currency;
        const currencySymbol = currency === 'RUB' ? '‚ÇΩ' : (currency === 'USD' ? '$' : '‚Ç¨');

        slice.forEach(item => {
          const el = document.createElement('div');
          el.className = `glass-card history-item status-${item.status.toLowerCase()}`;

          const date = new Date(item.date);
          const timeStr = `${String(date.getDate()).padStart(2,'0')}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getFullYear()).slice(-2)} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;

          const absAmount = Math.abs(item.amount);
          let title = '', amountStr = '', subTitle = '';

          switch(item.type) {
            case 'DEPOSIT':  title = '–î–µ–ø–æ–∑–∏—Ç';    amountStr = `+${fmtMoney(absAmount, currency)}`; break;
            case 'WITHDRAW': title = '–í—ã–≤–æ–¥';      amountStr = `-${fmtMoney(absAmount, currency)}`; break;
            case 'INVEST':
              title = '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è';
              amountStr = `${fmtMoney(absAmount, currency)}`;
              subTitle = `<div style="font-size:12px;color:var(--text-secondary);">–°—Ç—Ä–∞—Ç–µ–≥–∏—è: ${item.rate}%</div>`;
              break;
          }

          const uid = devMode ? ` ¬∑ #${item.shortId}` : '';
          el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div><b>${title}</b>${subTitle}<div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">${timeStr}${uid}</div></div>
              <div style="font-weight:700;font-size:16px;text-align:right;">${amountStr} ${currencySymbol}</div>
            </div>`;
          list.appendChild(el);
        });

        historyOffset += slice.length;
        loadMoreBtn.style.display = historyOffset < filteredHistory.length ? 'block' : 'none';
      }

      function applyHistoryFilter(element, type) {
        if (type) currentHistoryFilterType = type;
        if (element) {
          document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
          element.classList.add('active');
        }
        recomputeFilteredHistory();
        renderHistoryPage(false);
      }

      function renderPortfolio(portfolio) {
        const list = document.getElementById('portfolio-list');
        const placeholder = document.getElementById('portfolio-placeholder');
        list.innerHTML = '';
        if (!portfolio || portfolio.length === 0) { placeholder.style.display = 'block'; return; }
        placeholder.style.display = 'none';

        const currency = userPrefs.currency;
        const currencySymbol = currency === 'RUB' ? '‚ÇΩ' : (currency === 'USD' ? '$' : '‚Ç¨');

        portfolio.forEach(item => {
          const el = document.createElement('div');
          el.className = 'glass-card';
          const uid = devMode ? `<b>#${item.shortId}</b> ¬∑ ` : '';
          el.innerHTML = `${uid}${fmtMoney(item.amount, currency)} ${currencySymbol} ¬∑ <b>${item.rate}%</b>`;
          list.appendChild(el);
        });
      }

      // -------- API --------
      async function apiGet(path) {
        try {
          const r = await fetch(`${SCRIPT_URL}${path}`);
          if (!r.ok) throw new Error(`Network error: ${r.statusText}`);
          const data = await r.json();
          if (!data) throw new Error("Empty response from server");
          return data;
        } catch (e) {
          console.error("API Fetch Error:", e);
          return { success: false, error: e.message };
        }
      }

async function initializeApp() {
  try {
    // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ –∏ —Å—Ç–∞—Ä—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    startBootScreen();
    setBootProgress(10);

    // Telegram init + –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const tg = window.Telegram?.WebApp;
    tg?.expand?.();
    username = (tg?.initDataUnsafe?.user?.username) || 'marulin';

    setBootProgress(25);

    // –ü–µ—Ä–≤–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –±—ç–∫–µ–Ω–¥–∞
    const data = await apiGet(`?action=getInitialData&username=${encodeURIComponent(username)}`);
    if (!data || !data.success) throw new Error(data?.error || 'Failed to get initial data');

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏/—Å–æ—Å—Ç–æ—è–Ω–∏–µ
    userPrefs = data.userPrefs || { currency: 'RUB', sbpMethods: [] };
    devMode = localStorage.getItem('devMode') === 'true';
    const devToggle = document.getElementById('devModeToggle');
    if (devToggle) devToggle.checked = devMode;
    const dv = document.getElementById('devVersion');
if (dv) dv.style.display = devMode ? 'block' : 'none';

    serverState = { ...serverState, ...data };
    hasPendingDeposit = computeHasPendingDeposit();

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
    setBootProgress(60);
    updateDashboard(serverState);
    recomputeFilteredHistory();
    renderHistoryPage(false);
    renderPortfolio(serverState.portfolio);

    // –î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è + –≤—ã–≤–æ–¥ UI
    setBootProgress(80);
    await refreshTodayIncome();
    updateWithdrawUI();

    // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
    setBootProgress(95);
    scheduleSync(2000); // –∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–µ—Ä
    finishBootScreen(); // –∑–∞–≥–æ–ª–æ–≤–æ–∫ ¬´—É–ª–µ—Ç–∏—Ç¬ª, –æ–≤–µ—Ä–ª–µ–π –∏—Å—á–µ–∑–Ω–µ—Ç
  } catch (e) {
    console.error('Initialization error:', e);
    finishBootScreen();                 // –¥–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É–±–∏—Ä–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
    setStatus(`–û—à–∏–±–∫–∞: ${e.message}`, 'error'); // –ø–æ–ø-–∞–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—à–∏–±–æ–∫
  }
}

// –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å + "–î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è"; –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ PENDING –¥–µ–ø–æ–∑–∏—Ç–∞
async function syncBalance(fromScheduler = false) {
  // –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ü–∏–∫–ª—ã
  if (syncInFlight) { if (fromScheduler) scheduleSync(); return; }
  syncInFlight = true;

  try {
    // –µ—Å–ª–∏ –µ—Å—Ç—å PENDING –¥–µ–ø–æ–∑–∏—Ç ‚Äî –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π —Å—Ä–µ–∑ (–≤–∫–ª—é—á–∞—è –∏—Å—Ç–æ—Ä–∏—é), –∏–Ω–∞—á–µ ‚Äî –ª—ë–≥–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
    let data = null;
    if (hasPendingDeposit) {
      // –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—ë—Ç –∏ –±–∞–ª–∞–Ω—Å, –∏ –∏—Å—Ç–æ—Ä–∏—é, –∏ prefs
      const full = await apiGet(`?action=getInitialData&username=${encodeURIComponent(username)}`);
      if (full && full.success) {
        data = full;
        serverState = { ...serverState, ...full };
        updateDashboard(serverState);
        recomputeFilteredHistory();
        renderHistoryPage(false);
        renderPortfolio(serverState.portfolio);
      }
    } else {
      // –±—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –±–∞–ª–∞–Ω—Å + –¥–æ—Ö–æ–¥
      const [balRes, accrRes] = await Promise.allSettled([
        apiGet(`?action=syncBalance&username=${encodeURIComponent(username)}`),
        apiGet(`?action=previewAccrual&username=${encodeURIComponent(username)}`)
      ]);
      if (balRes.status === 'fulfilled' && balRes.value && balRes.value.success) {
        data = balRes.value;
        updateDashboard(balRes.value);
      }
      if (accrRes.status === 'fulfilled' && accrRes.value && accrRes.value.success) {
        latestTodayIncomeRub = Number(accrRes.value.accruedToday || 0);
      }
renderTodayIncome();
    }

    // === –ü–û–°–õ–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–ø–æ–∑–∏—Ç–∞ ===
    const before = hasPendingDeposit;
    const now = computeHasPendingDeposit();
    hasPendingDeposit = now; // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ñ–ª–∞–≥

    // –µ—Å–ª–∏ —Ä–∞–Ω—å—à–µ –±—ã–ª PENDING, –∞ —Ç–µ–ø–µ—Ä—å –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ ACK'–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É
if (before && !now) {
  const last = (serverState.history || [])
    .filter(x => x.type === 'DEPOSIT')
    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];

  if (last && (last.status === 'APPROVED' || last.status === 'REJECTED' || last.status === 'CANCELED')) {
    const msg = last.status === 'APPROVED'
      ? '–î–µ–Ω—å–≥–∏ –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ —Å—á—ë—Ç'
      : '–î–µ–ø–æ–∑–∏—Ç –Ω–µ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ';
    closeDepositFlowWithPopup(msg);

    // –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Å—Ç–∞–≤–∏–º G=TRUE –Ω–∞ –±—ç–∫–µ–Ω–¥–µ)
    void apiGet(`?action=ackDepositDelivery&username=${encodeURIComponent(username)}`)
      .catch(() => {}); // –Ω–µ –º–µ—à–∞–µ–º –ø–æ–ª–ª–µ—Ä—É –∏–∑-–∑–∞ —Å–µ—Ç–µ–≤—ã—Ö —Å–±–æ–µ–≤
  } else {
    // –±–µ–∑ —è–≤–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–æ–µ–º flow, ACK –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º
    closeDepositFlowWithPopup('–û–ø–µ—Ä–∞—Ü–∏—è –ø–æ –¥–µ–ø–æ–∑–∏—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  }
}

    // —É—Å–ø–µ—à–Ω—ã–π —Ü–∏–∫–ª ‚Äî –º—è–≥–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    syncBackoffMs = 20000;

  } catch (e) {
    // —Å–µ—Ç—å/–æ—à–∏–±–∫–∞ ‚Äî —É–≤–µ–ª–∏—á–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª, –Ω–æ –Ω–µ –±–æ–ª—å—à–µ 60—Å
    syncBackoffMs = Math.min((syncBackoffMs || 20000) * 2, 60000);
  } finally {
    syncInFlight = false;
    if (fromScheduler) scheduleSync(); // –ø–ª–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–∞—Ö–æ–¥
  }
}

async function cancelDeposit() {
  try {
    const r = await apiGet(`?action=cancelPendingDeposit&username=${username}`);
    if (r && r.success) {
      hasPendingDeposit = false;
      showPopup('–î–µ–ø–æ–∑–∏—Ç –æ—Ç–º–µ–Ω—ë–Ω');
      showDepositStep(1);
      initializeApp();
    } else {
      showPopup('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç');
    }
  } catch {
    showPopup('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}
      
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–î–æ—Ö–æ–¥ —Å–µ–≥–æ–¥–Ω—è" ‚Äî –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ `res`
async function refreshTodayIncome() {
  let accrued = latestTodayIncomeRub; // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —á—Ç–æ –±—ã–ª–æ
  try {
    const r = await apiGet(`?action=previewAccrual&username=${encodeURIComponent(username)}`);
    if (r && r.success) {
      accrued = Number(r.accruedToday || 0);
    }
  } catch (e) {
    console.debug('refreshTodayIncome error:', e);
  } finally {
    latestTodayIncomeRub = accrued;
    renderTodayIncome();
  }
}

      // -------- EVENTS --------
function setupEventListeners() {
  const $id = (x) => document.getElementById(x);
  const onIf = (el, ev, fn, opts) => { if (el) el.addEventListener(ev, fn, opts); };

  // –ö–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É –º–æ–¥–∞–ª–∫–∏ ‚Äî –∑–∞–∫—Ä—ã—Ç—å. –ó–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –≤–∞–ª—é—Ç—ã.
  document.addEventListener('click', (e) => {
    const target = e.target;
    if (target && target.classList && target.classList.contains('modal-overlay')) {
      target.classList.remove('active');
    }
    const anyOpen = Array.from(document.querySelectorAll('.modal-overlay')).some(m => m.classList.contains('active'));
    if (!anyOpen) document.body.classList.remove('modal-open');

    const currencyDropdown = $id('currencyDropdown');
    const currencyToggler  = document.querySelector('.balance-currency');
    if (currencyDropdown && currencyToggler && !currencyDropdown.contains(target) && !currencyToggler.contains(target)) {
      currencyDropdown.classList.remove('open');
    }
  });
  // –†–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ —Å–º–µ–Ω—É —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç—É–º–±–ª–µ—Ä–∞
  document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'depositAgree') updateDepositBtnState();
  });
  // (–í–ê–ñ–ù–û) –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è setTimeout(updateDepositBtnState, 0) –≤ openModal('deposit')

  // Dev mode
  onIf(document.getElementById('devModeToggle'), 'change', function () {
  devMode = this.checked;
  localStorage.setItem('devMode', devMode);
  const dv = document.getElementById('devVersion');
  if (dv) dv.style.display = devMode ? 'block' : 'none';
  renderHistoryPage(false);
  renderPortfolio(serverState.portfolio);
});


  // Deposit ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å
  onIf($id('depositConfirmBtn'), 'click', async function () {
    const amountEl = $id('depositAmount');
    const amount = amountEl ? parseAmount(amountEl.value) : 0;

    if (amount <= 0) {
      showPopup('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É.');
      return;
    }

    this.disabled = true;

    try {
      const resp = await apiGet(
        `?action=requestDeposit&username=${encodeURIComponent(username)}&amount=${encodeURIComponent(amount)}`
      );

      if (resp && resp.success) {
        showPopup('–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        hasPendingDeposit = true;
        lastDepositAmount = amount;
lastDepositShortId = resp && (resp.shortId || resp.requestShortId) || null;
hydrateDepositStep2(lastDepositAmount, lastDepositShortId);
        showDepositStep(2); // –∑–∞–∫—Ä–µ–ø–ª—è–µ–º —ç–∫—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
        initializeApp();    // –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é/–±–∞–ª–∞–Ω—Å
      } else {
        showPopup('–û—à–∏–±–∫–∞: ' + ((resp && resp.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
      }
    } catch (e) {
      showPopup('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.');
    } finally {
      this.disabled = false;
    }
  });

  // Withdraw ‚Äî –≤—ã–±–æ—Ä –±–∞–Ω–∫–∞ (–∏–∫–æ–Ω–∫–∏)
  document.querySelectorAll('.bank-icon').forEach((icon) => {
    icon.addEventListener('click', () => {
      document.querySelectorAll('.bank-icon').forEach(i => i.classList.remove('selected'));
      icon.classList.add('selected');
    });
  });

  // Withdraw ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –°–ë–ü —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
  onIf($id('save-sbp-btn'), 'click', async function () {
    const phoneEl = $id('withdraw-sbp-phone');
    const phone = phoneEl ? phoneEl.value : '';
    const selectedBankEl = document.querySelector('.bank-icon.selected');
    if (!phone || !selectedBankEl) { showPopup('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫.'); return; }
    const bank = selectedBankEl.dataset.bank;
    userPrefs.sbpMethods = userPrefs.sbpMethods || [];
    userPrefs.sbpMethods.unshift({ phone, bank });

    this.disabled = true;
    try {
      const resp = await apiGet(`?action=saveUserPrefs&username=${encodeURIComponent(username)}&prefs=${encodeURIComponent(JSON.stringify(userPrefs))}`);
      if (resp && resp.success) {
        userPrefs = resp.savedPrefs;
        withdrawAddingNew = false; // <-- —Å–±—Ä–∞—Å—ã–≤–∞–µ–º, —Ä–µ–∫–≤–∏–∑–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω
        updateWithdrawUI();
      } else {
        showPopup('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã.');
      }
    } catch (e) {
      showPopup('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.');
    } finally { this.disabled = false; }
  });

  // Withdraw ‚Äî –≤—ã–±–æ—Ä ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã¬ª
onIf($id('withdraw-recipient-select'), 'change', function () {
  if (this.value === 'add_new') {
    withdrawAddingNew = true; // <-- –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
    $id('withdraw-view').style.display = 'none';
    $id('withdraw-method-choice').style.display = 'block';
    $id('withdraw-add-sbp-form').style.display = 'none';
  }
});

  // Withdraw ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å
  onIf($id('withdrawConfirmBtn'), 'click', async function () {
    const amountEl = $id('withdrawAmount');
    const selEl = $id('withdraw-recipient-select');
    const amount = amountEl ? parseAmount(amountEl.value) : 0;
    const idx = selEl ? selEl.value : -1;
    const recipient = (userPrefs.sbpMethods || [])[idx];
    const available = (serverState.balance || 0) - (serverState.lockedAmount || 0);

    if (amount <= 0) { showPopup('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É.'); return; }
    if (amount > available) { showPopup('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤.'); return; }
    if (!recipient) { showPopup('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–≤–æ–¥–∞.'); return; }

    this.disabled = true;
    try {
      const details = JSON.stringify({ method: 'sbp', phone: recipient.phone, bank: recipient.bank });
      const resp = await apiGet(`?action=requestWithdraw&username=${encodeURIComponent(username)}&amount=${encodeURIComponent(amount)}&details=${encodeURIComponent(details)}`);
      if (resp && resp.success) {
        showPopup('–ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        closeModal('withdraw');
        initializeApp();
      } else {
        showPopup('–û—à–∏–±–∫–∞: ' + ((resp && resp.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
      }
    } catch (e) {
      showPopup('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.');
    } finally {
      this.disabled = false;
    }
  });

  // New Investment ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
  onIf($id('niConfirmBtn'), 'click', async function () {
    const amountEl = $id('niAmount');
    const amount = amountEl ? parseAmount(amountEl.value) : 0;
    const rate = lastChosenRate;
    if (!rate || amount <= 0) { showPopup('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.'); return; }
    this.disabled = true;
    try {
      const resp = await apiGet(`?action=logStrategyInvestment&username=${encodeURIComponent(username)}&rate=${encodeURIComponent(rate)}&amount=${encodeURIComponent(amount)}`);
      if (resp && resp.success) {
        showPopup('–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
        closeModal('newInvestment');
        initializeApp();
      } else {
        showPopup('–û—à–∏–±–∫–∞: ' + ((resp && resp.error) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'));
      }
    } catch (e) {
      showPopup('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    } finally {
      this.disabled = false;
    }
  });

  // –ò—Å—Ç–æ—Ä–∏—è ‚Äî ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë¬ª
  onIf($id('load-more-history'), 'click', () => {
    renderHistoryPage(true);
  });
}

      // -------- UI UTILS --------
// Boot screen helpers
const BOOT_HINTS = [
  '–ò—â–µ–º –ª—É—á—à–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π',
  '–¢–∞–Ω—Ü—É–µ–º —Å –±—É–±–Ω–æ–º',
  '–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–µ —Å—Ç–∞–≤–∫–∏',
  '–£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏',
  '–ò—â–µ–º –∫–ª—é—á, —á—Ç–æ–±—ã –í–∞—Å –≤–ø—É—Å—Ç–∏—Ç—å',
  '–ë–µ—Ä–µ–∂–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≤–∞—à–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –¥–µ–ø–æ–∑–∏—Ç',
];

let bootHintsPicked = [];
let bootProgressTarget = 0, bootProgressTimer = null;

function startBootScreen() {
  const el = document.getElementById('boot-screen');
  if (!el) return;
  el.classList.remove('hidden');
  bootHintsPicked = pickTwoHints_();
  setBootHint(bootHintsPicked[0]);
  setBootProgress(5);
}
function pickTwoHints_() {
  const arr = [...BOOT_HINTS];
  const a = arr.splice(Math.floor(Math.random()*arr.length),1)[0];
  const b = arr[Math.floor(Math.random()*arr.length)];
  return [a,b];
}
function setBootHint(text) {
  const h = document.getElementById('boot-hint');
  if (h) h.textContent = text;
}
function setBootProgress(p) {
  // –∏–º–∏—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É ‚Äî –ø–ª–∞–≤–Ω–æ –¥–æ–≥–æ–Ω—è–µ–º —Ü–µ–ª—å
  bootProgressTarget = Math.max(0, Math.min(100, p));
  const fill = document.getElementById('boot-progress-fill');
  if (!fill) return;
  clearInterval(bootProgressTimer);
  bootProgressTimer = setInterval(() => {
    const cur = parseFloat(fill.style.width||'0');
    const step = Math.max(0.8, (bootProgressTarget - cur) * 0.25); // easing
    const next = Math.min(bootProgressTarget, cur + step);
    fill.style.width = next + '%';
    // —Å–º–µ–Ω–∏–º —Ñ—Ä–∞–∑—É –ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ
    if (next > 55 && bootHintsPicked[1]) {
      setBootHint(bootHintsPicked[1]);
      bootHintsPicked[1] = null;
    }
    if (Math.abs(next - bootProgressTarget) < 0.5) {
      fill.style.width = bootProgressTarget + '%';
      clearInterval(bootProgressTimer);
    }
  }, 80);
}
function finishBootScreen() {
  const overlay = document.getElementById('boot-screen');
  const title = document.getElementById('boot-title');
  const target = document.getElementById('appBrand');

  setBootProgress(100);

  if (overlay && title && target) {
    // –≤—ã—á–∏—Å–ª—è–µ–º –≤ —ç–∫—Ä–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
    const tr = target.getBoundingClientRect();
    const sr = title.getBoundingClientRect();

    // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –º–∞—Å—à—Ç–∞–±–∞ ‚Äî –ø–æ –≤—ã—Å–æ—Ç–µ —à—Ä–∏—Ñ—Ç–∞
    const titleFs = parseFloat(getComputedStyle(title).fontSize) || 28;
    const targetFs = parseFloat(getComputedStyle(target).fontSize) || 18;
    const scale = Math.max(0.6, Math.min(1.2, targetFs / titleFs));

    const dx = (tr.left + tr.width/2) - (sr.left + sr.width/2);
    const dy = (tr.top + tr.height/2) - (sr.top + sr.height/2);

    // –∞–Ω–∏–º–∞—Ü–∏—è 3 —Å–µ–∫—É–Ω–¥—ã
    title.animate(
      [
        { transform: 'translate(0,0) scale(1)', opacity: 1 },
        { transform: `translate(${dx}px, ${dy}px) scale(${scale})`, opacity: 0 }
      ],
      { duration: 3000, easing: 'cubic-bezier(.22,.61,.36,1)', fill: 'forwards' }
    );

    // —á–µ—Ä–µ–∑ 2.5—Å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∑–∞—Ç–µ–º –ø—Ä—è—á–µ–º –æ–≤–µ—Ä–ª–µ–π
    setTimeout(() => { target.style.opacity = '1'; }, 2500);
    setTimeout(() => { overlay.classList.add('hidden'); }, 3000);
  } else if (overlay) {
    // –∑–∞–ø–∞—Å–Ω–æ–π –ø—É—Ç—å
    overlay.classList.add('hidden');
  }
}
// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º setStatus: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—à–∏–±–æ–∫
function setStatus(text, type = 'error') {
  if (type === 'error') {
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π popup-—É–≤–µ–¥–æ–º–∏—Ç–µ–ª—å
    showPopup(text || '–û—à–∏–±–∫–∞', 3000);
  }
  // loading/synced –∑–¥–µ—Å—å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º ‚Äî —ç—Ç–∏–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è boot screen
}
      
      function setDepositAmount(amount) {
        const input = document.getElementById('depositAmount');
        input.value = amount;
        formatAmountInput(input);
      }
function hydrateDepositStep2(amountRub, shortId) {
  const currency = userPrefs.currency;
  const currencySymbol = currency === 'RUB' ? '‚ÇΩ' : (currency === 'USD' ? '$' : '‚Ç¨');

  const amountEl = document.getElementById('deposit-amount-display');
  const codeEl = document.getElementById('deposit-short-display');
  if (amountEl) amountEl.value = `${fmtMoney(amountRub, currency)} ${currencySymbol}`;
  if (codeEl) codeEl.value = shortId ? `#${shortId}` : '‚Äî';
}

function closeDepositFlowWithPopup(msg) {
  closeModal('deposit');    // –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É
  openPage('Home');         // –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –ì–ª–∞–≤–Ω—É—é
  showPopup(msg, 3500);     // –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
}

function selectWithdrawMethod(method) {
  // –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ —Å—é–¥–∞ –ø–æ—Å–ª–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã" ‚Äî –≤–µ–¥—ë–º –Ω–∞ —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  if (withdrawAddingNew && method === 'sbp') {
    showAddRecipientForm('sbp');
    return;
  }

  if (method === 'sbp') {
    const has = (userPrefs.sbpMethods || []).length > 0;
    if (has) {
      // —Å—Ä–∞–∑—É –∫ —Ñ–æ—Ä–º–µ –≤—ã–≤–æ–¥–∞ —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–æ–º
      document.getElementById('withdraw-method-choice').style.display = 'none';
      document.getElementById('withdraw-add-sbp-form').style.display = 'none';
      document.getElementById('withdraw-view').style.display = 'block';
      const sel = document.getElementById('withdraw-recipient-select');
      if (sel) sel.selectedIndex = Math.max(0, sel.selectedIndex); // –Ω–∞ –≤—Å—è–∫–∏–π
    } else {
      showAddRecipientForm('sbp');
    }
  }

  // TODO: –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—à—å crypto/bank ‚Äî –ª–æ–≥–∏–∫–∞ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏
}
      
      function toggleCurrencyDropdown(event) {
        event.stopPropagation();
        document.getElementById('currencyDropdown').classList.toggle('open');
      }

      async function selectCurrency(currency, event) {
        event.stopPropagation();
        userPrefs.currency = currency;
        document.getElementById('currentCurrency').textContent = currency;
        document.querySelectorAll('.currency-option').forEach(opt => opt.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('currencyDropdown').classList.remove('open');

        updateDashboard(serverState);
        recomputeFilteredHistory();
        renderHistoryPage(false);
        renderPortfolio(serverState.portfolio);

        await apiGet(`?action=saveUserPrefs&username=${username}&prefs=${encodeURIComponent(JSON.stringify(userPrefs))}`);
      }

function openNewInvestment(rate) {
  lastChosenRate = rate;
  const name = `–°—Ç—Ä–∞—Ç–µ–≥–∏—è ${rate}%`;
  document.getElementById('niStrategyReadonly').textContent = name;
  document.getElementById('niAmount').value = '';
  // NEW: –∑–∞–∫—Ä—ã—Ç—å –ª—é–±—ã–µ –º–æ–¥–∞–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º ¬´–ù–æ–≤–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏¬ª
  closeAllModals();
  openModal('newInvestment');
}


      function showAddRecipientForm(method) {
        if (method !== 'sbp') return;
        document.getElementById('withdraw-method-choice').style.display = 'none';
        document.getElementById('withdraw-add-sbp-form').style.display = 'block';
        const phoneInput = document.getElementById('withdraw-sbp-phone');
        if (phoneInput) phoneInput.focus();
        document.querySelectorAll('.bank-icon').forEach(i => i.classList.remove('selected'));
      }

      function updateWithdrawUI() {
        const select = document.getElementById('withdraw-recipient-select');
        select.innerHTML = '';

        if (userPrefs.sbpMethods && userPrefs.sbpMethods.length > 0) {
          userPrefs.sbpMethods.forEach((method, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `–°–ë–ü: ${method.phone} (${method.bank})`;
            select.appendChild(option);
          });
          const addNewOption = document.createElement('option');
          addNewOption.value = 'add_new';
          addNewOption.textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã';
          select.appendChild(addNewOption);

          document.getElementById('withdraw-view').style.display = 'block';
          document.getElementById('withdraw-method-choice').style.display = 'none';
          document.getElementById('withdraw-add-sbp-form').style.display = 'none';

        } else {
          document.getElementById('withdraw-view').style.display = 'none';
          document.getElementById('withdraw-method-choice').style.display = 'block';
          document.getElementById('withdraw-add-sbp-form').style.display = 'none';
        }
      }

      // –ù–∞–¥—ë–∂–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ + —Å–º–µ–Ω–∞ –∏–∫–æ–Ω–∫–∏ –Ω–∞ –≥–∞–ª–æ—á–∫—É –Ω–∞ 2 —Å–µ–∫
async function copyToClipboard(text, btnEl) {
  const inTG = !!(window.Telegram && window.Telegram.WebApp); // –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞

  const ok = await (async () => {
    try {
      if (!inTG && navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return true; // –∑–¥–µ—Å—å —Ä–∞–Ω—å—à–µ —Å—ã–ø–∞–ª—Å—è violation ‚Äî —Ç–µ–ø–µ—Ä—å –Ω–µ –≤—ã–∑–æ–≤–µ–º –≤–æ–≤—Å–µ –≤ TG
      }
      throw new Error();
    } catch {
      try {
        const ta = document.createElement('textarea');
        ta.value = text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.select(); ta.setSelectionRange(0, ta.value.length);
        const res = document.execCommand('copy'); document.body.removeChild(ta);
        return res;
      } catch { return false; }
    }
  })();

  if (ok) {
    if (btnEl) {
      if (!btnEl.dataset.orig) btnEl.dataset.orig = btnEl.innerHTML;
      btnEl.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
      setTimeout(() => { btnEl.innerHTML = btnEl.dataset.orig; }, 2000);
    }
    showPopup('–ù–æ–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
  } else {
    showPopup('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
  }
}

      // -------- INIT --------
      document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
        initializeApp();
      });
    </script>
  </body>
</html>

