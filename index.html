<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–æ—à–µ–ª—ë–∫ v4</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    .balance-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 20px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    .balance-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      transform: rotate(30deg);
    }
    #balanceDisplay {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
    }
    #balanceDisplay::after {
      content: " ‚úß";
    }
    .interest-info {
      font-size: 0.9em;
      opacity: 0.9;
    }
    button {
      background-color: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: opacity 0.2s;
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .info { background-color: #cce5ff; color: #004085; }
    .warning { background-color: #fff3cd; color: #856404; }
    .hidden { display: none; }
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .section {
      background: var(--tg-theme-secondary-bg-color, #f8f9fa);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    h3 {
      margin-top: 0;
      color: var(--tg-theme-text-color, #000000);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="balance-container">
      <div>–í–∞—à –±–∞–ª–∞–Ω—Å</div>
      <div id="balanceDisplay">0.00</div>
      <div class="interest-info">–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ 16% –≥–æ–¥–æ–≤—ã—Ö</div>
    </div>

    <button id="syncBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    
    <div class="section">
      <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
      <input type="number" id="depositAmount" placeholder="–°—É–º–º–∞ (–º–∏–Ω. 100)" min="100" step="100">
      <button id="depositBtn">üì• –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
    </div>

    <div class="section">
      <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
      <button id="infoBtn">‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
    </div>

    <div id="status" class="hidden"></div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzIAGI3xqdLJeOGHs8cgvLbMll5x82pc7clF_HTmQBQkc-5jbONBaq27NPZuaQAfuR_oA/exec'; // <-- –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL
    let currentBalance = 0;
    let syncIntervalId = null;
    let tg = window.Telegram?.WebApp;

    if (tg) {
      tg.ready();
      tg.expand();
    }

    // === UI –§–£–ù–ö–¶–ò–ò ===
    function showStatus(message, type = 'info', duration = 5000) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = type;
      statusEl.classList.remove('hidden');
      if (duration > 0) {
        setTimeout(() => statusEl.classList.add('hidden'), duration);
      }
    }

    function updateBalanceDisplay() {
      document.getElementById('balanceDisplay').textContent = currentBalance.toFixed(2);
    }

    function getUserName() {
      if (tg?.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        return user.username ? `@${user.username}` : `user_${user.id}`;
      }
      return '@test_user';
    }

    // === –°–ï–¢–ï–í–´–ï –§–£–ù–ö–¶–ò–ò (JSONP) ===
    function jsonpRequest(url, successCallback, errorCallback) {
      const callbackName = 'cb_' + Date.now() + Math.floor(Math.random() * 10000);
      let script = document.createElement('script');
      let timeoutId;

      const cleanup = () => {
        clearTimeout(timeoutId);
        if (window[callbackName]) delete window[callbackName];
        if (script.parentNode) script.parentNode.removeChild(script);
      };

      timeoutId = setTimeout(() => {
        cleanup();
        console.error('JSONP Timeout:', url);
        if (errorCallback) errorCallback('Request timeout');
      }, 15000); // –£–≤–µ–ª–∏—á–∏–ª —Ç–∞–π–º–∞—É—Ç –¥–æ 15 —Å–µ–∫—É–Ω–¥

      window[callbackName] = (data) => {
        cleanup();
        console.log('JSONP Success:', url, data);
        if (successCallback) successCallback(data);
      };

      script.onerror = (err) => {
        cleanup();
        console.error('JSONP Error:', url, err);
        if (errorCallback) errorCallback('Script load error');
      };

      script.src = url;
      document.head.appendChild(script);
    }

    // === –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ===
    function syncBalance() {
      const username = getUserName();
      if (username === '@test_user') {
        showStatus('–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.', 'info');
        return Promise.resolve();
      }

      showStatus('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...', 'info', 0); // 0 = –Ω–µ —Å–∫—Ä—ã–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
      const url = `${GAS_URL}?action=getBalance&username=${encodeURIComponent(username)}&t=${Date.now()}`;

      return new Promise((resolve, reject) => {
        jsonpRequest(url,
          (data) => {
            const statusEl = document.getElementById('status');
            if (data?.success) {
              currentBalance = parseFloat(data.balance) || 0;
              updateBalanceDisplay();
              statusEl.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è..."
              resolve(data);
            } else {
              showStatus(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${data?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
              reject(new Error(data?.error || 'Unknown error'));
            }
          },
          (error) => {
            showStatus(`‚ùå –°–µ—Ç—å: ${error}`, 'error');
            reject(new Error(error));
          }
        );
      });
    }

    function generateDeposit() {
      const amount = parseFloat(document.getElementById('depositAmount').value);
      if (!amount || amount < 100) {
        showStatus('‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ 100', 'error');
        return;
      }
      const username = getUserName();
      const transactionId = 'DEP' + Date.now();
      
      const message = `üí∞ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}\n–°—É–º–º–∞: ${amount.toFixed(2)}\nID: ${transactionId}`;

      showStatus('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏...', 'info', 0);
      const url = `${GAS_URL}?action=sendNotification&type=deposit&userId=${encodeURIComponent(username)}&amount=${amount}&transactionId=${transactionId}&message=${encodeURIComponent(message)}&t=${Date.now()}`;

      jsonpRequest(url,
        (data) => {
          if (data?.success) {
            showStatus('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
            document.getElementById('depositAmount').value = '';
          } else {
            showStatus(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å'}`, 'error');
          }
        },
        (error) => {
          showStatus(`‚ùå –°–µ—Ç—å: ${error}`, 'error');
        }
      );
    }

    function showInfo() {
      if (tg) {
        tg.showAlert("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\n- –ë–∞–ª–∞–Ω—Å —Ä–∞—Å—Ç–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (16% –≥–æ–¥–æ–≤—ã—Ö)\n- –ü—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤\n- –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å\n- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ —Ç–∞–±–ª–∏—Ü–µ");
      } else {
        alert("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\n- –ë–∞–ª–∞–Ω—Å —Ä–∞—Å—Ç–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (16% –≥–æ–¥–æ–≤—ã—Ö)\n- –ü—Ä–æ—Ü–µ–Ω—Ç—ã –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤\n- –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—ã –≤–∏–¥–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å\n- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –≤—Ä—É—á–Ω—É—é –∏–∑–º–µ–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ —Ç–∞–±–ª–∏—Ü–µ");
      }
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –ó–ê–ü–£–°–ö ===
    document.getElementById('syncBtn').addEventListener('click', syncBalance);
    document.getElementById('depositBtn').addEventListener('click', generateDeposit);
    document.getElementById('infoBtn').addEventListener('click', showInfo);

    // –ù–∞—á–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π
    updateBalanceDisplay();
    syncBalance().finally(() => {
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        syncIntervalId = setInterval(() => {
            console.log("‚è∞ Auto-sync triggered");
            syncBalance().catch(err => console.log("Auto-sync error (background):", err));
        }, 30000);
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    window.addEventListener('focus', syncBalance);
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
    window.addEventListener('beforeunload', () => {
        if (syncIntervalId) clearInterval(syncIntervalId);
        // –¢—É—Ç –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å–¥–µ–ª–∞—Ç—å syncBalance(), –Ω–æ —ç—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ
    });
  </script>
</body>
</html>
