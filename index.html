<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>HomerBot — Инвестиционный Кошелёк</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&display=swap" rel="stylesheet">
  <style>
    :root { 
      color-scheme: light dark; --bg-primary: #0a0b0f; --bg-secondary: rgba(255,255,255,0.04); --bg-card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.08); --text-primary: #e8eaed; --text-secondary: rgba(232,234,237,0.7); --text-muted: rgba(232,234,237,0.5); --accent: #4c8bf5; --accent-hover: #5a95f7; --success: #34d399; --warning: #fbbf24; --error: #f87171; --glass-bg: rgba(20, 22, 30, 0.7); --glass-border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; overflow-x: hidden; }
    .app-container { max-width: 430px; margin: 0 auto; min-height: 100vh; background: var(--bg-primary); position: relative; }
    .header { position: sticky; top: 0; z-index: 100; background: rgba(10, 11, 15, 0.5); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 12px 20px; }
    .header-content { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-family: 'Comfortaa', cursive; font-size: 24px; font-weight: 700; color: var(--text-primary); }
    .profile-btn { width: 40px; height: 40px; border-radius: 12px; background: var(--bg-card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: var(--glass-bg); backdrop-filter: blur(20px); border-top: 1px solid var(--glass-border); padding: 12px 20px 20px; z-index: 100; border-radius: 24px 24px 0 0; }
    .nav-items { display: flex; justify-content: space-around; align-items: center; }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; opacity: 0.6; }
    .nav-item.active { opacity: 1; background: rgba(255,255,255,0.1); }
    .nav-item:hover { opacity: 1; transform: translateY(-2px); }
    .nav-icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
    .nav-label { font-size: 11px; font-weight: 500; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 1000; display: none; align-items: flex-end; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-primary); border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; max-height: 90vh; overflow-y: auto; padding: 24px; animation: slideUp 0.3s ease; border-top: 1px solid var(--glass-border); }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .page { display: none; padding: 20px 20px 120px; }
    .page.active { display: block; }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 24px; margin-bottom: 16px; backdrop-filter: blur(10px); }
    .glass-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 16px; margin-bottom: 12px; backdrop-filter: blur(20px); }
    .balance-section { text-align: center; }
    .balance-label { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
    .balance-main { font-size: 42px; font-weight: 800; font-variant-numeric: tabular-nums; display:flex; align-items:center; justify-content:center; gap: 8px; }
    .balance-currency { font-size: 16px; color: var(--text-muted); font-weight: 600; cursor: pointer; position: relative; }
    .currency-arrow { font-size: 10px; opacity: 0.7; margin-left: 4px; }
    .currency-dropdown { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 8px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; padding: 8px; display: none; z-index: 10; }
    .currency-dropdown.open { display: block; }
    .currency-option { padding: 8px 16px; cursor: pointer; border-radius: 8px; transition: background 0.2s; }
    .currency-option:hover { background: var(--glass-bg); }
    .currency-option.active { background: var(--accent); color: white; }
    .balance-stats { display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
    .balance-stat { flex: 1; text-align: center; }
    .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-value { font-size: 16px; font-weight: 700; }
    .stat-positive { color: var(--success); }
    .btn-group { display: flex; gap: 12px; margin-bottom: 24px; }
    .btn { flex: 1; padding: 16px 24px; border-radius: 16px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); }
    .btn-secondary { background: var(--glass-bg); border: 1px solid var(--border); color: var(--text-primary); }
    .btn-secondary:hover { background: var(--bg-card); transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    .strategies-section h2 { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
    .strategy-cards { display: flex; flex-direction: column; gap: 12px; }
    .strategy-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s ease; }
    .strategy-card:hover { background: var(--bg-card); transform: translateY(-2px); }
    .strategy-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .strategy-name { font-size: 18px; font-weight: 700; }
    .strategy-rate { font-size: 24px; font-weight: 800; color: var(--accent); }
    .strategy-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
    .strategy-features { display: flex; gap: 8px; flex-wrap: wrap; }
    .feature-tag { padding: 4px 8px; background: var(--glass-bg); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; color: var(--text-secondary); }
    .status { position:fixed; top:80px; right:20px; padding:8px 12px; border-radius:12px; background:var(--glass-bg); border:1px solid var(--border); font-size:12px; backdrop-filter:blur(10px); z-index:90; transform:translateX(130%); opacity:0; transition:transform .35s ease, opacity .35s ease; pointer-events:none; }
    .status.show { transform:translateX(0); opacity:1; }
    .status.loading { color:var(--warning); }
    .status.synced { color:var(--success); }
    .status.error { color:var(--error); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { font-size: 20px; font-weight: 700; }
    .close-btn { width: 32px; height: 32px; border: none; background: var(--glass-bg); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .popup { position: fixed; left: 50%; bottom: 120px; transform: translateX(-50%); background: rgba(20,20,20,0.95); color: white; padding: 16px 20px; border-radius: 16px; font-size: 14px; z-index: 9999; max-width: 90vw; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); white-space: pre-line; }
    .filter-chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-chip { padding: 8px 16px; background: var(--glass-bg); border: 1px solid var(--border); border-radius: 20px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
    .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
    .filter-chip:hover:not(.active) { background: var(--bg-card); transform: translateY(-1px); }
    .amount-input { width: 100%; padding: 16px; background: var(--glass-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 24px; font-weight: 700; text-align: center; margin-bottom: 16px; }
    .input-field { flex: 1; padding: 12px; background: var(--glass-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 16px; }
    .quick-amounts { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 16px 0; }
    .quick-amount-btn { padding: 12px; background: var(--glass-bg); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .quick-amount-btn:hover { background: var(--bg-card); transform: translateY(-1px); }
    .method-card { background: var(--glass-bg); border: 1px solid var(--border); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
    .method-card.disabled { opacity: 0.5; cursor: not-allowed; }
    .method-card:not(.disabled):hover { background: var(--bg-card); transform: translateY(-2px); }
    .method-info h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .method-info p { font-size: 14px; color: var(--text-secondary); }
    .dev-notice { background: var(--warning); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; display: inline-block; margin-left: 8px; vertical-align: middle; }
    .input-with-copy { display: flex; align-items: center; gap: 8px; }
    .copy-btn { width: 48px; height: 48px; background: var(--glass-bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="header">
      <div class="header-content">
        <div class="logo">HomerBot</div>
        <button class="profile-btn" onclick="openModal('profile')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
      </div>
    </div>

    <div id="status" class="status loading">Подключение...</div>

    <div id="pageContainer">
        <div class="page active" id="pageHome">
            <div class="card">
                <div class="balance-section">
                    <div class="balance-label">Общий баланс</div>
                    <div class="balance-main">
                        <span id="balanceValue">—</span>
                        <div class="balance-currency" onclick="toggleCurrencyDropdown(event)">
                            <span id="currentCurrency">RUB</span>
                            <span class="currency-arrow">▼</span>
                            <div class="currency-dropdown" id="currencyDropdown">
                                <div class="currency-option active" onclick="selectCurrency('RUB', event)">RUB</div>
                                <div class="currency-option" onclick="selectCurrency('USD', event)">USD</div>
                                <div class="currency-option" onclick="selectCurrency('EUR', event)">EUR</div>
                            </div>
                        </div>
                    </div>
                    <div class="balance-stats">
                        <div class="balance-stat"><div class="stat-label">Свободно</div><div class="stat-value" id="freeBalance">—</div></div>
                        <div class="balance-stat"><div class="stat-label">Инвестировано</div><div class="stat-value stat-positive" id="investedBalance">—</div></div>
                        <div class="balance-stat"><div class="stat-label">Доход сегодня</div><div class="stat-value stat-positive" id="todayIncome">+0.00</div></div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="openModal('deposit')">Депозит</button>
                <button class="btn btn-secondary" onclick="openModal('withdraw')">Вывод</button>
            </div>
            <div class="strategies-section">
                <h2>Инвестиционные стратегии</h2>
                <div class="strategy-cards">
                    <div class="strategy-card" onclick="openModal('strategy16')">
                        <div class="strategy-header"><div class="strategy-name">Гибкая</div><div class="strategy-rate">16%</div></div>
                        <div class="strategy-description">Вывод в любое время без штрафа.</div>
                        <div class="strategy-features"><span class="feature-tag">Без заморозки</span><span class="feature-tag">Банковские вклады</span></div>
                    </div>
                    <div class="strategy-card" onclick="openModal('strategy17')">
                        <div class="strategy-header"><div class="strategy-name">30 дней</div><div class="strategy-rate">17%</div></div>
                        <div class="strategy-description">Заморозка 30 дней. Досрочный вывод — теряются проценты.</div>
                        <div class="strategy-features"><span class="feature-tag">Заморозка на 30 дней</span><span class="feature-tag">ЦФА</span></div>
                    </div>
                    <div class="strategy-card" onclick="openModal('strategy18')">
                        <div class="strategy-header"><div class="strategy-name">90 дней</div><div class="strategy-rate">18%</div></div>
                        <div class="strategy-description">Заморозка 90 дней. Досрочный вывод — теряются проценты.</div>
                        <div class="strategy-features"><span class="feature-tag">Заморозка на 90 дней</span><span class="feature-tag">Займы</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="pagePortfolio"><div class="card"><h2 style="margin-bottom: 16px;">Мой портфель</h2><div id="portfolio-list"></div><p id="portfolio-placeholder" style="text-align: center; padding: 40px 0;">Нет активных инвестиций.</p></div></div>
        <div class="page" id="pageHistory"><div class="card"><h2 style="margin-bottom: 16px;">История операций</h2><div class="filter-chips"><div class="filter-chip active" onclick="applyHistoryFilter(this, 'all')">Все</div><div class="filter-chip" onclick="applyHistoryFilter(this, 'deposit')">Депозит</div><div class="filter-chip" onclick="applyHistoryFilter(this, 'withdraw')">Вывод</div><div class="filter-chip" onclick="applyHistoryFilter(this, 'invest')">Инвестиции</div></div><div id="history-list"></div><p id="history-placeholder" style="text-align: center; padding: 40px 0;">История операций пуста.</p></div></div>
    </div>

    <div class="bottom-nav"><div class="nav-items"><div class="nav-item active" onclick="openPage('Home')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg><span class="nav-label">Главная</span></div><div class="nav-item" onclick="openPage('Portfolio')"><svg class="nav-icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="nav-label">Портфель</span></div><div class="nav-item" onclick="openPage('History')"><svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg><span class="nav-label">История</span></div></div></div>
  </div>

  <div class="modal-overlay" id="modalProfile">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title">Профиль</h2><button class="close-btn" onclick="closeModal('profile')">✕</button></div>
      <div class="card" style="text-align: center; margin: 0;"><h3 id="profileUsername">—</h3><p style="color: var(--text-secondary); font-size: 14px;">Telegram пользователь</p></div>
      <div style="margin-top: 16px;">
          <div class="method-card disabled"><div class="method-info"><h3>Безопасность <span class="dev-notice">В разработке</span></h3><p>KYC, Пин-код, Подтверждение вывода</p></div></div>
          <div class="method-card disabled"><div class="method-info"><h3>Язык <span class="dev-notice">В разработке</span></h3><p>Русский, English</p></div></div>
          <div class="method-card" onclick="window.open('https://docs.google.com/document/d/1Rv3N2iTgwHXhTkSgv-BwKLrekVpZtoGfU_ct2lDw00g/edit?usp=sharing', '_blank')"><div class="method-info"><h3>Юридическая информация</h3><p>Условия использования</p></div></div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="modalDeposit">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title">Депозит</h2><button class="close-btn" onclick="closeModal('deposit')">✕</button></div>
      <div class="method-card disabled"><div class="method-info"><h3>Криптовалюта <span class="dev-notice">В разработке</span></h3></div></div>
      <div class="method-card disabled"><div class="method-info"><h3>Банковская карта <span class="dev-notice">В разработке</span></h3></div></div>
      <div class="method-card" onclick="document.getElementById('p2p-details').style.display='block'">
          <div class="method-info"><h3>Перевод по СБП</h3><p>На номер +7 916 643 54 94</p></div>
      </div>
      <div id="p2p-details" style="display:none; margin-top: 20px;">
          <input type="text" id="depositAmount" class="amount-input" placeholder="0" oninput="this.value = this.value.replace(/[^\d]/g, '')">
          <div class="quick-amounts">
              <button class="quick-amount-btn" onclick="setDepositAmount(1000)">1 000</button>
              <button class="quick-amount-btn" onclick="setDepositAmount(5000)">5 000</button>
              <button class="quick-amount-btn" onclick="setDepositAmount(10000)">10 000</button>
          </div>
          <div class="input-with-copy" style="margin-top: 12px;">
              <input type="text" class="input-field" value="+79166435494" readonly>
              <button class="copy-btn" onclick="copyToClipboard('+79166435494')">Копировать</button>
          </div>
          <label style="display:flex; gap:8px; align-items:center; margin:16px 0;">
              <input type="checkbox" id="depositAgree"> <span>Я согласен с <a href="https://docs.google.com/document/d/1Rv3N2iTgwHXhTkSgv-BwKLrekVpZtoGfU_ct2lDw00g/edit?usp=sharing" target="_blank" style="color:var(--accent)">условиями</a></span>
          </label>
          <button class="btn btn-primary" id="depositConfirmBtn" style="width:100%" disabled>Создать запрос</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="modalWithdraw">
      <div class="modal">
          <div class="modal-header"><h2 class="modal-title">Вывод средств</h2><button class="close-btn" onclick="closeModal('withdraw')">✕</button></div>
          <p style="text-align: center; color: var(--text-secondary);">Доступно для вывода: <b id="withdrawAvailable">0.00 ₽</b></p>
          <input type="text" class="amount-input" id="withdrawAmount" placeholder="0" oninput="this.value = this.value.replace(/[^\d]/g, '')">
          <input type="text" class="input-field" style="text-align:center; margin-bottom: 16px;" placeholder="Номер телефона для СБП">
          <button class="btn btn-primary" id="withdrawConfirmBtn" style="width:100%">Создать запрос на вывод</button>
      </div>
  </div>
  
  <div class="modal-overlay" id="modalStrategy16"><div class="modal"><div class="modal-header"><h2 class="modal-title">Гибкая 16%</h2><button class="close-btn" onclick="closeModal('strategy16')">✕</button></div><button class="btn btn-primary" onclick="openNewInvestment('16')" style="width: 100%;">Инвестировать</button></div></div>
  <div class="modal-overlay" id="modalStrategy17"><div class="modal"><div class="modal-header"><h2 class="modal-title">30 дней 17%</h2><button class="close-btn" onclick="closeModal('strategy17')">✕</button></div><button class="btn btn-primary" onclick="openNewInvestment('17')" style="width: 100%;">Инвестировать</button></div></div>
  <div class="modal-overlay" id="modalStrategy18"><div class="modal"><div class="modal-header"><h2 class="modal-title">90 дней 18%</h2><button class="close-btn" onclick="closeModal('strategy18')">✕</button></div><button class="btn btn-primary" onclick="openNewInvestment('18')" style="width: 100%;">Инвестировать</button></div></div>

  <div class="modal-overlay" id="modalNewInvestment">
    <div class="modal">
      <div class="modal-header"><h2 class="modal-title">Новая инвестиция</h2><button class="close-btn" onclick="closeModal('newInvestment')">✕</button></div>
      <div class="input-field" id="niStrategyReadonly" style="text-align:center;font-weight:700;margin-bottom:12px;">—</div>
      <input type="text" class="amount-input" id="niAmount" placeholder="0" oninput="this.value = this.value.replace(/[^\d]/g, '')">
      <button class="btn btn-primary" style="width:100%" id="niConfirmBtn">Подтвердить</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIAGI3xqdLJeOGHs8cgvLbMll5x82pc7clF_HTmQBQkc-5jbONBaq27NPZuaQAfuR_oA/exec';
    
    window.username = null;
    window.serverState = { balance: 0, rate: 16, monthBase: 0, lockedAmount: 0 };
    window.lastChosenRate = null;
    window.currentCurrency = 'RUB';
    window.exchangeRates = { RUB: 1, USD: 0.011, EUR: 0.010 };
    
    const fmtMoney = (x, rate=1) => (Number(x*rate) || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    
    function showPopup(text, timeout = 3000) { /* ... implementation from previous version ... */ }
    let statusHideTimer = null;
    function setStatus(text, type = 'loading', hold = false) {
        const el = document.getElementById('status');
        if (!el) return;
        if(type === 'synced' && el.classList.contains('synced') && !hold) return; // Prevent repeated synced popups
        el.textContent = text;
        el.className = `status ${type} show`;
        if (statusHideTimer) clearTimeout(statusHideTimer);
        if (!hold) {
            statusHideTimer = setTimeout(() => el.classList.remove('show'), 2000);
        }
    }
    
    function openPage(pageId) { /* ... implementation ... */ }
    function openModal(modalId) { document.getElementById(`modal${modalId.charAt(0).toUpperCase() + modalId.slice(1)}`).classList.add('active'); }
    function closeModal(modalId) { document.getElementById(`modal${modalId.charAt(0).toUpperCase() + modalId.slice(1)}`).classList.remove('active'); }
    document.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); });

    function applyHistoryFilter(element, type) { /* ... implementation ... */ }
    function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showPopup('Скопировано!')); }
    function setDepositAmount(amount) { document.getElementById('depositAmount').value = amount; }
    
    function toggleCurrencyDropdown(event) { event.stopPropagation(); document.getElementById('currencyDropdown').classList.toggle('open'); }
    function selectCurrency(currency, event) {
        event.stopPropagation();
        window.currentCurrency = currency;
        document.getElementById('currentCurrency').textContent = currency;
        document.querySelectorAll('.currency-option').forEach(opt => opt.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('currencyDropdown').classList.remove('open');
        updateDashboard(window.serverState); // Re-render with new currency
    }

    function updateDashboard(data) {
        window.serverState = { ...window.serverState, ...data };
        const { balance, monthBase, lockedAmount } = window.serverState;
        const rate = window.exchangeRates[window.currentCurrency];

        document.getElementById('balanceValue').textContent = fmtMoney(balance, rate);
        document.getElementById('freeBalance').textContent = fmtMoney(balance - lockedAmount, rate);
        document.getElementById('investedBalance').textContent = fmtMoney(monthBase, rate);
        document.getElementById('profileUsername').textContent = window.username || 'Пользователь';
        document.getElementById('withdrawAvailable').textContent = `${fmtMoney(balance - lockedAmount, rate)} ₽`;
    }

    function renderHistory(history) { /* ... implementation from previous version ... */ }
    function renderPortfolio(portfolio) { /* ... implementation from previous version ... */ }
    
    async function apiGet(path) { /* ... implementation ... */ }
    
    async function initializeApp() {
        try {
            const tg = window.Telegram?.WebApp;
            tg?.expand?.();
            window.username = (tg?.initDataUnsafe?.user?.username) || 'marulin';
            
            setStatus('Загрузка данных...', 'loading', true);
            
            const data = await apiGet(`?action=getInitialData&username=${window.username}`);
            if (!data.success) throw new Error(data.error || 'Failed to get initial data');
            
            updateDashboard(data);
            renderHistory(data.history);
            renderPortfolio(data.portfolio);
            await refreshTodayIncome(true);
            
            setStatus('Синхронизировано', 'synced', true); // First sync is special
            
            setInterval(syncBalance, 20000);
            setInterval(() => refreshTodayIncome(false), 60000);
            
        } catch (e) {
            console.error('Initialization error:', e);
            setStatus('Ошибка подключения', 'error', true);
        }
    }

    async function syncBalance() {
      try {
        const data = await apiGet(`?action=syncBalance&username=${window.username}`);
        if (data.success) updateDashboard(data);
      } catch (error) { /* silent fail */ }
    }

    async function refreshTodayIncome(isInitial) {
        try {
            const res = await apiGet(`?action=previewAccrual&username=${window.username}`);
            if (!res.success) return;

            const todayKey = `accrual_start_${window.username}_${new Date().toLocaleDateString('en-CA')}`;
            let startOfDayAccrued = localStorage.getItem(todayKey);
            
            // On initial load, always reset the start-of-day value from server data
            if (isInitial || startOfDayAccrued === null) {
                const totalAccruedSoFar = res.accruedToNow || 0;
                const accruedToday = res.accruedToday || 0;
                startOfDayAccrued = totalAccruedSoFar - accruedToday;
                localStorage.setItem(todayKey, startOfDayAccrued);
            }

            const todayIncome = Math.max(0, (res.accruedToNow || 0) - Number(startOfDayAccrued));
            document.getElementById('todayIncome').textContent = `+${fmtMoney(todayIncome, window.exchangeRates[window.currentCurrency])}`;
        } catch (e) { /* silent fail */ }
    }
    
    // Event listeners for deposit/withdraw/invest
    document.getElementById('depositAgree').addEventListener('change', function() {
        document.getElementById('depositConfirmBtn').disabled = !this.checked;
    });
    
    document.getElementById('depositConfirmBtn').addEventListener('click', async function() {
        const amount = parseInt(document.getElementById('depositAmount').value) || 0;
        if (amount <= 0) { showPopup('Введите сумму.'); return; }
        this.disabled = true;
        try {
            const resp = await apiGet(`?action=requestDeposit&username=${window.username}&amount=${amount}`);
            if(resp.success) { showPopup('Запрос на депозит отправлен!'); closeModal('deposit'); } 
            else { showPopup('Ошибка: ' + (resp.error || 'неизвестно')); }
        } catch(e) { showPopup('Сетевая ошибка.'); } finally { this.disabled = false; }
    });

    document.getElementById('withdrawConfirmBtn').addEventListener('click', async function() {
        const amount = parseInt(document.getElementById('withdrawAmount').value) || 0;
        if (amount <= 0) { showPopup('Введите сумму.'); return; }
        this.disabled = true;
        try {
            const resp = await apiGet(`?action=requestWithdraw&username=${window.username}&amount=${amount}`);
            if(resp.success) { showPopup('Запрос на вывод отправлен!'); closeModal('withdraw'); }
            else { showPopup('Ошибка: ' + (resp.error || 'неизвестно')); }
        } catch(e) { showPopup('Сетевая ошибка.'); } finally { this.disabled = false; }
    });
    
    document.getElementById('niConfirmBtn').addEventListener('click', async function() {
        const amount = parseInt(document.getElementById('niAmount').value) || 0;
        const rate = window.lastChosenRate;
        if (!rate || amount <= 0) { showPopup('Введите корректную сумму.'); return; }
        this.disabled = true;
        try {
            const resp = await apiGet(`?action=logStrategyInvestment&username=${window.username}&rate=${rate}&amount=${amount}`);
            if (resp.success) {
                showPopup('Инвестиция создана!');
                closeModal('newInvestment');
                initializeApp(); // Reload all data
            } else {
                showPopup('Ошибка: ' + (resp.error || 'неизвестно'));
            }
        } catch (e) { showPopup('Ошибка сети'); } finally { this.disabled = false; }
    });

    initializeApp();
  </script>
</body>
</html>
