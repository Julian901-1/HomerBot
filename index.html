<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Homer Invest — MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* подставь сюда цвета из документа */
      --bg: #0c0f13;
      --panel: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.12);
      --fg: #e9ecf1;
      --muted: rgba(233,236,241,.72);
      --accent: #4c8bf5;          /* акцент по умолчанию — замени на свой */
      --ok: #00c389;
      --warn: #ffb531;
      --danger:#ff5d5d;
      --glass: rgba(255,255,255,.06);
      --shadow: 0 12px 36px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Manrope, system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--fg);
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    /* ===== Layout ===== */
    .app{
      max-width: 460px;   /* компактно, без длинных полотен */
      margin: 0 auto;
      padding-bottom: 88px; /* место под нижнюю навигацию */
      min-height: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    /* ===== Top bar ===== */
    .topbar{
      position: sticky; top: 0; z-index: 10;
      padding: 14px 16px 8px;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(to bottom, rgba(12,15,19,.85) 70%, rgba(12,15,19,0));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--line);
    }
    .brand{ font-weight: 800; letter-spacing:.2px; }
    .pill{
      padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background: var(--panel); font-weight:700; font-size:12px; opacity:.85;
    }

    /* ===== Pages ===== */
    .page{ display:none; padding:16px; }
    .page.active{ display:block; }

    /* ===== Cards / Blocks ===== */
    .card{
      background: var(--glass);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* ===== Balance hero ===== */
    .hello{ font-size: 22px; font-weight:800; margin: 2px 0 10px; }
    .muted{ color: var(--muted); }
    .balance{
      font-variant-numeric: tabular-nums;
      font-size: 40px; font-weight: 800; letter-spacing: .3px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      padding: 12px 14px; border-radius: 14px; border: 1px solid var(--line);
      background: transparent; color: var(--fg); font-weight: 800; cursor: pointer;
    }
    .btn:disabled{ opacity:.6; cursor: default; }
    .btn-primary{ background: var(--accent); color:#fff; border:0; }
    .btn-ghost{ border-style: dashed; }

    /* ===== Strategy mini-cards (сжатые) ===== */
    .miniGrid{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
    .miniCard{
      padding: 12px; border-radius: 14px; border: 1px solid var(--line);
      background: var(--panel); text-align:center;
    }
    .apr{ font-weight:800; font-size:16px; }
    .tag{ font-size:11px; opacity:.9; border:1px solid var(--line); border-radius:999px; padding:3px 8px; display:inline-block; margin-top:6px; }

    /* ===== Status ===== */
    .status{ margin-top:10px; display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:var(--panel); font-weight:700; font-size:12px; }

    /* ===== Bottom nav (icons only) ===== */
    .nav{
      position: fixed; left:50%; transform: translateX(-50%);
      bottom: 14px; width: min(460px, 92vw);
      background: rgba(20,22,27,.85);
      backdrop-filter: blur(10px) saturate(140%);
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 10px;
      display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
    }
    .nav-btn{
      height: 56px; border-radius:14px; border:1px solid transparent;
      display:grid; place-items:center; cursor:pointer;
      color: var(--muted);
    }
    .nav-btn.active{ color: var(--fg); border-color: var(--line); background: var(--panel); }
    .nav-btn svg{ width: 26px; height: 26px; }

    /* ===== Back + sections ===== */
    .back{ display:inline-flex; gap:6px; align-items:center; margin:2px 0 10px; opacity:.85; font-weight:700; cursor:pointer; }
    .section{ display:grid; gap:10px; }

    /* ===== Popup ===== */
    .popup{
      position: fixed; left:50%; bottom: 90px; transform: translateX(-50%);
      background: rgba(20,20,22,.96); color:#fff; padding: 12px 14px; border-radius: 12px;
      font-size: 14px; z-index: 9999; max-width: 92vw; text-align:center; box-shadow: var(--shadow);
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- topbar -->
    <header class="topbar">
      <div class="brand">Homer&nbsp;Invest</div>
      <div class="pill" id="syncPill">Подключение…</div>
    </header>

    <!-- pages -->
    <main>
      <!-- HOME (компактный, без длинного скролла) -->
      <section id="page-home" class="page active">
        <div class="card">
          <div class="hello" id="hello">Добрый день, пользователь</div>
          <div class="muted" id="helloSub">МСК</div>

          <div style="height:8px"></div>
          <div class="balance" id="balanceValue">—</div>
          <div class="muted">Ставка: <b id="rateText">—%</b></div>

          <div style="height:12px"></div>
          <div class="split">
            <button class="btn btn-primary" id="goDeposit">Депозит</button>
            <button class="btn" id="goWithdraw">Вывод</button>
          </div>

          <div style="height:10px"></div>
          <div class="miniGrid">
            <div class="miniCard">
              <div class="apr">16%</div>
              <div class="tag">Гибкая</div>
            </div>
            <div class="miniCard">
              <div class="apr">17%</div>
              <div class="tag">30 дней</div>
            </div>
            <div class="miniCard">
              <div class="apr">18%</div>
              <div class="tag">90 дней</div>
            </div>
          </div>

          <div class="status" id="status">Готово</div>
        </div>
      </section>

      <!-- STRATEGY (детали, укорочено) -->
      <section id="page-strategy" class="page">
        <div class="back" data-nav="home">← Назад</div>
        <div class="section">
          <div class="card">
            <div class="split">
              <div><div class="muted">Стратегия</div><div style="font-weight:800" id="strTitle">Гибкая 16%</div></div>
              <div><div class="muted">Автопролонгация</div><label><input type="checkbox" id="autoRoll"/> Вкл</label></div>
            </div>
            <div style="height:8px"></div>
            <div class="muted">
              Начисление ежесекундно, капитализация ежемесячно. Досрочный вывод — без штрафа (для гибкой).
            </div>
            <div style="height:10px"></div>
            <div class="split">
              <button class="btn btn-primary" data-dev="todo">Инвестировать</button>
              <button class="btn btn-ghost" id="explainBtn">Как считается доход</button>
            </div>
          </div>
        </div>
      </section>

      <!-- DEPOSIT (короткий мастер) -->
      <section id="page-deposit" class="page">
        <div class="back" data-nav="home">← Назад</div>
        <div class="section">
          <div class="card">
            <div class="muted">Сумма</div>
            <div class="split">
              <button class="btn" data-quick="100000">+100 000</button>
              <button class="btn" data-quick="300000">+300 000</button>
            </div>
            <div style="height:10px"></div>
            <button class="btn btn-primary" id="depositConfirm">Отправить запрос</button>
          </div>
        </div>
      </section>

      <!-- WITHDRAW -->
      <section id="page-withdraw" class="page">
        <div class="back" data-nav="home">← Назад</div>
        <div class="section">
          <div class="card">
            <div class="muted">Сумма</div>
            <div class="split">
              <button class="btn" data-quick-w="100000">−100 000</button>
              <button class="btn" data-quick-w="300000">−300 000</button>
            </div>
            <div style="height:10px"></div>
            <button class="btn" id="withdrawConfirm">Отправить запрос</button>
          </div>
        </div>
      </section>

      <!-- HISTORY (mock, компакт) -->
      <section id="page-history" class="page">
        <div class="back" data-nav="home">← Назад</div>
        <div class="section">
          <div class="card"><b>Депозит</b> · 100 000 · #a1b2 · <span class="muted">15.09</span></div>
          <div class="card"><b>Начисление</b> · 1 233 · #c3d4 · <span class="muted">01.10</span></div>
          <div class="card"><b>Вывод</b> · 50 000 · #e5f6 · <span class="muted">02.10</span></div>
        </div>
      </section>

      <!-- INFO (заглушка) -->
      <section id="page-info" class="page">
        <div class="back" data-nav="home">← Назад</div>
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px">Как считаются проценты</div>
          <div class="muted">Скоро здесь появятся формулы, примеры и пояснения. Раздел в разработке.</div>
        </div>
      </section>
    </main>
  </div>

  <!-- bottom navigation (icons only) -->
  <nav class="nav" id="nav">
    <button class="nav-btn active" data-nav="home" title="Главная" aria-label="Главная">
      <!-- home icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 11l9-7 9 7"/><path d="M9 22V12h6v10"/></svg>
    </button>
    <button class="nav-btn" data-nav="strategy" title="Стратегия" aria-label="Стратегия">
      <!-- target icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="7"/><circle cx="12" cy="12" r="3"/></svg>
    </button>
    <button class="nav-btn" data-nav="history" title="История" aria-label="История">
      <!-- list icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 6h13"/><path d="M8 12h13"/><path d="M8 18h13"/><circle cx="4" cy="6" r="1.5"/><circle cx="4" cy="12" r="1.5"/><circle cx="4" cy="18" r="1.5"/></svg>
    </button>
    <button class="nav-btn" data-nav="info" title="Инфо" aria-label="Инфо">
      <!-- info icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/><path d="M12 8h.01"/><path d="M11 12h2v6h-2z"/></svg>
    </button>
  </nav>

  <script>
    const SCRIPT_URL = (window.scriptUrl || (window.SCRIPT_URL ?? 'https://script.google.com/macros/s/REPLACE_ME/exec'));

    // ---- state ----
    window.username = null;
    window.serverBalance = 0;
    window.currentRate = 16;
    window.pendingRequest = false;

    // ---- helpers ----
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function showPopup(text, ms=2000){
      const el = document.createElement('div'); el.className='popup'; el.textContent=text; document.body.appendChild(el);
      setTimeout(()=>{ el.style.transition='opacity .25s'; el.style.opacity='0'; setTimeout(()=>el.remove(),260); }, ms);
    }
    function fmtMoney(x){ return (Number(x)||0).toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2}); }

    function setGreeting(){
      try{
        const user = (Telegram.WebApp?.initDataUnsafe?.user?.first_name) || (Telegram.WebApp?.initDataUnsafe?.user?.username) || 'пользователь';
        const nowMsk = new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Moscow'}));
        const h = nowMsk.getHours();
        let hello='Добрый день'; if (h>=22 || h<6) hello='Доброй ночи'; else if (h>=17) hello='Добрый вечер';
        $('#hello').textContent = `${hello}, ${user}`;
        $('#helloSub').textContent = 'МСК';
      }catch{}
    }

    // ---- navigation ----
    function openPage(id){
      $$('.page').forEach(p=>p.classList.remove('active'));
      $('#page-'+id).classList.add('active');
      $$('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.nav===id));
    }
    $('#nav').addEventListener('click', (e)=>{
      const btn = e.target.closest('.nav-btn'); if (!btn) return;
      openPage(btn.dataset.nav);
    });
    $$('#goDeposit').forEach ? 0 : null; // no-op (keep tree-shake calm)
    $('#goDeposit')?.addEventListener('click', ()=> openPage('deposit'));
    $('#goWithdraw')?.addEventListener('click', ()=> openPage('withdraw'));
    $$('.back').forEach(b=> b.addEventListener('click', ()=> openPage(b.dataset.nav || 'home')));

    // ---- placeholders ----
    $$('#explainBtn, [data-dev="todo"]').forEach(b=> b.addEventListener('click', ()=> showPopup('Функция в разработке')));
    $$('[data-quick]').forEach(b=> b.addEventListener('click', ()=> showPopup('Сумма выбрана: '+Number(b.dataset.quick).toLocaleString('ru-RU'))));
    $$('[data-quick-w]').forEach(b=> b.addEventListener('click', ()=> showPopup('Сумма выбрана: −'+Number(b.dataset.quickW).toLocaleString('ru-RU'))));
    $('#depositConfirm')?.addEventListener('click', ()=> showPopup('Запрос на депозит отправлен (заглушка)'));
    $('#withdrawConfirm')?.addEventListener('click', ()=> showPopup('Запрос на вывод отправлен (заглушка)'));

    // ---- server sync (только чтение; расчёты на сервере) ----
    async function apiGet(path){ const r = await fetch(`${SCRIPT_URL}${path}`); return r.json(); }
    async function initialLoad(){
      try{
        Telegram?.WebApp?.expand?.();
        window.username = (Telegram.WebApp?.initDataUnsafe?.user?.username) || 'user';
        setGreeting();
        $('#syncPill').textContent = 'Подключение…';

        const data = await apiGet(`?action=getBalance&username=${window.username}`);
        if (!data.success) throw new Error(data.error || 'getBalance failed');

        window.serverBalance = Number(data.balance) || 0;
        window.currentRate = Number(data.rate) || 16;
        $('#balanceValue').textContent = fmtMoney(window.serverBalance);
        $('#rateText').textContent = `${window.currentRate}%`;

        // сразу синк, чтобы сервер доначислил проценты «по сейчас»
        const sync = await apiGet(`?action=syncBalance&username=${window.username}&balance=${encodeURIComponent(window.serverBalance)}&rate=${encodeURIComponent(window.currentRate)}&timestamp=${Date.now()}`);
        if (sync.success && typeof sync.balance === 'number') {
          window.serverBalance = Number(sync.balance);
          $('#balanceValue').textContent = fmtMoney(window.serverBalance);
        }

        $('#syncPill').textContent = 'Синхронизировано';
      }catch(e){
        console.error(e);
        $('#syncPill').textContent = 'Ошибка';
        showPopup('Не удалось загрузить данные');
      }
    }
    initialLoad();
  </script>
</body>
</html>
