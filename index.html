<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ö–æ—à–µ–ª—ë–∫</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    .balance-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 20px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #balanceDisplay {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
    }
    #balanceDisplay::after {
      content: " ‚úß";
    }
    button {
      background-color: var(--tg-theme-button-color, #0088cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      opacity: 0.9;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .info { background-color: #cce5ff; color: #004085; }
    input[type="number"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="balance-container">
      <div>–í–∞—à –±–∞–ª–∞–Ω—Å</div>
      <div id="balanceDisplay">0.00</div>
    </div>

    <button id="syncBtn">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
    <button id="depositBtn">üì• –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
    <button id="withdrawBtn">üì§ –í—ã–≤–µ—Å—Ç–∏</button>

    <!-- Deposit Section -->
    <div id="depositSection" class="hidden">
      <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
      <input type="number" id="depositAmount" placeholder="–°—É–º–º–∞" min="100">
      <button id="generateDepositBtn">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      <button onclick="toggleSection('depositSection')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- Withdraw Section -->
    <div id="withdrawSection" class="hidden">
      <h3>–í—ã–≤–æ–¥</h3>
      <input type="number" id="withdrawAmount" placeholder="–°—É–º–º–∞" min="100">
      <input type="text" id="withdrawPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
      <button id="processWithdrawBtn">–í—ã–≤–µ—Å—Ç–∏</button>
      <button onclick="toggleSection('withdrawSection')">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="status" class="hidden"></div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzIAGI3xqdLJeOGHs8cgvLbMll5x82pc7clF_HTmQBQkc-5jbONBaq27NPZuaQAfuR_oA/exec'; // <-- –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL
    let currentBalance = 0;
    let tg = window.Telegram?.WebApp;

    if (tg) {
      tg.ready();
      tg.expand();
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = type;
      statusEl.classList.remove('hidden');
      setTimeout(() => statusEl.classList.add('hidden'), 5000);
    }

    function updateBalanceDisplay() {
      document.getElementById('balanceDisplay').textContent = currentBalance.toFixed(2);
    }

    function getUserName() {
      if (tg?.initDataUnsafe?.user) {
        const user = tg.initDataUnsafe.user;
        return user.username ? `@${user.username}` : `user_${user.id}`;
      }
      return '@test_user';
    }

    function jsonpRequest(url, callbackName, successCallback, errorCallback) {
      let script = document.createElement('script');
      let timeoutId;

      const cleanup = () => {
        clearTimeout(timeoutId);
        if (window[callbackName]) delete window[callbackName];
        if (script.parentNode) script.parentNode.removeChild(script);
      };

      timeoutId = setTimeout(() => {
        cleanup();
        console.error('JSONP Timeout:', url);
        if (errorCallback) errorCallback('Request timeout');
      }, 10000);

      window[callbackName] = (data) => {
        cleanup();
        console.log('JSONP Success:', data);
        if (successCallback) successCallback(data);
      };

      script.onerror = (err) => {
        cleanup();
        console.error('JSONP Error:', err);
        if (errorCallback) errorCallback('Script load error');
      };

      script.src = url;
      document.head.appendChild(script);
    }

    function syncBalance() {
      const username = getUserName();
      if (username === '@test_user') {
        showStatus('–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞.', 'info');
        return;
      }

      const callbackName = 'sync_cb_' + Date.now() + Math.floor(Math.random() * 10000);
      const url = `${GAS_URL}?action=getBalance&username=${encodeURIComponent(username)}&callback=${callbackName}&t=${Date.now()}`;

      jsonpRequest(url, callbackName,
        (data) => {
          if (data?.success) {
            currentBalance = parseFloat(data.balance) || 0;
            updateBalanceDisplay();
            showStatus('‚úÖ –ë–∞–ª–∞–Ω—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω!', 'success');
          } else {
            showStatus(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ${data?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
          }
        },
        (error) => {
          showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error}`, 'error');
        }
      );
    }

    function generateDeposit() {
      const amount = parseFloat(document.getElementById('depositAmount').value);
      if (!amount || amount < 100) {
        showStatus('‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ 100', 'error');
        return;
      }
      const username = getUserName();
      const transactionId = 'TX_' + Date.now();
      const callbackName = 'dep_cb_' + Date.now() + Math.floor(Math.random() * 10000);
      const message = `üí∞ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}\n–°—É–º–º–∞: ${amount}\nID: ${transactionId}`;
      
      const url = `${GAS_URL}?action=sendNotification&type=deposit&userId=${encodeURIComponent(username)}&amount=${amount}&transactionId=${transactionId}&message=${encodeURIComponent(message)}&callback=${callbackName}&t=${Date.now()}`;

      jsonpRequest(url, callbackName,
        (data) => {
          if (data?.success) {
            showStatus('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.', 'success');
            document.getElementById('depositAmount').value = '';
            toggleSection('depositSection');
          } else {
            showStatus(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'}`, 'error');
          }
        },
        (error) => {
          showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error}`, 'error');
        }
      );
    }

    function processWithdrawal() {
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      const phone = document.getElementById('withdrawPhone').value.trim();
      if (!amount || amount < 100) {
        showStatus('‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ 100', 'error');
        return;
      }
      if (amount > currentBalance) {
        showStatus('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'error');
        return;
      }
      if (!phone) {
        showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
        return;
      }
      const username = getUserName();
      const commission = amount * 0.05;
      const finalAmount = amount - commission;
      const callbackName = 'wd_cb_' + Date.now() + Math.floor(Math.random() * 10000);
      const message = `üì§ –í—ã–≤–æ–¥\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${username}\n–°—É–º–º–∞: ${amount}\n–ö–æ–º–∏—Å—Å–∏—è: ${commission.toFixed(2)}\n–ö –ø–æ–ª—É—á–µ–Ω–∏—é: ${finalAmount.toFixed(2)}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}`;
      
      const url = `${GAS_URL}?action=sendNotification&type=withdraw&userId=${encodeURIComponent(username)}&amount=${amount}&phone=${encodeURIComponent(phone)}&commission=${commission}&finalAmount=${finalAmount}&message=${encodeURIComponent(message)}&callback=${callbackName}&t=${Date.now()}`;

      jsonpRequest(url, callbackName,
        (data) => {
          if (data?.success) {
            currentBalance -= amount; // –°–Ω–∏–º–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
            updateBalanceDisplay();
            showStatus('‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawPhone').value = '';
            toggleSection('withdrawSection');
          } else {
            showStatus(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É'}`, 'error');
          }
        },
        (error) => {
          showStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error}`, 'error');
        }
      );
    }

    function toggleSection(sectionId) {
      document.getElementById('depositSection').classList.add('hidden');
      document.getElementById('withdrawSection').classList.add('hidden');
      if (sectionId) {
        document.getElementById(sectionId).classList.remove('hidden');
      }
    }

    document.getElementById('syncBtn').addEventListener('click', syncBalance);
    document.getElementById('depositBtn').addEventListener('click', () => toggleSection('depositSection'));
    document.getElementById('withdrawBtn').addEventListener('click', () => toggleSection('withdrawSection'));
    document.getElementById('generateDepositBtn').addEventListener('click', generateDeposit);
    document.getElementById('processWithdrawBtn').addEventListener('click', processWithdrawal);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    updateBalanceDisplay();
    syncBalance(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
  </script>
</body>
</html>
